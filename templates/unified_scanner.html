{% extends "layout.html" %}
{% block title %}Ultra-Fast Universal Scanner{% endblock %}

{% block head %}
<style>
/* Ultra-Fast Scanner Styles */
.scanner-container {
    position: relative;
    width: 100%;
    height: 450px;
    background-color: #000;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

#qr-reader {
    width: 100%;
    height: 100%;
}

.scanner-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    display: flex;
    align-items: center;
    justify-content: center;
}

.scan-region {
    width: 250px;
    height: 250px;
    border: 3px solid #4CAF50;
    border-radius: 20px;
    position: relative;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
    70% { box-shadow: 0 0 0 20px rgba(76, 175, 80, 0); }
    100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
}

.scan-line {
    position: absolute;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #4CAF50, transparent);
    animation: scan 2s linear infinite;
}

@keyframes scan {
    0% { top: 0; }
    100% { top: 100%; }
}

.mode-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.mode-btn {
    flex: 1;
    padding: 12px;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.mode-btn.active {
    background: #4CAF50;
    color: white;
    border-color: #4CAF50;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.mode-btn:hover:not(.active) {
    background: #f8f9fa;
    transform: translateY(-1px);
}

.scan-result {
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.scan-result.success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.scan-result.error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.scan-result.warning {
    background: #fff3cd;
    border: 1px solid #ffeeba;
    color: #856404;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.recent-scans {
    max-height: 400px;
    overflow-y: auto;
}

.scan-item {
    padding: 12px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.2s;
}

.scan-item:hover {
    background: #f8f9fa;
}

.scan-item .qr-code {
    font-weight: bold;
    font-family: monospace;
    font-size: 1.1rem;
}

.scan-item .timestamp {
    color: #6c757d;
    font-size: 0.85rem;
}

@media (max-width: 768px) {
    .scanner-container {
        height: 350px;
    }
    
    .mode-selector {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-4">
                <i class="fas fa-bolt text-warning"></i>
                Ultra-Fast Universal Scanner
            </h1>
        </div>
    </div>

    <div class="row">
        <!-- Scanner Column -->
        <div class="col-lg-7 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-qrcode me-2"></i>QR Scanner
                        <span id="mode-indicator" class="badge bg-success float-end">Ready</span>
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Mode Selector -->
                    <div class="mode-selector">
                        <button class="mode-btn active" data-mode="parent" onclick="switchMode('parent')">
                            <i class="fas fa-box fa-2x mb-2"></i><br>
                            Scan Parent Bag
                        </button>
                        <button class="mode-btn" data-mode="child" onclick="switchMode('child')">
                            <i class="fas fa-cube fa-2x mb-2"></i><br>
                            Scan Child Bags
                        </button>
                        <button class="mode-btn" data-mode="bill" onclick="switchMode('bill')">
                            <i class="fas fa-file-invoice fa-2x mb-2"></i><br>
                            Scan for Bill
                        </button>
                    </div>

                    <!-- Scanner Container -->
                    <div class="scanner-container">
                        <div id="qr-reader"></div>
                        <div class="scanner-overlay">
                            <div class="scan-region">
                                <div class="scan-line"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Current Session Info -->
                    <div id="session-info" class="alert alert-info mt-3" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="session-text"></span>
                    </div>

                    <!-- Scan Result -->
                    <div id="scan-result" style="display: none;"></div>

                    <!-- Manual Entry -->
                    <div class="mt-3">
                        <div class="input-group">
                            <input type="text" id="manual-input" class="form-control" placeholder="Enter QR code manually...">
                            <button class="btn btn-primary" onclick="manualScan()">
                                <i class="fas fa-keyboard me-1"></i>Submit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Column -->
        <div class="col-lg-5 mb-4">
            <!-- Statistics -->
            <div class="card shadow mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Live Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-scans">0</div>
                            <div class="stat-label">Total Scans</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="stat-value" id="parent-count">0</div>
                            <div class="stat-label">Parent Bags</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <div class="stat-value" id="child-count">0</div>
                            <div class="stat-label">Child Bags</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <div class="stat-value" id="speed-ms">0ms</div>
                            <div class="stat-label">Scan Speed</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Scans -->
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Scans
                    </h5>
                </div>
                <div class="card-body">
                    <div id="recent-scans" class="recent-scans">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-inbox fa-3x mb-2"></i>
                            <p>No scans yet. Start scanning!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="scan-toast" class="toast align-items-center border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toast-message">Message</div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/jsQR.js') }}"></script>
<script src="{{ url_for('static', filename='js/instant-detection-scanner.js') }}"></script>

<script>
// Global variables
let scanner = null;
let currentMode = 'parent';
let parentBagId = null;
let billId = null;
let scannedItems = new Set();
let scanStartTime = null;
let totalScans = 0;

// Initialize on page load
window.addEventListener('load', function() {
    console.log('Initializing Universal Scanner...');
    initUniversalScanner();
});

// Initialize scanner
async function initUniversalScanner() {
    try {
        if (typeof InstantDetectionScanner === 'undefined') {
            console.error('Scanner library not loaded');
            showToast('Scanner library failed to load', 'danger');
            return;
        }
        
        scanner = new InstantDetectionScanner('qr-reader');
        scanner.onScan = handleScan;
        scanner.onSuccess = handleScan;
        
        document.getElementById('mode-indicator').textContent = 'Active';
        showToast('📷 Scanner ready! Point at any QR code', 'success');
        
    } catch (error) {
        console.error('Scanner init error:', error);
        showToast('Camera error: ' + error.message, 'danger');
    }
}

// Handle scan
async function handleScan(qrCode) {
    scanStartTime = performance.now();
    
    // Auto-pause visual feedback
    showScanPause(qrCode);
    
    // Check for duplicate
    if (scannedItems.has(qrCode)) {
        showToast('Already scanned: ' + qrCode, 'warning');
        resumeScanning();
        return;
    }
    
    try {
        let endpoint = '';
        let body = new URLSearchParams();
        
        switch(currentMode) {
            case 'parent':
                endpoint = '/fast/parent_scan';
                body.append('qr_code', qrCode);
                break;
                
            case 'child':
                if (!parentBagId) {
                    showToast('Please scan a parent bag first', 'warning');
                    resumeScanning();
                    return;
                }
                endpoint = '/fast/child_scan';
                body.append('qr_code', qrCode);
                break;
                
            case 'bill':
                if (!billId) {
                    // Show bill selector
                    await selectBill();
                    if (!billId) {
                        resumeScanning();
                        return;
                    }
                }
                endpoint = '/fast/bill_parent_scan';
                body.append('bill_id', billId);
                body.append('qr_code', qrCode);
                break;
        }
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: body
        });
        
        const data = await response.json();
        const scanTime = Math.round(performance.now() - scanStartTime);
        
        if (data.success) {
            scannedItems.add(qrCode);
            totalScans++;
            showSuccess(qrCode, data.message, scanTime);
            updateStats(scanTime);
            addToRecentScans(qrCode, currentMode);
            
            // Handle mode-specific success
            if (currentMode === 'parent' && data.parent_id) {
                parentBagId = data.parent_id;
                updateSessionInfo(`Parent: ${qrCode}`);
                // Auto-switch to child mode
                setTimeout(() => switchMode('child'), 1500);
            } else if (currentMode === 'child' && data.completed) {
                showToast('✅ Parent bag completed with 30 children!', 'success', 5000);
                // Reset for new parent
                setTimeout(() => {
                    parentBagId = null;
                    switchMode('parent');
                }, 3000);
            }
        } else {
            showError(data.message);
        }
        
    } catch (error) {
        console.error('Scan error:', error);
        showError('Network error: ' + error.message);
    }
    
    resumeScanning();
}

// Show scan pause overlay
function showScanPause(qrCode) {
    const overlay = document.createElement('div');
    overlay.id = 'pause-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(76, 175, 80, 0.95);
        color: white;
        padding: 30px;
        border-radius: 15px;
        z-index: 10000;
        text-align: center;
        animation: fadeIn 0.3s;
    `;
    overlay.innerHTML = `
        <i class="fas fa-pause-circle fa-4x mb-3"></i>
        <h3>Processing</h3>
        <h4>${qrCode}</h4>
        <div class="spinner-border mt-3" role="status"></div>
    `;
    document.body.appendChild(overlay);
}

// Resume scanning
function resumeScanning() {
    const overlay = document.getElementById('pause-overlay');
    if (overlay) {
        overlay.remove();
    }
    if (scanner && scanner.resumeScanning) {
        setTimeout(() => {
            scanner.resumeScanning();
            showToast('▶️ Scanner ready', 'info', 1000);
        }, 1500);
    }
}

// Switch mode
function switchMode(mode) {
    currentMode = mode;
    
    // Update UI
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
    });
    
    // Update session info
    switch(mode) {
        case 'parent':
            updateSessionInfo('Ready to scan parent bags');
            break;
        case 'child':
            if (parentBagId) {
                updateSessionInfo('Scanning children for current parent');
            } else {
                updateSessionInfo('Please scan a parent bag first');
            }
            break;
        case 'bill':
            if (billId) {
                updateSessionInfo(`Adding bags to Bill #${billId}`);
            } else {
                updateSessionInfo('Select a bill to continue');
            }
            break;
    }
    
    showToast(`Switched to ${mode} mode`, 'info');
}

// Update session info
function updateSessionInfo(text) {
    const info = document.getElementById('session-info');
    const infoText = document.getElementById('session-text');
    if (info && infoText) {
        infoText.textContent = text;
        info.style.display = 'block';
    }
}

// Show success
function showSuccess(qrCode, message, time) {
    const result = document.getElementById('scan-result');
    result.className = 'scan-result success';
    result.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        <strong>${qrCode}</strong> - ${message}
        <span class="float-end">${time}ms</span>
    `;
    result.style.display = 'block';
    showToast('✅ ' + message, 'success', 2000);
}

// Show error
function showError(message) {
    const result = document.getElementById('scan-result');
    result.className = 'scan-result error';
    result.innerHTML = `
        <i class="fas fa-times-circle me-2"></i>
        ${message}
    `;
    result.style.display = 'block';
    showToast('❌ ' + message, 'danger', 3000);
}

// Update statistics
function updateStats(scanTime) {
    document.getElementById('total-scans').textContent = totalScans;
    document.getElementById('speed-ms').textContent = scanTime + 'ms';
    
    // Update mode-specific counts
    if (currentMode === 'parent') {
        const count = parseInt(document.getElementById('parent-count').textContent) + 1;
        document.getElementById('parent-count').textContent = count;
    } else if (currentMode === 'child') {
        const count = parseInt(document.getElementById('child-count').textContent) + 1;
        document.getElementById('child-count').textContent = count;
    }
}

// Add to recent scans
function addToRecentScans(qrCode, mode) {
    const container = document.getElementById('recent-scans');
    
    // Clear placeholder if exists
    if (container.querySelector('.text-center')) {
        container.innerHTML = '';
    }
    
    const item = document.createElement('div');
    item.className = 'scan-item';
    const now = new Date();
    item.innerHTML = `
        <div>
            <span class="qr-code">${qrCode}</span>
            <span class="badge bg-${mode === 'parent' ? 'primary' : mode === 'child' ? 'info' : 'success'} ms-2">
                ${mode}
            </span>
        </div>
        <span class="timestamp">${now.toLocaleTimeString()}</span>
    `;
    
    container.insertBefore(item, container.firstChild);
    
    // Keep only last 20 items
    while (container.children.length > 20) {
        container.removeChild(container.lastChild);
    }
}

// Manual scan
function manualScan() {
    const input = document.getElementById('manual-input');
    const qrCode = input.value.trim().toUpperCase();
    
    if (!qrCode) {
        showToast('Please enter a QR code', 'warning');
        return;
    }
    
    input.value = '';
    handleScan(qrCode);
}

// Show toast
function showToast(message, type = 'success', duration = 3000) {
    const toast = document.getElementById('scan-toast');
    const toastMessage = document.getElementById('toast-message');
    
    toast.className = `toast align-items-center border-0 bg-${type} text-white`;
    toastMessage.innerHTML = message;
    
    const bsToast = new bootstrap.Toast(toast, { delay: duration });
    bsToast.show();
}

// Select bill for bill mode
async function selectBill() {
    // For now, use prompt. In production, show a modal with bill list
    const billInput = prompt('Enter Bill ID:');
    if (billInput) {
        billId = billInput;
        updateSessionInfo(`Adding bags to Bill #${billId}`);
    }
}

// Add keyboard shortcut for manual entry
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && document.activeElement.id === 'manual-input') {
        manualScan();
    }
});
</script>
{% endblock %}