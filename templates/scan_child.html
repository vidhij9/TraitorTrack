{% extends "layout.html" %}

{% block title %}Scan Child Bag{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark text-light border-success mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-barcode me-2"></i>Scan Child Bags</h5>
                </div>
                <div class="card-body">
                    <!-- Parent Bag Info -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1"><i class="fas fa-box me-2"></i>Parent Bag: {{ parent_bag.qr_id }}</h5>
                                <p class="mb-0 text-muted">Please scan {{ expected_child_count }} child bags (format: C123)</p>
                            </div>
                            <div class="text-end">
                                <h5 id="progress_text">{{ scanned_child_count }} of {{ expected_child_count }} bags scanned</h5>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Circles -->
                    <div class="progress-tracker mb-4">
                        <div id="progress_circles" class="progress-circles">
                            {% for i in range(1, expected_child_count + 1) %}
                            <div class="progress-circle {% if i <= scanned_child_count %}completed{% endif %}">{{ i }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- QR Scanner -->
                    <div class="row">
                        <div class="col-md-8 mx-auto">
                            <div class="qr-scanner-container">
                                <video id="qr-video" class="w-100 rounded"></video>
                                <div class="qr-scanner-overlay">
                                    <div class="qr-scanner-target">
                                        <div class="qr-scanner-line"></div>
                                    </div>
                                </div>
                                <canvas id="qr-canvas" style="display: none;"></canvas>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-3">
                                <button id="switch-camera-btn" class="btn btn-outline-light">
                                    <i class="fas fa-sync-alt me-2"></i>Switch Camera
                                </button>
                                <button id="pause-scan-btn" class="btn btn-outline-success">
                                    <i class="fas fa-pause me-2"></i>Pause
                                </button>
                            </div>
                            
                            <div class="mt-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-keyboard"></i></span>
                                    <input type="text" id="manual-input" class="form-control" placeholder="Manually enter child QR code (e.g. C123)">
                                    <button id="manual-submit-btn" class="btn btn-success">Submit</button>
                                </div>
                                <div class="form-text text-muted">If scanning doesn't work, you can manually enter the QR code here.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scanned Items List -->
                    <div class="mt-4">
                        <h5><i class="fas fa-list-check me-2"></i>Scanned Child Bags</h5>
                        <div id="scanned-items-container">
                            <ul id="scanned-items-list" class="list-group">
                                {% if scanned_child_ids %}
                                    {% for child_id in scanned_child_ids %}
                                    <li class="list-group-item bg-dark text-light">
                                        <i class="fas fa-check-circle text-success me-2"></i>{{ child_id }}
                                    </li>
                                    {% endfor %}
                                {% else %}
                                    <li id="no-items-message" class="list-group-item bg-dark text-light">
                                        <i class="fas fa-info-circle me-2"></i>No child bags scanned yet
                                    </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Complete Scanning Button -->
                    <div class="d-grid gap-2 col-md-6 mx-auto mt-4">
                        <a id="finish_scanning_btn" 
                           href="{{ url_for('finish_scanning') }}" 
                           class="btn btn-lg btn-success {% if scanned_child_count < expected_child_count %}disabled{% endif %}"
                           data-href="{{ url_for('finish_scanning') }}">
                            <i class="fas fa-check-double me-2"></i>Complete Scanning
                        </a>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <a href="{{ url_for('scan_parent') }}" class="text-success">
                        <i class="fas fa-arrow-left me-2"></i>Back to Parent Scan
                    </a>
                    <a href="{{ url_for('index') }}" class="text-success">
                        <i class="fas fa-home me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const video = document.getElementById('qr-video');
        const canvas = document.getElementById('qr-canvas');
        const ctx = canvas.getContext('2d');
        const switchCameraBtn = document.getElementById('switch-camera-btn');
        const pauseScanBtn = document.getElementById('pause-scan-btn');
        const manualInput = document.getElementById('manual-input');
        const manualSubmitBtn = document.getElementById('manual-submit-btn');
        const scannedItemsList = document.getElementById('scanned-items-list');
        const noItemsMessage = document.getElementById('no-items-message');
        
        let currentStream;
        let scanning = true;
        let canvasWidth = 0;
        let canvasHeight = 0;
        let usingFrontCamera = false;
        let scannedCount = {{ scanned_child_count }};
        let expectedCount = {{ expected_child_count }};
        
        // Function to update progress display
        function updateProgress() {
            // Update progress text
            document.getElementById('progress_text').textContent = 
                `${scannedCount} of ${expectedCount} bags scanned`;
            
            // Enable/disable finish button based on completion
            const finishButton = document.getElementById('finish_scanning_btn');
            if (scannedCount >= expectedCount) {
                finishButton.classList.remove('disabled');
            } else {
                finishButton.classList.add('disabled');
            }
            
            // Update progress circles
            updateProgressCircles(scannedCount, expectedCount);
        }
        
        // Initialize camera
        function initCamera(useBackCamera = true) {
            if (currentStream) {
                stopCamera();
            }
            
            usingFrontCamera = !useBackCamera;
            
            // Set constraints based on camera choice
            const constraints = {
                video: {
                    facingMode: useBackCamera ? 'environment' : 'user',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            // Start video stream
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    currentStream = stream;
                    video.srcObject = stream;
                    video.setAttribute('playsinline', true);
                    video.play();
                    requestAnimationFrame(scanQRCode);
                    
                    // Update canvas size after video loads
                    video.onloadedmetadata = function() {
                        canvasWidth = video.videoWidth;
                        canvasHeight = video.videoHeight;
                        canvas.width = canvasWidth;
                        canvas.height = canvasHeight;
                    };
                })
                .catch(function(err) {
                    console.error('Camera error:', err);
                    alert('Could not access the camera. Please ensure you have granted camera permissions or try entering the QR code manually.');
                });
        }
        
        // Stop camera
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }
        
        // Toggle scanning pause
        function togglePause() {
            scanning = !scanning;
            pauseScanBtn.innerHTML = scanning ? 
                '<i class="fas fa-pause me-2"></i>Pause' : 
                '<i class="fas fa-play me-2"></i>Resume';
        }
        
        // Add scanned item to list
        function addScannedItem(qrCode) {
            // Remove "no items" message if present
            if (noItemsMessage && noItemsMessage.parentNode) {
                noItemsMessage.remove();
            }
            
            // Create new list item
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item bg-dark text-light';
            listItem.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${qrCode}`;
            
            // Add animation
            listItem.style.animation = 'fadeIn 0.5s';
            
            // Add to list
            scannedItemsList.appendChild(listItem);
        }
        
        // Process scanned QR code
        function processQRCode(qrCode) {
            // Stop scanning temporarily
            scanning = false;
            pauseScanBtn.innerHTML = '<i class="fas fa-play me-2"></i>Resume';
            
            // Process through API
            const formData = new FormData();
            formData.append('qr_code', qrCode);
            
            fetch("{{ url_for('process_child_scan') }}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add to the list
                    addScannedItem(qrCode);
                    
                    // Update counts
                    scannedCount = data.scanned_count;
                    
                    // Update progress display
                    updateProgress();
                    
                    // Show toast notification
                    if (window.showToast) {
                        window.showToast(data.message, 'success');
                    } else {
                        alert(data.message);
                    }
                    
                    // Restart scanning
                    scanning = true;
                    pauseScanBtn.innerHTML = '<i class="fas fa-pause me-2"></i>Pause';
                    
                    // Clear manual input
                    manualInput.value = '';
                    
                } else {
                    // Show error
                    if (window.showToast) {
                        window.showToast('Error: ' + data.message, 'danger');
                    } else {
                        alert('Error: ' + data.message);
                    }
                    
                    // Restart scanning
                    scanning = true;
                    pauseScanBtn.innerHTML = '<i class="fas fa-pause me-2"></i>Pause';
                }
            })
            .catch(error => {
                console.error('Error processing QR code:', error);
                alert('Error processing QR code. Please try again.');
                scanning = true;
                pauseScanBtn.innerHTML = '<i class="fas fa-pause me-2"></i>Pause';
            });
        }
        
        // Scan for QR code in video
        function scanQRCode() {
            if (scanning && currentStream) {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    // Draw video frame to canvas
                    ctx.drawImage(video, 0, 0, canvasWidth, canvasHeight);
                    
                    // Get image data for processing
                    const imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
                    
                    // Process with jsQR
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code && code.data) {
                        console.log("QR Code detected:", code.data);
                        
                        // Check if it's a valid child bag QR code
                        const childBagRegex = /^C\d+$/;
                        if (childBagRegex.test(code.data)) {
                            processQRCode(code.data);
                        }
                    }
                }
                
                // Continue scanning
                requestAnimationFrame(scanQRCode);
            }
        }
        
        // Manual QR code input
        manualSubmitBtn.addEventListener('click', function() {
            const manualCode = manualInput.value.trim();
            if (manualCode) {
                processQRCode(manualCode);
            } else {
                alert('Please enter a valid QR code.');
            }
        });
        
        // Also allow pressing Enter on input
        manualInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const manualCode = manualInput.value.trim();
                if (manualCode) {
                    processQRCode(manualCode);
                }
            }
        });
        
        // Switch camera button
        switchCameraBtn.addEventListener('click', function() {
            initCamera(!usingFrontCamera);
        });
        
        // Pause/resume button
        pauseScanBtn.addEventListener('click', togglePause);
        
        // Initialize with back camera by default
        initCamera(true);
        
        // Update initial progress display
        updateProgress();
        
        // Cleanup on page leave
        window.addEventListener('beforeunload', stopCamera);
    });
    
    // CSS animation for new items
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}