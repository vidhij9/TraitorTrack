{% extends "layout.html" %}

{% block title %}Scan Child Bags{% endblock %}

{% block content %}
<div class="container-fluid px-2 py-2">
    <!-- Header with parent bag info -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white py-2">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-qrcode me-2"></i>
                            <div>
                                <h6 class="mb-0">Child Bag Scanner</h6>
                                {% if parent_bag %}
                                <small class="text-light">Parent: {{ parent_bag.qr_id }}</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="d-flex gap-1 flex-shrink-0">
                            <span class="badge bg-light text-success">
                                <span id="progress-text">{{ scanned_child_count }}</span> Linked
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Apple-quality camera container -->
                    <div class="video-container" style="position: relative; height: 350px; overflow: hidden;">
                        <video id="video" playsinline autoplay muted 
                               style="width: 100%; height: 100%; object-fit: cover; background: #000;"></video>
                        <canvas id="canvas" 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                        
                        <!-- Apple-style scanning interface -->
                        <div class="scanning-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                            <!-- Center viewfinder -->
                            <div style="position: absolute; 
                                        top: 50%; left: 50%; 
                                        transform: translate(-50%, -50%);
                                        width: 250px; height: 250px;
                                        border: 2px solid rgba(255, 255, 255, 0.8);
                                        border-radius: 20px;">
                            </div>
                            
                            <!-- Instructions -->
                            <div style="position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%);
                                        background: rgba(0,0,0,0.7); color: white; padding: 12px 20px;
                                        border-radius: 25px; text-align: center; font-size: 14px;">
                                Position QR code within the frame
                            </div>
                        </div>
                        
                        <!-- Camera controls -->
                        <div class="camera-controls" style="position: absolute; bottom: 20px; right: 20px;">
                            <button id="start-camera" class="btn btn-success btn-sm">
                                <i class="fas fa-camera"></i> Start
                            </button>
                            <button id="stop-camera" class="btn btn-danger btn-sm ms-1">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                        </div>
                    </div>
                    
                    <!-- Result display -->
                    <div id="result-container" class="alert alert-info m-2">
                        <i class="fas fa-info-circle me-2"></i>
                        {% if parent_bag %}
                            Ready to scan child bags for parent: <strong>{{ parent_bag.qr_id }}</strong>
                        {% else %}
                            Please scan a parent bag first.
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Manual Entry Section -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-keyboard me-2"></i>Manual Entry</h6>
                </div>
                <div class="card-body p-2">
                    <form id="manual-entry-form" class="d-flex gap-2">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="text" 
                               id="manual-qr-input" 
                               name="qr_code"
                               class="form-control form-control-sm" 
                               placeholder="Enter child bag QR code manually..."
                               autocomplete="off">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-1"></i>Add
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action buttons section -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-tasks me-2"></i>Actions</h6>
                </div>
                <div class="card-body p-2">
                    <div class="row g-2">
                        <div class="col-6">
                            <button type="button" id="changeParentBtn" class="btn btn-outline-warning w-100 btn-sm" onclick="changeParent()">
                                <i class="fas fa-exchange-alt me-1"></i>Change Parent
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="button" id="completeBtn" class="btn btn-success w-100 btn-sm" onclick="completeScan()">
                                <i class="fas fa-check me-1"></i>Complete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scanned bags list -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>Scanned Child Bags</h6>
                </div>
                <div class="card-body p-2">
                    <ul id="scanned-list" class="list-group list-group-flush">
                        <!-- Dynamically populated -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Apple-quality scanner variables
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let canvasContext = canvas.getContext('2d');
    let resultContainer = document.getElementById('result-container');
    let scannedList = document.getElementById('scanned-list');
    let progressText = document.getElementById('progress-text');
    
    let stream = null;
    let scanning = false;
    let isProcessing = false;
    let lastDetectedCode = null;
    let scannedCount = {{ scanned_child_count }};
    
    const hasParentBag = {{ 'true' if parent_bag else 'false' }};
    
    // Apple-quality camera setup with fallback
    async function startAppleQualityCamera() {
        try {
            scanning = true;
            
            // Stop any existing stream first
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            // Professional camera constraints for Apple-like quality
            const constraints = {
                video: {
                    facingMode: 'environment', // Back camera
                    width: { ideal: 1920, min: 640 },
                    height: { ideal: 1080, min: 480 },
                    frameRate: { ideal: 30, min: 15 }
                }
            };
            
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('Camera stream obtained successfully');
            } catch (error) {
                console.log('High-quality camera failed, trying basic:', error);
                // Fallback to basic camera
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
            }
            
            // Set video source and ensure it loads
            video.srcObject = stream;
            video.style.display = 'block';
            
            // Wait for video to be ready
            await new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    console.log('Video metadata loaded');
                    resolve();
                };
                // Fallback timeout
                setTimeout(resolve, 3000);
            });
            
            // Start video playback
            try {
                await video.play();
                console.log('Video playback started');
                initializeScanning();
            } catch (playError) {
                console.error('Video play error:', playError);
                resultContainer.className = 'alert alert-warning';
                resultContainer.innerHTML = '<i class="fas fa-play me-2"></i>Tap video to start camera';
                
                // Add click to play functionality
                video.addEventListener('click', async () => {
                    try {
                        await video.play();
                        console.log('Video started after user interaction');
                        initializeScanning();
                    } catch (e) {
                        console.error('Manual play failed:', e);
                    }
                });
                return;
            }
            
            // Initialize scanning after successful play
            initializeScanning();
            
        } catch (error) {
            console.error('Camera setup failed:', error);
            resultContainer.className = 'alert alert-danger';
            resultContainer.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Camera access failed. Please allow camera permissions.';
            scanning = false;
        }
    }
    
    function initializeScanning() {
        // Set canvas dimensions to match video
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        
        console.log(`Canvas size: ${canvas.width}x${canvas.height}, Video size: ${video.videoWidth}x${video.videoHeight}`);
        
        // Start ultra-fast scanning loop
        requestAnimationFrame(scanForQRCode);
        
        resultContainer.className = 'alert alert-info';
        resultContainer.innerHTML = '<i class="fas fa-camera me-2"></i>Camera ready - Point at QR code to scan';
    }
    
    // Ultra-fast QR scanning for instant detection
    function scanForQRCode() {
        if (!scanning) return;
        
        // High-speed scanning for instant response - no throttling
        requestAnimationFrame(scanForQRCode);
        
        if (video.readyState === video.HAVE_ENOUGH_DATA && typeof jsQR !== 'undefined') {
            try {
                // Draw current frame using video's natural dimensions
                canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Ultra-fast center-focused scanning for instant detection
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const scanSize = Math.min(canvas.width, canvas.height) * 0.7;
                const startX = Math.max(0, centerX - scanSize/2);
                const startY = Math.max(0, centerY - scanSize/2);
                const width = Math.min(scanSize, canvas.width - startX);
                const height = Math.min(scanSize, canvas.height - startY);
                
                // Get center region for fastest processing
                const imageData = canvasContext.getImageData(startX, startY, width, height);
                
                // Single ultra-fast detection for instant response
                let detectedCode = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "attemptBoth"
                });
                
                if (detectedCode && detectedCode.data) {
                    // Draw Apple-style orange corner highlights with offset correction
                    drawAppleStyleHighlight(detectedCode, startX, startY);
                    
                    // Clean and validate QR code data
                    let qrData = detectedCode.data.trim();
                    
                    // Remove any invisible characters that cause issues
                    qrData = qrData.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
                    
                    console.log('QR detected:', qrData);
                    console.log('QR data length:', qrData.length);
                    
                    // Validate QR code format
                    if (qrData && qrData.length > 0) {
                        // Auto-submit for instant linking (Apple-like behavior)
                        if (!isProcessing && lastDetectedCode !== qrData) {
                            autoSubmitChildBag(qrData);
                        }
                    }
                }
                
            } catch (error) {
                console.log('Scanning error:', error);
            }
        }
    }
    
    // Enhanced contrast for small QR codes
    function enhanceForSmallQR(imageData) {
        const data = new Uint8ClampedArray(imageData.data);
        const factor = 2.5; // Strong contrast
        const intercept = 128 * (1 - factor);
        
        for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.max(0, Math.min(255, data[i] * factor + intercept));
            data[i + 1] = Math.max(0, Math.min(255, data[i + 1] * factor + intercept));
            data[i + 2] = Math.max(0, Math.min(255, data[i + 2] * factor + intercept));
        }
        
        return new ImageData(data, imageData.width, imageData.height);
    }
    
    // Edge detection for very small QR codes
    function applyEdgeDetection(imageData) {
        const data = new Uint8ClampedArray(imageData.data);
        const width = imageData.width;
        const height = imageData.height;
        
        for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
                const idx = (y * width + x) * 4;
                const gray = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                const edge = gray > 128 ? 255 : 0;
                
                data[idx] = edge;
                data[idx + 1] = edge;
                data[idx + 2] = edge;
            }
        }
        
        return new ImageData(data, width, height);
    }
    
    // Apple-style orange corner highlighting with proper offset positioning
    function drawAppleStyleHighlight(code, offsetX = 0, offsetY = 0) {
        const corners = code.location;
        canvasContext.strokeStyle = '#FF8C00'; // Apple orange
        canvasContext.lineWidth = 8;
        canvasContext.lineCap = 'round';
        
        const size = 35;
        
        // Top-left (adjusted for center scanning offset)
        canvasContext.beginPath();
        canvasContext.moveTo(corners.topLeftCorner.x + offsetX, corners.topLeftCorner.y + offsetY + size);
        canvasContext.lineTo(corners.topLeftCorner.x + offsetX, corners.topLeftCorner.y + offsetY);
        canvasContext.lineTo(corners.topLeftCorner.x + offsetX + size, corners.topLeftCorner.y + offsetY);
        canvasContext.stroke();
        
        // Top-right
        canvasContext.beginPath();
        canvasContext.moveTo(corners.topRightCorner.x + offsetX - size, corners.topRightCorner.y + offsetY);
        canvasContext.lineTo(corners.topRightCorner.x + offsetX, corners.topRightCorner.y + offsetY);
        canvasContext.lineTo(corners.topRightCorner.x + offsetX, corners.topRightCorner.y + offsetY + size);
        canvasContext.stroke();
        
        // Bottom-left
        canvasContext.beginPath();
        canvasContext.moveTo(corners.bottomLeftCorner.x + offsetX, corners.bottomLeftCorner.y + offsetY - size);
        canvasContext.lineTo(corners.bottomLeftCorner.x + offsetX, corners.bottomLeftCorner.y + offsetY);
        canvasContext.lineTo(corners.bottomLeftCorner.x + offsetX + size, corners.bottomLeftCorner.y + offsetY);
        canvasContext.stroke();
        
        // Bottom-right
        canvasContext.beginPath();
        canvasContext.moveTo(corners.bottomRightCorner.x + offsetX - size, corners.bottomRightCorner.y + offsetY);
        canvasContext.lineTo(corners.bottomRightCorner.x + offsetX, corners.bottomRightCorner.y + offsetY);
        canvasContext.lineTo(corners.bottomRightCorner.x + offsetX, corners.bottomRightCorner.y + offsetY - size);
        canvasContext.stroke();
    }
    
    // Ultra-fast child bag submission for instant linking
    function autoSubmitChildBag(qrData) {
        console.log('Ultra-fast submitting child bag:', qrData);
        
        lastDetectedCode = qrData;
        isProcessing = true;
        
        // Instant haptic feedback
        if (navigator.vibrate) {
            navigator.vibrate(25); // Ultra-brief vibration
        }
        
        // Minimal processing UI for speed
        resultContainer.className = 'alert alert-info';
        resultContainer.innerHTML = `<i class="fas fa-bolt me-2"></i>Linking ${qrData}...`;
        
        // Submit with comprehensive error handling
        fetch('{{ url_for("scan_child", s=request.args.get("s")) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: 'qr_code=' + encodeURIComponent(qrData) + '&csrf_token=' + encodeURIComponent('{{ csrf_token() }}')
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Child bag submission response:', data);
            
            if (data.success) {
                // Success with haptic feedback
                if (navigator.vibrate) {
                    navigator.vibrate([50, 50, 50]); // Success pattern
                }
                
                resultContainer.className = 'alert alert-success';
                resultContainer.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-2"></i>
                        <div>
                            <strong>Success!</strong> Child bag ${qrData} linked successfully
                            <br><small>Ready to scan next child bag</small>
                        </div>
                    </div>
                `;
                
                // Update progress counter
                scannedCount++;
                progressText.textContent = scannedCount;
                
                // Add to scanned list
                addBagToList(qrData);
                
                // Ultra-fast reset for immediate next scan
                setTimeout(() => {
                    isProcessing = false;
                    lastDetectedCode = null;
                }, 500); // Reduced to 500ms for instant next scan
                
            } else {
                // Handle specific error cases
                resultContainer.className = 'alert alert-warning';
                let errorMessage = data.message || 'Unknown error occurred';
                
                if (errorMessage.includes('duplicate') || errorMessage.includes('already')) {
                    resultContainer.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div>
                                <strong>Already Linked:</strong> ${qrData}
                                <br><small>${errorMessage}</small>
                            </div>
                        </div>
                    `;
                } else {
                    resultContainer.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div>
                                <strong>Error:</strong> ${errorMessage}
                                <br><small>QR Code: ${qrData}</small>
                            </div>
                        </div>
                    `;
                }
                
                // Reset processing state
                setTimeout(() => {
                    isProcessing = false;
                    lastDetectedCode = null;
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error submitting child bag:', error);
            
            resultContainer.className = 'alert alert-danger';
            resultContainer.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <div>
                        <strong>Network Error:</strong> Could not process QR code
                        <br><small>Please check your connection and try again</small>
                    </div>
                </div>
            `;
            
            // Reset processing state
            setTimeout(() => {
                isProcessing = false;
                lastDetectedCode = null;
            }, 3000);
        });
    }
    
    // Stop camera
    function stopCamera() {
        scanning = false;
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        canvasContext.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    // Load scanned bags
    function loadScannedBags() {
        fetch('/api/scanned-children?s={{ request.args.get("s") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.children) {
                    scannedList.innerHTML = '';
                    data.children.forEach(child => {
                        addBagToList(child.qr_id);
                    });
                }
            })
            .catch(error => console.log('No existing bags to load'));
    }
    
    // Add bag to list with delete functionality
    function addBagToList(qrCode) {
        // Check if already exists
        const existing = scannedList.querySelector(`[data-qr-code="${qrCode}"]`);
        if (existing) return;
        
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
        listItem.dataset.qrCode = qrCode;
        listItem.innerHTML = `
            <div>
                <span class="badge bg-success me-2">Child</span>
                <span>${qrCode}</span>
            </div>
            <div>
                <span class="badge bg-primary rounded-pill me-2">
                    <i class="fas fa-link me-1"></i>Linked
                </span>
                <button class="btn btn-sm btn-outline-danger delete-bag" data-qr="${qrCode}" title="Delete this scan">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        scannedList.prepend(listItem);
    }
    
    // Handle delete button clicks
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-bag') || e.target.parentElement.classList.contains('delete-bag')) {
            const button = e.target.classList.contains('delete-bag') ? e.target : e.target.parentElement;
            const qrCode = button.dataset.qr;
            
            if (confirm(`Are you sure you want to delete the scan for ${qrCode}?`)) {
                // Send delete request to server
                fetch('/api/delete-child-scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `qr_code=${encodeURIComponent(qrCode)}&csrf_token={{ csrf_token() }}&s={{ request.args.get("s") }}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove from UI
                        const listItem = document.querySelector(`[data-qr-code="${qrCode}"]`);
                        if (listItem) {
                            listItem.remove();
                            scannedCount--;
                            progressText.textContent = scannedCount;
                        }
                        
                        resultContainer.className = 'alert alert-info';
                        resultContainer.innerHTML = '<i class="fas fa-info-circle me-2"></i>Scan deleted successfully.';
                    } else {
                        resultContainer.className = 'alert alert-danger';
                        resultContainer.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Failed to delete scan.';
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                    resultContainer.className = 'alert alert-danger';
                    resultContainer.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Network error while deleting.';
                });
            }
        }
    });
    
    // Manual entry form submission
    document.getElementById('manual-entry-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const qrInput = document.getElementById('manual-qr-input');
        const qrData = qrInput.value.trim();
        
        if (!qrData) {
            resultContainer.className = 'alert alert-warning';
            resultContainer.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Please enter a QR code.';
            return;
        }
        
        // Clear input and submit
        qrInput.value = '';
        autoSubmitChildBag(qrData);
    });
    
    // Button events
    document.getElementById('start-camera').addEventListener('click', startAppleQualityCamera);
    document.getElementById('stop-camera').addEventListener('click', stopCamera);
    
    // Auto-start camera if parent bag exists
    setTimeout(() => {
        if (hasParentBag && typeof jsQR !== 'undefined') {
            startAppleQualityCamera();
        }
    }, 1000);
    
    // Load existing scanned bags
    loadScannedBags();
    
    // Change parent button functionality
    window.changeParent = function() {
        if (confirm('Are you sure you want to change the parent bag? This will redirect you to scan a new parent.')) {
            window.location.href = "{{ url_for('scan_parent') }}";
        }
    }
    
    // Complete scan functionality
    window.completeScan = function() {
        if (confirm('Are you sure you want to complete this scanning session?')) {
            // Get the parent QR from session or current context
            const parentQr = "{{ session.get('current_parent_qr', '') }}";
            if (parentQr) {
                window.location.href = "{{ url_for('scan_complete') }}?parent=" + encodeURIComponent(parentQr);
            } else {
                window.location.href = "{{ url_for('index') }}";
            }
        }
    }
});
</script>
{% endblock %}