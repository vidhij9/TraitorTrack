{% extends "layout.html" %}

{% block title %}Scan Child Bags{% endblock %}

{% block content %}
<div class="container-fluid px-2 py-2">
    <!-- Header with parent bag info -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white py-2">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-qrcode me-2"></i>
                            <div>
                                <h6 class="mb-0">Child Bag Scanner</h6>
                                {% if parent_bag %}
                                <small class="text-light">Parent: {{ parent_bag.qr_id }}</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="d-flex gap-1 flex-shrink-0">
                            <span class="badge bg-light text-success">
                                <span id="progress-text">{{ scanned_child_count }}</span> Linked
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Apple-quality camera container -->
                    <div class="video-container" style="position: relative; height: 350px; overflow: hidden;">
                        <video id="video" playsinline autoplay muted 
                               style="width: 100%; height: 100%; object-fit: cover; background: #000;"></video>
                        <canvas id="canvas" 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                        
                        <!-- Apple-style scanning interface -->
                        <div class="scanning-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                            <!-- Center viewfinder -->
                            <div style="position: absolute; 
                                        top: 50%; left: 50%; 
                                        transform: translate(-50%, -50%);
                                        width: 250px; height: 250px;
                                        border: 2px solid rgba(255, 255, 255, 0.8);
                                        border-radius: 20px;">
                            </div>
                            
                            <!-- Instructions -->
                            <div style="position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%);
                                        background: rgba(0,0,0,0.7); color: white; padding: 12px 20px;
                                        border-radius: 25px; text-align: center; font-size: 14px;">
                                Position QR code within the frame
                            </div>
                        </div>
                        
                        <!-- Camera controls -->
                        <div class="camera-controls" style="position: absolute; bottom: 20px; right: 20px;">
                            <button id="start-camera" class="btn btn-success btn-sm">
                                <i class="fas fa-camera"></i> Start
                            </button>
                            <button id="stop-camera" class="btn btn-danger btn-sm ms-1">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                        </div>
                    </div>
                    
                    <!-- Result display -->
                    <div id="result-container" class="alert alert-info m-2">
                        <i class="fas fa-info-circle me-2"></i>
                        {% if parent_bag %}
                            Ready to scan child bags for parent: <strong>{{ parent_bag.qr_id }}</strong>
                        {% else %}
                            Please scan a parent bag first.
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scanned bags list -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>Scanned Child Bags</h6>
                </div>
                <div class="card-body p-2">
                    <ul id="scanned-list" class="list-group list-group-flush">
                        <!-- Dynamically populated -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Apple-quality scanner variables
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let canvasContext = canvas.getContext('2d');
    let resultContainer = document.getElementById('result-container');
    let scannedList = document.getElementById('scanned-list');
    let progressText = document.getElementById('progress-text');
    
    let stream = null;
    let scanning = false;
    let isProcessing = false;
    let lastDetectedCode = null;
    let scannedCount = {{ scanned_child_count }};
    
    const hasParentBag = {{ 'true' if parent_bag else 'false' }};
    
    // Apple-quality camera setup
    async function startAppleQualityCamera() {
        try {
            scanning = true;
            
            // Professional camera constraints for Apple-like quality
            const constraints = {
                video: {
                    facingMode: 'environment', // Back camera
                    width: { ideal: 1920, min: 1280 },
                    height: { ideal: 1080, min: 720 },
                    frameRate: { ideal: 30 },
                    // Advanced camera settings for quality
                    advanced: [
                        { focusMode: 'continuous' },
                        { exposureMode: 'continuous' },
                        { whiteBalanceMode: 'continuous' }
                    ]
                }
            };
            
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
            } catch (error) {
                // Fallback to basic high-quality constraints
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
            }
            
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                // Use video's natural dimensions to preserve aspect ratio
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                video.play();
                appleQualityScanning();
            };
            
        } catch (error) {
            console.error('Camera error:', error);
            resultContainer.className = 'alert alert-danger';
            resultContainer.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Camera access denied. Please allow camera permissions.';
        }
    }
    
    // Apple-quality QR scanning with instant detection
    function appleQualityScanning() {
        if (!scanning) return;
        
        // 30fps scanning for instant response
        requestAnimationFrame(appleQualityScanning);
        
        if (video.readyState === video.HAVE_ENOUGH_DATA && typeof jsQR !== 'undefined') {
            try {
                // Draw current frame using video's natural dimensions
                canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Get image data for QR detection
                const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
                
                // Multi-stage detection for small QR codes
                let detectedCode = null;
                
                // Stage 1: Standard detection
                detectedCode = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "attemptBoth"
                });
                
                // Stage 2: Enhanced contrast for small codes
                if (!detectedCode) {
                    const enhancedData = enhanceForSmallQR(imageData);
                    detectedCode = jsQR(enhancedData.data, enhancedData.width, enhancedData.height, {
                        inversionAttempts: "attemptBoth"
                    });
                }
                
                // Stage 3: Edge detection for tiny codes
                if (!detectedCode) {
                    const edgeData = applyEdgeDetection(imageData);
                    detectedCode = jsQR(edgeData.data, edgeData.width, edgeData.height, {
                        inversionAttempts: "attemptBoth"
                    });
                }
                
                if (detectedCode && detectedCode.data) {
                    // Draw Apple-style orange corner highlights
                    drawAppleStyleHighlight(detectedCode);
                    
                    const qrData = detectedCode.data.trim();
                    console.log('QR detected:', qrData);
                    
                    // Auto-submit for instant linking (Apple-like behavior)
                    if (!isProcessing && lastDetectedCode !== qrData) {
                        autoSubmitChildBag(qrData);
                    }
                }
                
            } catch (error) {
                console.log('Scanning error:', error);
            }
        }
    }
    
    // Enhanced contrast for small QR codes
    function enhanceForSmallQR(imageData) {
        const data = new Uint8ClampedArray(imageData.data);
        const factor = 2.5; // Strong contrast
        const intercept = 128 * (1 - factor);
        
        for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.max(0, Math.min(255, data[i] * factor + intercept));
            data[i + 1] = Math.max(0, Math.min(255, data[i + 1] * factor + intercept));
            data[i + 2] = Math.max(0, Math.min(255, data[i + 2] * factor + intercept));
        }
        
        return new ImageData(data, imageData.width, imageData.height);
    }
    
    // Edge detection for very small QR codes
    function applyEdgeDetection(imageData) {
        const data = new Uint8ClampedArray(imageData.data);
        const width = imageData.width;
        const height = imageData.height;
        
        for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
                const idx = (y * width + x) * 4;
                const gray = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                const edge = gray > 128 ? 255 : 0;
                
                data[idx] = edge;
                data[idx + 1] = edge;
                data[idx + 2] = edge;
            }
        }
        
        return new ImageData(data, width, height);
    }
    
    // Apple-style orange corner highlighting
    function drawAppleStyleHighlight(code) {
        const corners = code.location;
        canvasContext.strokeStyle = '#FF8C00'; // Apple orange
        canvasContext.lineWidth = 8;
        canvasContext.lineCap = 'round';
        
        const size = 35;
        
        // Top-left
        canvasContext.beginPath();
        canvasContext.moveTo(corners.topLeftCorner.x, corners.topLeftCorner.y + size);
        canvasContext.lineTo(corners.topLeftCorner.x, corners.topLeftCorner.y);
        canvasContext.lineTo(corners.topLeftCorner.x + size, corners.topLeftCorner.y);
        canvasContext.stroke();
        
        // Top-right
        canvasContext.beginPath();
        canvasContext.moveTo(corners.topRightCorner.x - size, corners.topRightCorner.y);
        canvasContext.lineTo(corners.topRightCorner.x, corners.topRightCorner.y);
        canvasContext.lineTo(corners.topRightCorner.x, corners.topRightCorner.y + size);
        canvasContext.stroke();
        
        // Bottom-left
        canvasContext.beginPath();
        canvasContext.moveTo(corners.bottomLeftCorner.x, corners.bottomLeftCorner.y - size);
        canvasContext.lineTo(corners.bottomLeftCorner.x, corners.bottomLeftCorner.y);
        canvasContext.lineTo(corners.bottomLeftCorner.x + size, corners.bottomLeftCorner.y);
        canvasContext.stroke();
        
        // Bottom-right
        canvasContext.beginPath();
        canvasContext.moveTo(corners.bottomRightCorner.x - size, corners.bottomRightCorner.y);
        canvasContext.lineTo(corners.bottomRightCorner.x, corners.bottomRightCorner.y);
        canvasContext.lineTo(corners.bottomRightCorner.x, corners.bottomRightCorner.y - size);
        canvasContext.stroke();
    }
    
    // Auto-submit child bag (Apple instant behavior)
    function autoSubmitChildBag(qrData) {
        lastDetectedCode = qrData;
        isProcessing = true;
        
        // Show processing
        resultContainer.className = 'alert alert-info';
        resultContainer.innerHTML = '<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2"></div>Processing ' + qrData + '...</div>';
        
        // Submit instantly
        fetch('{{ url_for("scan_child", s=request.args.get("s")) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: 'qr_code=' + encodeURIComponent(qrData) + '&csrf_token=' + encodeURIComponent('{{ csrf_token() }}')
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultContainer.className = 'alert alert-success';
                resultContainer.innerHTML = '<i class="fas fa-check me-2"></i>Child bag ' + qrData + ' linked successfully!';
                
                scannedCount++;
                progressText.textContent = scannedCount;
                loadScannedBags();
                
                // Reset after delay
                setTimeout(() => {
                    isProcessing = false;
                    lastDetectedCode = null;
                }, 1500);
            } else {
                resultContainer.className = 'alert alert-danger';
                resultContainer.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + (data.message || 'Failed to process');
                
                setTimeout(() => {
                    isProcessing = false;
                    lastDetectedCode = null;
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Submit error:', error);
            resultContainer.className = 'alert alert-danger';
            resultContainer.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Network error. Please try again.';
            
            setTimeout(() => {
                isProcessing = false;
                lastDetectedCode = null;
            }, 2000);
        });
    }
    
    // Stop camera
    function stopCamera() {
        scanning = false;
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        canvasContext.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    // Load scanned bags
    function loadScannedBags() {
        fetch('/api/scanned-children?s={{ request.args.get("s") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.children) {
                    scannedList.innerHTML = '';
                    data.children.forEach(child => {
                        addBagToList(child.qr_id);
                    });
                }
            })
            .catch(error => console.log('No existing bags to load'));
    }
    
    // Add bag to list
    function addBagToList(qrCode) {
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
        listItem.innerHTML = `
            <div>
                <span class="badge bg-success me-2">Child</span>
                <span>${qrCode}</span>
            </div>
            <span class="badge bg-primary">Linked</span>
        `;
        scannedList.prepend(listItem);
    }
    
    // Button events
    document.getElementById('start-camera').addEventListener('click', startAppleQualityCamera);
    document.getElementById('stop-camera').addEventListener('click', stopCamera);
    
    // Auto-start camera if parent bag exists
    setTimeout(() => {
        if (hasParentBag && typeof jsQR !== 'undefined') {
            startAppleQualityCamera();
        }
    }, 1000);
    
    // Load existing scanned bags
    loadScannedBags();
});
</script>
{% endblock %}