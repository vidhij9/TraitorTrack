{% extends "layout.html" %}

{% block title %}Scan Child Bags - traitor track{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-3">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h4 class="mb-0">
                            <i class="fas fa-qrcode me-2"></i>Scan Child Bags
                        </h4>
                        {% if parent_bag %}
                        <small class="text-success">
                            <i class="fas fa-link me-1"></i>Parent: {{ parent_bag.qr_id }}
                        </small>
                        {% endif %}
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-indicator">
                            <div class="progress-step completed">
                                <div class="progress-step-circle"><i class="fas fa-check"></i></div>
                                <div class="progress-step-label">Scan Parent Bag</div>
                            </div>
                            <div class="progress-line progress-line-completed"></div>
                            <div class="progress-step active">
                                <div class="progress-step-circle">2</div>
                                <div class="progress-step-label">Scan Child Bags</div>
                            </div>
                            <div class="progress-line"></div>
                            <div class="progress-step">
                                <div class="progress-step-circle">3</div>
                                <div class="progress-step-label">Complete</div>
                            </div>
                        </div>
                    </div>
                    
                    {% if not parent_bag %}
                    <div class="alert alert-warning mb-0 mt-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>No parent bag selected.
                        <a href="{{ url_for('scan_parent', s=request.args.get('s')) }}" class="btn btn-sm btn-primary ms-2">
                            <i class="fas fa-qrcode me-1"></i>Scan Parent
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-3">
        <div class="col-12">
            <div class="card bg-success bg-opacity-25 text-dark">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div>
                            <h5 class="mb-0">Child Bags: <span id="progress-text">{{ scanned_child_count }}</span></h5>
                            {% if parent_bag %}
                            <small class="text-dark opacity-75">Linked to {{ parent_bag.qr_id }}</small>
                            {% endif %}
                        </div>
                        
                        {% if parent_bag %}
                        <div style="display: flex; gap: 3px; flex-shrink: 0;">
                            <button id="scan-another-parent" class="btn btn-outline-light" style="font-size: 0.55rem; padding: 0.15rem 0.35rem; border-radius: 3px; line-height: 1.2;">
                                Parent
                            </button>
                            <a id="finish-button" href="{{ url_for('finish_scanning', s=request.args.get('s')) }}" class="btn btn-light" style="font-size: 0.55rem; padding: 0.15rem 0.35rem; border-radius: 3px; line-height: 1.2;">
                                Complete
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-6 mb-4 mb-lg-0">
            <div class="card">
                <div class="card-header bg-primary bg-opacity-25 text-dark py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-camera me-1"></i>Scanner</h5>
                        <div class="d-flex gap-1">
                            <button id="start-camera" class="btn btn-sm btn-light" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                                <i class="fas fa-play"></i>
                            </button>
                            <button id="stop-camera" class="btn btn-sm btn-outline-light" disabled style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                                <i class="fas fa-stop"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="video-container">
                        <video id="video" playsinline class="d-none"></video>
                        <canvas id="canvas"></canvas>
                        
                        <!-- Camera status overlay -->
                        <div class="camera-status-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center d-none" id="camera-status" style="z-index: 4; background: rgba(0,0,0,0.8);">
                            <div class="bg-light bg-opacity-75 text-white p-3 rounded text-center">
                                <div class="spinner-border mb-2" role="status"></div>
                                <div>Starting camera...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer py-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>Position QR in frame
                        </small>
                        <button id="switch-camera" class="btn btn-sm btn-outline-primary d-none" style="font-size: 0.6rem; padding: 0.1rem 0.3rem;">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-success bg-opacity-25 text-dark py-2">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check me-1"></i>Results</h5>
                </div>
                <div class="card-body">
                    <div id="result-container" class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        The results of the scans will appear here.
                    </div>
                    
                    <!-- Real-time scanning status -->
                    <div id="scanning-status" class="alert alert-light mb-3 d-none">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>Scanning for QR codes...</span>
                        </div>
                    </div>
                    
                    <ul id="scanned-list" class="list-group mb-3">
                        <!-- Scanned items will be added here dynamically -->
                    </ul>
                    
                    <form id="manual-entry-form" class="mt-4">

                        <div class="mb-3">
                            <label for="manual-qr-code" class="form-label">Manual QR Code Entry</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-keyboard"></i>
                                </span>
                                <input type="text" class="form-control" id="manual-qr-code" placeholder="e.g., C123">
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </div>
                            <div class="form-text">If scanning doesn't work, you can manually enter the QR code value here.</div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    /* QR Scanner Styles */
    .video-container {
        position: relative;
        overflow: hidden;
        border-radius: 0;
        background-color: #000;
    }
    
    #video {
        background-color: #000;
    }
    
    #canvas {
        background: transparent;
    }
    
    /* Ensure buttons are always visible and properly sized */
    .d-flex.gap-1.flex-shrink-0 {
        flex-shrink: 0;
        min-width: 0;
    }
    
    .d-flex.gap-1.flex-shrink-0 .btn {
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
        .d-flex.align-items-center.justify-content-between {
            align-items: flex-start;
        }
        
        .d-flex.gap-1.flex-shrink-0 {
            flex-wrap: nowrap;
            gap: 0.25rem;
        }
    }

</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startCameraBtn = document.getElementById('start-camera');
        const stopCameraBtn = document.getElementById('stop-camera');
        const resultContainer = document.getElementById('result-container');
        const scannedList = document.getElementById('scanned-list');
        const manualEntryForm = document.getElementById('manual-entry-form');
        const progressText = document.getElementById('progress-text');
        const progressPercentage = document.getElementById('progress-percentage');
        const finishButton = document.getElementById('finish-button');
        
        let stream = null;
        let scanning = false;
        let canvasContext = canvas.getContext('2d');
        let lastDetectedCode = null;
        
        // Current progress
        let scannedCount = {{ scanned_child_count }};
        const hasParentBag = {{ 'true' if parent_bag else 'false' }};
        
        // Load existing scanned bags
        loadScannedBags();
        
        // Automatically start camera when page loads (after jsQR is loaded)
        setTimeout(() => {
            if (typeof jsQR !== 'undefined') {
                // Only start camera automatically if we have a parent bag
                if (hasParentBag) {
                    startCamera();
                } else {
                    resultContainer.className = 'alert alert-warning';
                    resultContainer.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Please scan a parent bag first before scanning child bags.';
                }
            } else {
                console.error('jsQR library not loaded');
                resultContainer.className = 'alert alert-warning';
                resultContainer.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>QR scanner library is loading. Please wait or use manual entry.';
            }
        }, 1000);
        
        // Button event listeners
        startCameraBtn.addEventListener('click', startCamera);
        
        // Change parent button functionality
        const changeParentBtn = document.getElementById('scan-another-parent');
        if (changeParentBtn) {
            changeParentBtn.addEventListener('click', function() {
                if (confirm('This will end your current scanning session. Continue?')) {
                    window.location.href = '{{ url_for("scan_parent", s=request.args.get("s")) }}';
                }
            });
        }
        
        // Stop camera when button is clicked
        stopCameraBtn.addEventListener('click', stopCamera);
        
        // Handle manual entry form submission
        manualEntryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const manualQrCode = document.getElementById('manual-qr-code').value.trim();
            
            if (manualQrCode) {
                processQrCode(manualQrCode);
                document.getElementById('manual-qr-code').value = '';
            }
        });
        
        async function startCamera() {
            const scanningStatus = document.getElementById('scanning-status');
            const cameraStatus = document.getElementById('camera-status');
            
            console.log('Starting optimized child scanner...');
            cameraStatus.classList.remove('d-none');
            scanningStatus.classList.remove('d-none');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                cameraStatus.classList.add('d-none');
                scanningStatus.classList.add('d-none');
                resultContainer.className = 'alert alert-danger';
                resultContainer.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Camera not supported on this device.';
                return;
            }
            
            try {
                // Get available cameras
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                console.log('Available cameras:', videoDevices.length);
                
                // Apple-like constraints for child bag scanning
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920, min: 640 },
                        height: { ideal: 1080, min: 480 },
                        frameRate: { ideal: 30, min: 20 },
                        focusMode: 'continuous',
                        exposureMode: 'continuous',
                        whiteBalanceMode: 'continuous'
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Apply advanced camera settings
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) {
                    const capabilities = videoTrack.getCapabilities();
                    console.log('Camera capabilities:', capabilities);
                    
                    const settings = {};
                    if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                        settings.focusMode = 'continuous';
                    }
                    if (capabilities.exposureMode && capabilities.exposureMode.includes('continuous')) {
                        settings.exposureMode = 'continuous';
                    }
                    
                    if (Object.keys(settings).length > 0) {
                        await videoTrack.applyConstraints({ advanced: [settings] });
                        console.log('Applied camera settings:', settings);
                    }
                }
                
                video.srcObject = stream;
                video.setAttribute('playsinline', true);
                video.setAttribute('autoplay', true);
                video.muted = true;
                
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        console.log('Video loaded:', {
                            videoWidth: video.videoWidth,
                            videoHeight: video.videoHeight,
                            aspectRatio: (video.videoWidth / video.videoHeight).toFixed(2)
                        });
                        
                        // Set canvas to actual video dimensions for 1:1 reality mapping
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        
                        console.log('Canvas set to video dimensions:', {
                            canvasWidth: canvas.width,
                            canvasHeight: canvas.height,
                            videoWidth: video.videoWidth,
                            videoHeight: video.videoHeight
                        });
                        
                        resolve();
                    };
                    
                    video.onerror = reject;
                    video.play().catch(reject);
                });
                
                // Hide camera loading status
                cameraStatus.classList.add('d-none');
                
                startCameraBtn.disabled = true;
                stopCameraBtn.disabled = false;
                scanning = true;
                
                // Start optimized scanning
                optimizedChildScanQRCode();
                
                // Update status
                scanningStatus.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-success me-2" role="status"></div>
                        <span class="text-success">Camera active - Position QR code in scanning area</span>
                    </div>
                `;
                
                // Show camera switch if multiple available
                if (videoDevices.length > 1) {
                    document.getElementById('switch-camera').classList.remove('d-none');
                }
                
            } catch (error) {
                console.error('Camera error:', error);
                cameraStatus.classList.add('d-none');
                scanningStatus.classList.add('d-none');
                
                let errorMessage = 'Camera access failed. ';
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Please allow camera permissions and refresh.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No camera found on this device.';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage += 'Camera settings not supported. Trying basic mode...';
                    // Fallback
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        video.srcObject = stream;
                        await video.play();
                        startCameraBtn.disabled = true;
                        stopCameraBtn.disabled = false;
                        scanning = true;
                        optimizedChildScanQRCode();
                        scanningStatus.innerHTML = '<span class="text-success">Camera active (basic mode)</span>';
                        return;
                    } catch (fallbackError) {
                        errorMessage = 'Camera completely failed to initialize.';
                    }
                } else {
                    errorMessage += 'Please check permissions and try again.';
                }
                
                resultContainer.className = 'alert alert-danger';
                resultContainer.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>' + errorMessage;
            }
        }
        
        function stopCamera() {
            const scanningStatus = document.getElementById('scanning-status');
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                scanning = false;
                
                startCameraBtn.disabled = false;
                stopCameraBtn.disabled = true;
                
                // Hide scanning status
                scanningStatus.classList.add('d-none');
                
                // Clear canvas and show a blank screen
                canvasContext.clearRect(0, 0, canvas.width, canvas.height);
                canvasContext.fillStyle = '#000';
                canvasContext.fillRect(0, 0, canvas.width, canvas.height);
                
                // Show "camera stopped" message on canvas
                canvasContext.fillStyle = '#fff';
                canvasContext.font = '16px Arial';
                canvasContext.textAlign = 'center';
                canvasContext.fillText('Camera stopped', canvas.width/2, canvas.height/2);
            }
        }
        
        function optimizedChildScanQRCode() {
            if (!scanning) return;
            
            // Ultra-fast scanning for instant response
            requestAnimationFrame(optimizedChildScanQRCode);
            
            if (video.readyState === video.HAVE_ENOUGH_DATA && typeof jsQR !== 'undefined') {
                try {
                    // Clear and draw current frame
                    canvasContext.clearRect(0, 0, canvas.width, canvas.height);
                    canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Draw minimal interface for performance
                    drawMinimalChildScanningInterface();
                    
                    // Extract smaller center region for faster processing
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    const scanSize = Math.min(canvas.width, canvas.height) * 0.6;
                    const startX = Math.max(0, centerX - scanSize/2);
                    const startY = Math.max(0, centerY - scanSize/2);
                    const width = Math.min(scanSize, canvas.width - startX);
                    const height = Math.min(scanSize, canvas.height - startY);
                    
                    const imageData = canvasContext.getImageData(startX, startY, width, height);
                    
                    // Multi-attempt QR detection for maximum accuracy
                    let code = null;
                    
                    // Try multiple detection approaches
                    const detectionMethods = [
                        { inversionAttempts: "attemptBoth" },
                        { inversionAttempts: "onlyInvert" },
                        { inversionAttempts: "dontInvert" }
                    ];
                    
                    for (const method of detectionMethods) {
                        code = jsQR(imageData.data, imageData.width, imageData.height, method);
                        if (code && code.data && code.data.length >= 2) {
                            console.log('QR detected with method:', method);
                            break;
                        }
                    }
                    
                    if (code && code.data) {
                        // Raw QR data debugging
                        console.log('Raw QR data detected:', JSON.stringify(code.data));
                        console.log('QR data length:', code.data.length);
                        console.log('QR data chars:', code.data.split('').map(c => `'${c}' (${c.charCodeAt(0)})`));
                        
                        // Clean and validate QR code data
                        let qrData = code.data.trim();
                        
                        // Remove any invisible/control characters
                        qrData = qrData.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
                        
                        console.log('Cleaned QR data:', JSON.stringify(qrData));
                        
                        // Skip if data is too short
                        if (qrData.length < 2) {
                            console.log('Skipping short QR code:', qrData);
                            return;
                        }
                        
                        // Instant detection highlight
                        drawInstantChildDetectionHighlight(code, startX, startY);
                        
                        // Immediate haptic feedback
                        if (navigator.vibrate) {
                            navigator.vibrate(25);
                        }
                        
                        // Process unique codes instantly with validation
                        if (lastDetectedCode !== qrData) {
                            lastDetectedCode = qrData;
                            console.log('Child QR processed:', qrData);
                            processQrCodeInstant(qrData);
                        }
                    }
                } catch (error) {
                    console.error('Child scanning error:', error);
                }
            }
        }
        
        function drawMinimalChildScanningInterface() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scanSize = Math.min(canvas.width, canvas.height) * 0.5;
            
            const cornerLength = 25;
            const cornerThickness = 2;
            
            canvasContext.strokeStyle = '#FF9500';
            canvasContext.lineWidth = cornerThickness;
            canvasContext.lineCap = 'round';
            
            const x1 = centerX - scanSize/2;
            const y1 = centerY - scanSize/2;
            const x2 = centerX + scanSize/2;
            const y2 = centerY + scanSize/2;
            
            canvasContext.beginPath();
            // Top-left
            canvasContext.moveTo(x1, y1 + cornerLength);
            canvasContext.lineTo(x1, y1);
            canvasContext.lineTo(x1 + cornerLength, y1);
            // Top-right
            canvasContext.moveTo(x2 - cornerLength, y1);
            canvasContext.lineTo(x2, y1);
            canvasContext.lineTo(x2, y1 + cornerLength);
            // Bottom-left
            canvasContext.moveTo(x1, y2 - cornerLength);
            canvasContext.lineTo(x1, y2);
            canvasContext.lineTo(x1 + cornerLength, y2);
            // Bottom-right
            canvasContext.moveTo(x2 - cornerLength, y2);
            canvasContext.lineTo(x2, y2);
            canvasContext.lineTo(x2, y2 - cornerLength);
            canvasContext.stroke();
        }
        
        function drawInstantChildDetectionHighlight(code, offsetX, offsetY) {
            if (!code.location) return;
            
            canvasContext.strokeStyle = '#FF6B35';
            canvasContext.lineWidth = 3;
            canvasContext.fillStyle = 'rgba(255, 107, 53, 0.2)';
            
            canvasContext.beginPath();
            canvasContext.moveTo(code.location.topLeftCorner.x + offsetX, code.location.topLeftCorner.y + offsetY);
            canvasContext.lineTo(code.location.topRightCorner.x + offsetX, code.location.topRightCorner.y + offsetY);
            canvasContext.lineTo(code.location.bottomRightCorner.x + offsetX, code.location.bottomRightCorner.y + offsetY);
            canvasContext.lineTo(code.location.bottomLeftCorner.x + offsetX, code.location.bottomLeftCorner.y + offsetY);
            canvasContext.closePath();
            canvasContext.fill();
            canvasContext.stroke();
        }
        
        function drawChildScanningInterface() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scanSize = Math.min(canvas.width, canvas.height) * 0.5;
            
            // REMOVED: Black overlay that was blocking camera view
            // Only draw corner guides without interfering with camera feed
            
            const cornerLength = scanSize * 0.12;
            const cornerThickness = 3;
            const cornerOffset = 6;
            
            canvasContext.strokeStyle = '#FF9500'; // Orange for child bags
            canvasContext.lineWidth = cornerThickness;
            canvasContext.lineCap = 'round';
            canvasContext.shadowColor = 'rgba(0, 0, 0, 0.8)';
            canvasContext.shadowBlur = 3;
            
            // Draw corner brackets only
            const corners = [
                [centerX - scanSize/2 - cornerOffset, centerY - scanSize/2 - cornerOffset], // top-left
                [centerX + scanSize/2 + cornerOffset, centerY - scanSize/2 - cornerOffset], // top-right
                [centerX - scanSize/2 - cornerOffset, centerY + scanSize/2 + cornerOffset], // bottom-left
                [centerX + scanSize/2 + cornerOffset, centerY + scanSize/2 + cornerOffset]  // bottom-right
            ];
            
            corners.forEach((corner, i) => {
                canvasContext.beginPath();
                switch(i) {
                    case 0: // top-left
                        canvasContext.moveTo(corner[0], corner[1] + cornerLength);
                        canvasContext.lineTo(corner[0], corner[1]);
                        canvasContext.lineTo(corner[0] + cornerLength, corner[1]);
                        break;
                    case 1: // top-right
                        canvasContext.moveTo(corner[0] - cornerLength, corner[1]);
                        canvasContext.lineTo(corner[0], corner[1]);
                        canvasContext.lineTo(corner[0], corner[1] + cornerLength);
                        break;
                    case 2: // bottom-left
                        canvasContext.moveTo(corner[0], corner[1] - cornerLength);
                        canvasContext.lineTo(corner[0], corner[1]);
                        canvasContext.lineTo(corner[0] + cornerLength, corner[1]);
                        break;
                    case 3: // bottom-right
                        canvasContext.moveTo(corner[0] - cornerLength, corner[1]);
                        canvasContext.lineTo(corner[0], corner[1]);
                        canvasContext.lineTo(corner[0], corner[1] - cornerLength);
                        break;
                }
                canvasContext.stroke();
            });
            
            // Reset shadow
            canvasContext.shadowColor = 'transparent';
            canvasContext.shadowBlur = 0;
            
            // Simple scanning line
            const time = Date.now();
            const lineY = centerY - scanSize/2 + ((time % 1500) / 1500) * scanSize;
            
            canvasContext.strokeStyle = '#FF9500';
            canvasContext.lineWidth = 2;
            canvasContext.globalAlpha = 0.8;
            canvasContext.beginPath();
            canvasContext.moveTo(centerX - scanSize/2, lineY);
            canvasContext.lineTo(centerX + scanSize/2, lineY);
            canvasContext.stroke();
            canvasContext.globalAlpha = 1.0;
        }
        
        function drawDetectedChildQRCode(code) {
            if (!code.location) return;
            
            // Apple-style detection highlight for child bags
            canvasContext.strokeStyle = '#FF6B35'; // Orange-red for child detection
            canvasContext.lineWidth = 4;
            canvasContext.lineCap = 'round';
            canvasContext.lineJoin = 'round';
            
            // Draw detection border
            canvasContext.beginPath();
            canvasContext.moveTo(code.location.topLeftCorner.x, code.location.topLeftCorner.y);
            canvasContext.lineTo(code.location.topRightCorner.x, code.location.topRightCorner.y);
            canvasContext.lineTo(code.location.bottomRightCorner.x, code.location.bottomRightCorner.y);
            canvasContext.lineTo(code.location.bottomLeftCorner.x, code.location.bottomLeftCorner.y);
            canvasContext.closePath();
            canvasContext.stroke();
            
            // Corner highlights
            const corners = [
                code.location.topLeftCorner,
                code.location.topRightCorner,
                code.location.bottomRightCorner,
                code.location.bottomLeftCorner
            ];
            
            canvasContext.fillStyle = '#FF6B35';
            corners.forEach(corner => {
                canvasContext.beginPath();
                canvasContext.arc(corner.x, corner.y, 5, 0, 2 * Math.PI);
                canvasContext.fill();
            });
        }
        
        let childProcessingRequest = false; // Prevent duplicate requests
        
        function processQrCodeInstant(qrCode) {
            // Prevent duplicate processing
            if (childProcessingRequest) {
                console.log('Already processing child request, ignoring duplicate');
                return;
            }
            
            qrCode = qrCode.trim();
            if (!qrCode) {
                resultContainer.className = 'alert alert-warning';
                resultContainer.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Please provide a valid QR code.';
                return;
            }
            
            // Set processing flag immediately
            childProcessingRequest = true;
            
            // Display instant feedback
            const manualQrInput = document.getElementById('manual-qr-code');
            manualQrInput.value = qrCode;
            
            resultContainer.className = 'alert alert-info';
            resultContainer.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing child bag...';
            
            // Send optimized request
            fetch('/scan/child?s={{ request.args.get("s") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest' // Mark as AJAX for faster processing
                },
                body: 'qr_code=' + encodeURIComponent(qrCode) + '&csrf_token={{ csrf_token() }}'
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Instant success feedback
                    resultContainer.className = 'alert alert-success';
                    resultContainer.innerHTML = '<i class="fas fa-check-circle me-2"></i>Child bag linked!';
                    
                    // Quick haptic feedback
                    if (navigator.vibrate) {
                        navigator.vibrate(30);
                    }
                    
                    // Add to the scanned list instantly
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    listItem.dataset.qrCode = data.child_qr;
                    listItem.innerHTML = `
                        <div>
                            <span class="badge bg-success me-2">Child</span>
                            <span class="fw-bold">${data.child_qr}</span>
                        </div>
                        <div>
                            <span class="badge bg-primary rounded-pill me-2">
                                <i class="fas fa-link me-1"></i>Linked
                            </span>
                            <button class="btn btn-sm btn-outline-danger delete-bag" data-qr="${data.child_qr}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    scannedList.prepend(listItem);
                    
                    // Update progress counter
                    scannedCount = data.scanned_count || scannedCount + 1;
                    document.getElementById('progress-text').textContent = scannedCount;
                    
                    // Progress bar removed - unlimited child bags allowed
                    
                    // Clear manual input
                    manualQrInput.value = '';
                    
                    // Reset flags for next scan
                    childProcessingRequest = false;
                    setTimeout(() => {
                        lastDetectedCode = null;
                    }, 200); // Very quick reset
                } else {
                    childProcessingRequest = false; // Reset flag on error
                    // Show error message
                    resultContainer.className = 'alert alert-danger';
                    resultContainer.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <div>
                                <strong>Error:</strong> ${data.message}
                                <br><small>QR Code: ${qrCode}</small>
                            </div>
                        </div>
                    `;
                    
                    // Reset last detected code after a short delay
                    setTimeout(() => {
                        lastDetectedCode = null;
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultContainer.className = 'alert alert-danger';
                resultContainer.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <div>
                            <strong>Network Error:</strong> Could not process QR code.
                            <br><small>Please check your connection and try again.</small>
                        </div>
                    </div>
                `;
                
                // Reset last detected code
                setTimeout(() => {
                    lastDetectedCode = null;
                }, 3000);
            });
        }
        
        // Removed strict formatting function since we're accepting all QR formats now
        
        function loadScannedBags() {
            // Load existing scanned child bags from the current session
            fetch('/api/scanned-children?s={{ request.args.get("s") }}')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.children) {
                        data.children.forEach(child => {
                            addScannedBagToList(child.qr_id);
                        });
                        scannedCount = data.children.length;
                        document.getElementById('progress-text').textContent = scannedCount;
                    }
                })
                .catch(error => {
                    console.log('No existing scanned bags to load');
                });
        }

        function addScannedBagToList(qrCode) {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            listItem.dataset.qrCode = qrCode;
            listItem.innerHTML = `
                <div>
                    <span class="badge bg-success me-2">Child</span>
                    <span>${qrCode}</span>
                </div>
                <div>
                    <span class="badge bg-primary rounded-pill me-2">
                        <i class="fas fa-link me-1"></i>Linked
                    </span>
                    <button class="btn btn-sm btn-outline-danger delete-bag" data-qr="${qrCode}" title="Delete this scan">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            scannedList.prepend(listItem);
        }

        // Handle delete button clicks using event delegation
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-bag') || e.target.parentElement.classList.contains('delete-bag')) {
                const button = e.target.classList.contains('delete-bag') ? e.target : e.target.parentElement;
                const qrCode = button.dataset.qr;
                
                if (confirm(`Are you sure you want to delete the scan for ${qrCode}?`)) {
                    // Send delete request to server
                    fetch('/api/delete-child-scan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `qr_code=${encodeURIComponent(qrCode)}&csrf_token={{ csrf_token() }}&s={{ request.args.get("s") }}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Remove from UI
                            const listItem = document.querySelector(`[data-qr-code="${qrCode}"]`);
                            if (listItem) {
                                listItem.remove();
                                scannedCount--;
                                document.getElementById('progress-text').textContent = scannedCount;
                            }
                            
                            resultContainer.className = 'alert alert-info';
                            resultContainer.innerHTML = '<i class="fas fa-info-circle me-2"></i>Scan deleted successfully.';
                        } else {
                            resultContainer.className = 'alert alert-danger';
                            resultContainer.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>' + data.message;
                        }
                    })
                    .catch(error => {
                        resultContainer.className = 'alert alert-danger';
                        resultContainer.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Error deleting scan.';
                    });
                }
            }
        });
    });
</script>
{% endblock %}