{% extends "layout.html" %}

{% block title %}Scan Child Bags{% endblock %}

{% block content %}
<div class="container-fluid px-2 py-2">
    <!-- Parent Bag Info Header -->
    {% if parent_bag %}
    <div class="card mb-3 border-success">
        <div class="card-body py-2">
            <h6 class="card-title mb-1 text-success">
                <i class="fas fa-cube me-2"></i>Parent Bag Selected
            </h6>
            <p class="mb-0">
                <code class="text-primary">{{ parent_bag.qr_code }}</code>
                <small class="text-muted ms-2">#{{ parent_bag.id }}</small>
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Scanner Section -->
    <div class="card mb-3">
        <div class="card-header py-2">
            <h6 class="mb-0">
                <i class="fas fa-qrcode me-2"></i>Child Bag Scanner
                <span class="badge bg-primary ms-2" id="progress-text">{{ scanned_child_count }}</span>
                <small class="text-muted ms-1">scanned</small>
            </h6>
        </div>
        <div class="card-body p-0 position-relative">
            <!-- Video and Canvas -->
            <video id="video" class="w-100" style="display: none;" autoplay playsinline muted></video>
            <canvas id="canvas" class="w-100 bg-dark" style="min-height: 250px;"></canvas>
            
            <!-- Scanner Overlay -->
            <div id="scanner-overlay" class="position-absolute top-0 start-0 w-100 h-100 d-none justify-content-center align-items-center" style="background: rgba(0,0,0,0.3); z-index: 10;">
                <div class="text-center text-white">
                    <i class="fas fa-qrcode fa-2x mb-2"></i>
                    <div>Position QR code in frame</div>
                </div>
            </div>
        </div>
        <div class="card-footer py-2">
            <div class="row">
                <div class="col-6">
                    <button id="start-camera" class="btn btn-success btn-sm w-100">
                        <i class="fas fa-camera me-1"></i>Start
                    </button>
                </div>
                <div class="col-6">
                    <button id="stop-camera" class="btn btn-secondary btn-sm w-100" disabled>
                        <i class="fas fa-stop me-1"></i>Stop
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Container -->
    <div id="result-container" class="alert" style="display: none;"></div>

    <!-- Manual Entry -->
    <div class="card mb-3">
        <div class="card-header py-2">
            <h6 class="mb-0">
                <i class="fas fa-keyboard me-2"></i>Manual Entry
            </h6>
        </div>
        <div class="card-body py-2">
            <form id="manual-entry-form">
                <div class="input-group input-group-sm">
                    <input type="text" id="manual-qr-code" class="form-control" placeholder="Enter QR code manually" autocomplete="off">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Add
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scanned Bags List -->
    {% if scanned_children %}
    <div class="card mb-3">
        <div class="card-header py-2">
            <h6 class="mb-0">
                <i class="fas fa-list me-2"></i>Scanned Child Bags
            </h6>
        </div>
        <div class="card-body p-0">
            <div id="scanned-list" class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="row">
        <div class="col-6">
            <button onclick="changeParent()" class="btn btn-outline-primary btn-sm w-100">
                <i class="fas fa-exchange-alt me-1"></i>Change Parent
            </button>
        </div>
        <div class="col-6">
            <button onclick="completeScan()" class="btn btn-success btn-sm w-100">
                <i class="fas fa-check me-1"></i>Complete
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="{{ url_for('static', filename='js/qr-scanner.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Child scanner with universal QR scanner starting...');
    
    const hasParentBag = {{ 'true' if parent_bag else 'false' }};
    const progressText = document.getElementById('progress-text');
    let scannedCount = {{ scanned_child_count }};
    let processingRequest = false;
    
    // Child-specific QR handler
    function handleChildQR(qrData) {
        if (processingRequest) {
            console.log('Request already in progress, skipping...');
            return;
        }
        
        processingRequest = true;
        console.log('Processing child QR code:', qrData);
        
        // Send QR code to server
        fetch('{{ url_for("scan_child") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: new URLSearchParams({
                'qr_code': qrData,
                'csrf_token': '{{ csrf_token() }}'
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Server response:', data);
            
            if (data.status === 'success') {
                const resultContainer = document.getElementById('result-container');
                resultContainer.className = 'alert alert-success';
                resultContainer.innerHTML = '<i class="fas fa-check-circle me-2"></i>' + data.message;
                resultContainer.style.display = 'block';
                
                // Update count and refresh list
                scannedCount++;
                progressText.textContent = scannedCount;
                
                // Add to scanned list
                addToScannedList(qrData, data.child_bag_id);
                
                // Flash success effect
                document.body.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    document.body.style.backgroundColor = '';
                }, 200);
                
            } else {
                // Show error message
                const resultContainer = document.getElementById('result-container');
                resultContainer.className = 'alert alert-warning';
                resultContainer.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + data.message;
                resultContainer.style.display = 'block';
            }
            
            // Resume scanning after short delay
            setTimeout(() => {
                processingRequest = false;
                if (window.qrScanner) {
                    window.qrScanner.resumeScanning();
                }
            }, 1500);
            
        })
        .catch(error => {
            console.error('Network error:', error);
            const resultContainer = document.getElementById('result-container');
            resultContainer.className = 'alert alert-danger';
            resultContainer.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Connection error. Please check your network.';
            resultContainer.style.display = 'block';
            
            // Resume scanning
            setTimeout(() => {
                processingRequest = false;
                if (window.qrScanner) {
                    window.qrScanner.resumeScanning();
                }
            }, 2000);
        });
    }
    
    // Initialize universal QR scanner
    if (!hasParentBag) {
        const resultContainer = document.getElementById('result-container');
        resultContainer.className = 'alert alert-warning';
        resultContainer.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>No parent bag selected. <a href="{{ url_for("scan_parent", s=request.args.get("s")) }}" class="btn btn-sm btn-primary ms-2">Scan Parent</a>';
        resultContainer.style.display = 'block';
    } else {
        // Create QR scanner with child-specific handler
        window.qrScanner = new QRScanner({
            onQRDetected: handleChildQR,
            scannerType: 'child'
        });
        
        // Auto-start camera
        window.qrScanner.autoStart(500);
        loadScannedBags();
    }
    
    // Load already scanned child bags
    function loadScannedBags() {
        const scannedList = document.getElementById('scanned-list');
        if (scannedList) {
            scannedList.innerHTML = '';
            
            {% for child_bag in scanned_children %}
            addToScannedList('{{ child_bag.qr_code }}', {{ child_bag.id }});
            {% endfor %}
        }
    }
    
    function addToScannedList(qrCode, bagId) {
        const scannedList = document.getElementById('scanned-list');
        if (!scannedList) return;
        
        const listItem = document.createElement('div');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
        listItem.innerHTML = `
            <div>
                <i class="fas fa-cube text-success me-2"></i>
                <small class="text-muted">Child:</small> <code class="text-primary">${qrCode}</code>
            </div>
            <small class="text-muted">#${bagId}</small>
        `;
        scannedList.appendChild(listItem);
        
        // Scroll to bottom
        scannedList.scrollTop = scannedList.scrollHeight;
        
        // Update count
        scannedCount = scannedList.children.length;
        progressText.textContent = scannedCount;
    }
    
    // Manual entry
    function submitManualCode() {
        const manualInput = document.getElementById('manual-qr-code');
        const qrCode = manualInput.value.trim();
        
        if (qrCode) {
            handleChildQR(qrCode);
            manualInput.value = '';
        }
    }
    
    // Global action button functions
    window.changeParent = function() {
        if (confirm('Switch to a different parent bag? This will end the current scanning session.')) {
            window.location.href = '{{ url_for("scan_parent", s=request.args.get("s")) }}';
        }
    }
    
    window.completeScan = function() {
        if (confirm('Complete scanning session and view summary?')) {
            window.location.href = '{{ url_for("scan_complete") }}';
        }
    }
    
    // Initialize manual entry form
    const manualForm = document.getElementById('manual-entry-form');
    if (manualForm) {
        manualForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitManualCode();
        });
    }
});
</script>
{% endblock %}