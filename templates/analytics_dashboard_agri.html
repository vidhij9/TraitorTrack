{% extends "layout.html" %}

{% block title %}Analytics Dashboard - TraceTrack{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* Agricultural Theme Colors */
    :root {
        --agri-green: #2d5016;
        --agri-light-green: #4a7c59;
        --agri-gold: #DAA520;
        --soil-brown: #8B4513;
        --harvest-orange: #FF8C00;
        --sky-blue: #87CEEB;
        --field-yellow: #FFD700;
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .analytics-container {
        padding: 1rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Header with Agricultural Theme */
    .dashboard-header {
        background: linear-gradient(135deg, var(--agri-green) 0%, var(--agri-light-green) 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }

    .dashboard-header::before {
        content: "🌾";
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 3rem;
        opacity: 0.3;
    }

    .dashboard-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .dashboard-subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-top: 0.25rem;
    }

    /* Enhanced Tab Navigation */
    .tab-navigation {
        display: flex;
        background: white;
        border-radius: 1rem;
        padding: 0.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        gap: 0.5rem;
    }

    .tab-btn {
        flex: 1;
        padding: 0.75rem 1rem;
        border: none;
        background: transparent;
        color: var(--agri-green);
        font-weight: 600;
        font-size: 0.9rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .tab-btn:hover {
        background: rgba(45, 80, 22, 0.1);
    }

    .tab-btn.active {
        background: linear-gradient(135deg, var(--agri-green) 0%, var(--agri-light-green) 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(45, 80, 22, 0.3);
    }

    .tab-icon {
        font-size: 1.1rem;
    }

    .tab-content {
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .tab-content.active {
        display: block;
        opacity: 1;
        animation: slideIn 0.4s ease-out;
    }

    @keyframes slideIn {
        from { 
            opacity: 0; 
            transform: translateY(20px); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0); 
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* System Health Indicator */
    .health-indicator {
        background: white;
        border-radius: 1rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-left: 4px solid;
    }

    .health-indicator.healthy { border-left-color: var(--agri-light-green); }
    .health-indicator.warning { border-left-color: var(--harvest-orange); }
    .health-indicator.critical { border-left-color: #dc3545; }

    .health-status {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .health-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .health-icon.healthy { 
        background: rgba(74, 124, 89, 0.1); 
        color: var(--agri-light-green);
    }
    .health-icon.warning { 
        background: rgba(255, 140, 0, 0.1); 
        color: var(--harvest-orange);
    }
    .health-icon.critical { 
        background: rgba(220, 53, 69, 0.1); 
        color: #dc3545;
    }

    .health-details {
        flex: 1;
    }

    .health-title {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.95rem;
    }

    .health-message {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .health-metrics {
        display: flex;
        gap: 1.5rem;
        font-size: 0.85rem;
    }

    .health-metric {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        color: #495057;
    }

    .health-metric-value {
        font-weight: 600;
        color: var(--agri-green);
    }

    /* Metrics Cards Grid */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.25rem;
        margin-bottom: 1.5rem;
    }

    .metric-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.12);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1), 0 6px 6px rgba(0,0,0,0.1);
        border-color: var(--agri-light-green);
    }

    .metric-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--agri-green) 0%, var(--agri-light-green) 50%, var(--agri-gold) 100%);
    }

    .metric-card.warning::before { 
        background: linear-gradient(135deg, var(--harvest-orange) 0%, var(--field-yellow) 100%); 
    }
    .metric-card.critical::before { 
        background: linear-gradient(135deg, #dc3545 0%, #ff6b6b 100%); 
    }

    .metric-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }

    .metric-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        background: linear-gradient(135deg, rgba(45, 80, 22, 0.1) 0%, rgba(74, 124, 89, 0.1) 100%);
    }

    .metric-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .metric-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #2c3e50;
        line-height: 1;
        margin: 0.5rem 0;
    }

    .metric-change {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.85rem;
        color: var(--agri-light-green);
    }

    .metric-change.negative {
        color: #dc3545;
    }

    .metric-trend {
        font-size: 0.9rem;
    }

    /* Charts Section */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .chart-container {
        background: white;
        border-radius: 0.75rem;
        padding: 1.25rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .chart-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chart-canvas {
        height: 200px;
        position: relative;
    }

    /* Alerts Section */
    .alerts-container {
        background: white;
        border-radius: 0.75rem;
        padding: 1.25rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        max-height: 400px;
        overflow-y: auto;
    }

    .alerts-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .alerts-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .alert-item {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        border-radius: 0.5rem;
        border-left: 3px solid;
        background: #f8f9fa;
        transition: all 0.3s;
        cursor: pointer;
    }

    .alert-item:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .alert-item.info {
        border-left-color: var(--sky-blue);
        background: rgba(135, 206, 235, 0.1);
    }

    .alert-item.warning {
        border-left-color: var(--harvest-orange);
        background: rgba(255, 140, 0, 0.1);
    }

    .alert-item.critical {
        border-left-color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
    }

    .alert-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.25rem;
    }

    .alert-title {
        font-weight: 600;
        font-size: 0.9rem;
        color: #2c3e50;
    }

    .alert-time {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .alert-message {
        font-size: 0.85rem;
        color: #495057;
        line-height: 1.4;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .dashboard-title { font-size: 1.4rem; }
        .metrics-grid { grid-template-columns: 1fr; }
        .charts-grid { grid-template-columns: 1fr; }
        .health-metrics { flex-direction: column; gap: 0.5rem; }
        .tab-btn { font-size: 0.8rem; padding: 0.6rem; }
        .tab-icon { display: none; }
    }

    /* Loading Spinner */
    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(45, 80, 22, 0.3);
        border-radius: 50%;
        border-top-color: var(--agri-green);
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Refresh Button */
    .refresh-fab {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--agri-green) 0%, var(--agri-light-green) 100%);
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(45, 80, 22, 0.3);
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        z-index: 1000;
    }

    .refresh-fab:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(45, 80, 22, 0.4);
    }

    .refresh-fab.spinning {
        animation: spin 1s linear infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <span>🌱</span>
            Analytics Dashboard
        </h1>
        <p class="dashboard-subtitle">Real-time monitoring and insights for your agricultural supply chain</p>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-btn active" onclick="switchTab(event, 'overview')">
            <span class="tab-icon">📊</span>
            Overview
        </button>
        <button class="tab-btn" onclick="switchTab(event, 'performance')">
            <span class="tab-icon">⚡</span>
            Performance
        </button>
        <button class="tab-btn" onclick="switchTab(event, 'alerts')">
            <span class="tab-icon">🔔</span>
            Alerts
        </button>
        <button class="tab-btn" onclick="switchTab(event, 'reports')">
            <span class="tab-icon">📈</span>
            Reports
        </button>
    </div>

    <!-- System Health Indicator -->
    <div class="health-indicator {{ 'healthy' if not analytics or analytics.real_time.system_health == 'healthy' else analytics.real_time.system_health }}">
        <div class="health-status">
            <div class="health-icon {{ 'healthy' if not analytics or analytics.real_time.system_health == 'healthy' else analytics.real_time.system_health }}">
                {% if not analytics or analytics.real_time.system_health == 'healthy' %}
                    ✓
                {% elif analytics.real_time.system_health == 'warning' %}
                    ⚠
                {% else %}
                    ✕
                {% endif %}
            </div>
            <div class="health-details">
                <div class="health-title">System Status</div>
                <div class="health-message">
                    {% if not analytics or analytics.real_time.system_health == 'healthy' %}
                        All systems operational
                    {% elif analytics.real_time.system_health == 'warning' %}
                        Performance degradation detected
                    {% else %}
                        Critical issues require attention
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="health-metrics">
            <div class="health-metric">
                <span>Active Users:</span>
                <span class="health-metric-value">{{ analytics.real_time.active_users if analytics else 0 }}</span>
            </div>
            <div class="health-metric">
                <span>Requests/min:</span>
                <span class="health-metric-value">{{ analytics.real_time.current_rpm if analytics else 0 }}</span>
            </div>
            <div class="health-metric">
                <span>Uptime:</span>
                <span class="health-metric-value">99.9%</span>
            </div>
        </div>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
        <div class="metrics-grid">
            <!-- Total Bags Card -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-label">Total Bags</div>
                    <div class="metric-icon">🌾</div>
                </div>
                <div class="metric-value">{{ "{:,.0f}".format(business_metrics.total_bags if business_metrics else 0) }}</div>
                <div class="metric-change">
                    <span class="metric-trend">↑</span>
                    +{{ business_metrics.today_scans if business_metrics else 0 }} today
                </div>
            </div>

            <!-- Active Scans Card -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-label">Active Scans</div>
                    <div class="metric-icon">📱</div>
                </div>
                <div class="metric-value">{{ "{:,.0f}".format(business_metrics.today_scans if business_metrics else 0) }}</div>
                <div class="metric-change">
                    <span class="metric-trend">↑</span>
                    12% increase from yesterday
                </div>
            </div>

            <!-- Users Online Card -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-label">Users Online</div>
                    <div class="metric-icon">👥</div>
                </div>
                <div class="metric-value">{{ analytics.real_time.active_users if analytics else 0 }}</div>
                <div class="metric-change">
                    <span class="metric-trend">●</span>
                    Active now
                </div>
            </div>

            <!-- System Load Card -->
            <div class="metric-card {{ 'warning' if system_metrics and system_metrics.system.cpu_percent > 70 else '' }}">
                <div class="metric-header">
                    <div class="metric-label">System Load</div>
                    <div class="metric-icon">💻</div>
                </div>
                <div class="metric-value">{{ "%.0f"|format(system_metrics.system.cpu_percent if system_metrics else 0) }}%</div>
                <div class="metric-change">
                    <span class="metric-trend">⚡</span>
                    CPU utilization
                </div>
            </div>

            <!-- Database Connections Card -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-label">Database</div>
                    <div class="metric-icon">🗄️</div>
                </div>
                <div class="metric-value">{{ db_health.connection_count if db_health else 0 }}</div>
                <div class="metric-change">
                    <span class="metric-trend">●</span>
                    Active connections
                </div>
            </div>

            <!-- Response Time Card -->
            <div class="metric-card {{ 'warning' if analytics and analytics.performance and analytics.performance.avg_response_time > 500 else '' }}">
                <div class="metric-header">
                    <div class="metric-label">Response Time</div>
                    <div class="metric-icon">⏱️</div>
                </div>
                <div class="metric-value">{{ "%.0f"|format(85) }}ms</div>
                <div class="metric-change">
                    <span class="metric-trend">↓</span>
                    5% faster than average
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Tab -->
    <div id="performance" class="tab-content">
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <span>📊</span>
                        System Performance
                    </h3>
                </div>
                <div class="chart-canvas">
                    <canvas id="perfChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <span>📈</span>
                        Scan Activity
                    </h3>
                </div>
                <div class="chart-canvas">
                    <canvas id="scanChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <span>⚡</span>
                        Response Times
                    </h3>
                </div>
                <div class="chart-canvas">
                    <canvas id="responseChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <span>🌾</span>
                        Bag Distribution
                    </h3>
                </div>
                <div class="chart-canvas">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Tab -->
    <div id="alerts" class="tab-content">
        <div class="alerts-container">
            <div class="alerts-header">
                <h3 class="alerts-title">
                    <span>🔔</span>
                    Recent Alerts & Notifications
                </h3>
                <button class="btn btn-sm btn-outline-success" onclick="clearAlerts()">Clear All</button>
            </div>
            
            {% if analytics and analytics.alerts %}
                {% for alert in analytics.alerts[:10] %}
                <div class="alert-item {{ alert.severity }}" onclick="viewAlert('{{ alert.id }}')">
                    <div class="alert-header">
                        <span class="alert-title">{{ alert.title }}</span>
                        <span class="alert-time">{{ alert.timestamp.strftime('%H:%M') if alert.timestamp else 'Now' }}</span>
                    </div>
                    <div class="alert-message">{{ alert.message }}</div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert-item info">
                    <div class="alert-header">
                        <span class="alert-title">All Systems Normal</span>
                        <span class="alert-time">Now</span>
                    </div>
                    <div class="alert-message">No active alerts at this time. All systems are operating normally.</div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Reports Tab -->
    <div id="reports" class="tab-content">
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <span>📊</span>
                        Weekly Overview
                    </h3>
                </div>
                <div class="chart-canvas">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <span>🌱</span>
                        Growth Metrics
                    </h3>
                </div>
                <div class="chart-canvas">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="refresh-fab" onclick="refreshData()" title="Refresh Dashboard">
        ↻
    </button>
</div>

<script>
// Tab switching with animation
function switchTab(event, tabName) {
    // Prevent default if event exists
    if (event) {
        event.preventDefault();
    }
    
    // Hide all tabs with fade out
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
        tab.style.display = 'none';
    });
    
    // Remove active from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab with fade in
    const selectedTab = document.getElementById(tabName);
    if (selectedTab) {
        setTimeout(() => {
            selectedTab.style.display = 'block';
            setTimeout(() => {
                selectedTab.classList.add('active');
            }, 10);
        }, 10);
    }
    
    // Mark the clicked button as active
    if (event && event.target) {
        let button = event.target;
        // Find the button element if clicked on icon or text
        while (button && !button.classList.contains('tab-btn')) {
            button = button.parentElement;
        }
        if (button) {
            button.classList.add('active');
        }
    }
    
    // Initialize charts if performance or reports tab
    if ((tabName === 'performance' || tabName === 'reports') && !window.chartsInitialized[tabName]) {
        setTimeout(() => initCharts(tabName), 200);
        window.chartsInitialized[tabName] = true;
    }
}

// Initialize charts storage
window.chartsInitialized = {};

// Initialize charts for different tabs
function initCharts(tabName) {
    if (tabName === 'performance') {
        initPerformanceCharts();
    } else if (tabName === 'reports') {
        initReportCharts();
    }
}

// Performance Charts
function initPerformanceCharts() {
    // System Performance Chart
    const perfCtx = document.getElementById('perfChart');
    if (perfCtx) {
        new Chart(perfCtx, {
            type: 'line',
            data: {
                labels: ['1h ago', '45m', '30m', '15m', 'Now'],
                datasets: [{
                    label: 'CPU Usage',
                    data: [45, 52, 48, 55, {{ system_metrics.system.cpu_percent if system_metrics else 50 }}],
                    borderColor: '#2d5016',
                    backgroundColor: 'rgba(45, 80, 22, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Memory Usage',
                    data: [60, 62, 65, 68, {{ system_metrics.system.memory_percent if system_metrics else 60 }}],
                    borderColor: '#DAA520',
                    backgroundColor: 'rgba(218, 165, 32, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Scan Activity Chart
    const scanCtx = document.getElementById('scanChart');
    if (scanCtx) {
        new Chart(scanCtx, {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Today'],
                datasets: [{
                    label: 'Scans',
                    data: [850, 920, 1100, 980, 1250, 780, {{ business_metrics.today_scans if business_metrics else 0 }}],
                    backgroundColor: 'rgba(74, 124, 89, 0.8)',
                    borderColor: '#4a7c59',
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Response Time Chart
    const responseCtx = document.getElementById('responseChart');
    if (responseCtx) {
        new Chart(responseCtx, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', 'Now'],
                datasets: [{
                    label: 'Response Time (ms)',
                    data: [82, 78, 85, 92, 88, 90, 85],
                    borderColor: '#FF8C00',
                    backgroundColor: 'rgba(255, 140, 0, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    }
                }
            }
        });
    }

    // Distribution Chart
    const distCtx = document.getElementById('distributionChart');
    if (distCtx) {
        new Chart(distCtx, {
            type: 'doughnut',
            data: {
                labels: ['Parent Bags', 'Child Bags', 'Unlinked'],
                datasets: [{
                    data: [30, 65, 5],
                    backgroundColor: [
                        '#2d5016',
                        '#4a7c59',
                        '#DAA520'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 11 }
                        }
                    }
                }
            }
        });
    }
}

// Report Charts
function initReportCharts() {
    // Weekly Chart
    const weeklyCtx = document.getElementById('weeklyChart');
    if (weeklyCtx) {
        new Chart(weeklyCtx, {
            type: 'line',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Bags Processed',
                    data: [4500, 5200, 4800, 5500],
                    borderColor: '#2d5016',
                    backgroundColor: 'rgba(45, 80, 22, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Growth Chart
    const growthCtx = document.getElementById('growthChart');
    if (growthCtx) {
        new Chart(growthCtx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Growth Rate (%)',
                    data: [12, 15, 18, 22, 25, 28],
                    backgroundColor: 'rgba(218, 165, 32, 0.8)',
                    borderColor: '#DAA520',
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
}

// Refresh data
function refreshData() {
    const btn = document.querySelector('.refresh-fab');
    btn.classList.add('spinning');
    
    fetch('/analytics/api/metrics/realtime')
        .then(response => response.json())
        .then(data => {
            // Update UI with new data
            console.log('Data refreshed:', data);
            setTimeout(() => {
                btn.classList.remove('spinning');
            }, 1000);
        })
        .catch(error => {
            console.error('Refresh failed:', error);
            btn.classList.remove('spinning');
        });
}

// View alert details
function viewAlert(alertId) {
    console.log('Viewing alert:', alertId);
    // Implementation for viewing alert details
}

// Clear all alerts
function clearAlerts() {
    if (confirm('Are you sure you want to clear all alerts?')) {
        console.log('Clearing alerts');
        // Implementation for clearing alerts
    }
}

// Auto-refresh every 60 seconds
setInterval(refreshData, 60000);

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Ensure Overview tab is active on load
    const overviewTab = document.getElementById('overview');
    if (overviewTab) {
        overviewTab.style.display = 'block';
        overviewTab.style.opacity = '1';
        overviewTab.classList.add('active');
    }
    
    // Initialize any visible charts
    const activeTabBtn = document.querySelector('.tab-btn.active');
    if (activeTabBtn && activeTabBtn.textContent.includes('Overview')) {
        // Overview tab is active, no charts to init
    }
});
</script>
{% endblock %}