{% extends "warehouse_layout.html" %}
{% block title %}Link Parent Bags to Bill - TraitorTrack{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
/* Mobile-first compact styles */
.scanner-input-container {
    background: linear-gradient(135deg, var(--wh-success) 0%, #20c997 100%);
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
}

.scanner-input-container h5 {
    font-size: 14px !important;
    margin-bottom: 8px !important;
}

.scanner-input-container .wh-scanner-input {
    font-size: 18px !important;
    padding: 10px !important;
    height: auto !important;
}

.bill-info-card {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 8px;
}

.bill-info-card h6 {
    font-size: 12px;
    margin-bottom: 2px;
}

.bill-info-card p {
    font-size: 14px;
    margin-bottom: 4px;
}

.linked-bags-list {
    max-height: 150px;
    overflow-y: auto;
}

.bag-item {
    padding: 6px 10px;
    font-size: 12px;
    border: 1px solid #dee2e6;
    margin-bottom: 4px;
    border-radius: 4px;
}

.bag-item .btn-sm {
    padding: 2px 6px;
    font-size: 10px;
}

/* Compact card */
.card-header {
    padding: 10px 12px !important;
}

.card-header h4 {
    font-size: 16px !important;
    margin-bottom: 0 !important;
}

.card-header small {
    font-size: 11px !important;
}

.card-body {
    padding: 10px !important;
}

/* Progress bar compact */
.progress {
    height: 18px !important;
}

.progress-bar span {
    font-size: 11px;
}

/* Weight tracking compact */
.weight-tracking {
    padding: 8px !important;
    margin-top: 8px !important;
}

.weight-tracking h6 {
    font-size: 12px !important;
    margin-bottom: 2px !important;
}

.weight-tracking .fs-3 {
    font-size: 20px !important;
}

.weight-tracking small {
    font-size: 10px !important;
}

/* Hide instructions on mobile for less scrolling */
@media (max-width: 768px) {
    .alert-info {
        display: none !important;
    }
    .alert-warning {
        padding: 6px 10px !important;
        font-size: 11px !important;
    }
    .container {
        padding-left: 8px !important;
        padding-right: 8px !important;
    }
    .mt-4 {
        margin-top: 8px !important;
    }
}

/* Status text compact */
#status-text {
    font-size: 13px !important;
}

.wh-icon-xl {
    font-size: 24px !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-file-invoice me-2"></i>Link Parent Bags to Bill
                    </h4>
                    <small>Using Coconut Wireless 2D Scanner</small>
                </div>
                <div class="card-body">
                    <!-- Bill Information -->
                    <div class="bill-info-card">
                        <div class="row">
                            <div class="col-md-12">
                                <h6><i class="fas fa-hashtag me-2"></i>Bill ID</h6>
                                <p class="mb-2"><strong>{{ bill.bill_id }}</strong></p>
                            </div>
                        </div>
                        
                        <!-- Progress Section -->
                        <div class="progress-wrapper">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><i class="fas fa-boxes me-2"></i>Linked Bags: <strong id="bag-count">{{ linked_bags|length }}</strong></span>
                                <span>Target: <strong id="target-count">{{ bill.parent_bag_count or 'Unlimited' }}</strong></span>
                            </div>
                            {% if bill.parent_bag_count %}
                            <div class="progress" style="height: 25px;">
                                <div id="progress-bar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: {{ (linked_bags|length / bill.parent_bag_count * 100)|round }}%">
                                    <span id="progress-text">{{ linked_bags|length }}/{{ bill.parent_bag_count }}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Weight Tracking Section - Only Current Weight -->
                        <div class="weight-tracking mt-3 p-3 rounded text-center" style="background: #d4edda; border: 1px solid #28a745;">
                            <h6 class="mb-1"><i class="fas fa-balance-scale me-1"></i>Current Weight</h6>
                            <p class="mb-0 fw-bold fs-3 text-success" id="current-weight">
                                {% set total_children = linked_bags|sum(attribute='child_count') if linked_bags else 0 %}
                                {{ total_children }} kg
                            </p>
                            <small class="text-muted">(1 kg per child bag)</small>
                        </div>
                    </div>

                    <!-- Scanner Input Section -->
                    <div class="scanner-input-container">
                        <div class="wh-text-center">
                            <i class="fas fa-qrcode wh-icon-xl wh-text-white wh-pulse wh-mb-md"></i>
                            <h5 class="wh-text-white wh-text-lg wh-mb-md">Point scanner at parent bag QR code and scan</h5>
                        </div>
                        
                        <input 
                            type="text" 
                            id="scanner-input" 
                            class="wh-scanner-input" 
                            placeholder="READY TO SCAN" 
                            autocomplete="off"
                            autofocus
                        >
                        
                        <div class="wh-text-center wh-mt-md">
                            <span id="status-text" class="wh-text-white wh-text-lg wh-text-bold">
                                <i class="fas fa-check-circle me-2"></i>Scanner ready - Scan parent bags
                            </span>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="alert alert-info mt-4">
                        <h6><i class="fas fa-info-circle me-2"></i>Two ways to enter QR codes:</h6>
                        
                        <div class="mb-3">
                            <strong><i class="fas fa-barcode me-2"></i>Option 1: Coconut Wireless Scanner (Recommended)</strong>
                            <ol class="mb-0 mt-1">
                                <li>Make sure the input field above is highlighted (click it if not)</li>
                                <li>Point your Coconut scanner at a parent bag QR code</li>
                                <li>Press the scan button on your scanner</li>
                                <li>The bag will be linked automatically!</li>
                                <li>Continue scanning until all parent bags are linked</li>
                            </ol>
                        </div>
                        
                        <div>
                            <strong><i class="fas fa-keyboard me-2"></i>Option 2: Manual Entry</strong>
                            <ol class="mb-0 mt-1">
                                <li>Click the input field above</li>
                                <li>Type the parent bag QR code (format: SB#####)</li>
                                <li>Press Enter to link to bill</li>
                            </ol>
                        </div>
                        
                        <div class="alert alert-warning mt-3 mb-0">
                            <small><i class="fas fa-exclamation-triangle me-2"></i><strong>Important:</strong> Parent bags must be created in Scan Management before linking to bills.</small>
                        </div>
                    </div>

                    <!-- Linked Bags List - Compact -->
                    <div id="linked-bags-section" class="mt-2">
                        <small class="text-success fw-bold"><i class="fas fa-check-circle me-1"></i>Linked Parent Bags</small>
                        <div id="bags-list" class="list-group linked-bags-list mt-1">
                            {% for bag in linked_bags %}
                            <div class="list-group-item d-flex justify-content-between align-items-center bag-item py-1 px-2">
                                <small>
                                    <i class="fas fa-check text-success me-1"></i>
                                    <strong>{{ bag.qr_id }}</strong>
                                    <span class="text-muted">({{ bag.child_count or 0 }})</span>
                                </small>
                                <button class="btn btn-outline-danger py-0 px-1" style="font-size:10px;" onclick="removeBag('{{ bag.qr_id }}', {{ bag.id }})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Actions - Compact for mobile -->
                    <div class="mt-3">
                        <div class="wh-alert wh-alert-success mb-2" id="success-message" style="display: none;">
                            <small><i class="fas fa-check-circle me-1"></i><span id="success-text">Linked!</span></small>
                        </div>
                        <div class="d-flex flex-column gap-2">
                            <button id="scan-next-btn" class="btn btn-primary btn-sm py-2" onclick="focusScanner()">
                                <i class="fas fa-qrcode me-1"></i>Scan Next Parent Bag
                            </button>
                            
                            {% set capacity_reached = linked_bags|length >= bill.parent_bag_count and bill.parent_bag_count > 0 %}
                            
                            <!-- Complete Bill button - in DOM but hidden until capacity reached -->
                            <button id="complete-bill-btn" class="btn btn-success btn-sm py-2" onclick="completeBill()"
                                    style="display: {{ 'block' if capacity_reached else 'none' }};">
                                <i class="fas fa-check-circle me-1"></i>Complete Bill
                            </button>
                            
                            <!-- Save & Continue - in DOM but shown only when capacity NOT reached -->
                            <button id="keep-progress-btn" class="btn btn-warning btn-sm py-2" onclick="keepInProgress()"
                                    style="display: {{ 'none' if capacity_reached else 'block' }};">
                                <i class="fas fa-clock me-1"></i>Save & Continue Later
                            </button>
                            <div id="capacity-info" class="text-center py-1" 
                                 style="display: {{ 'none' if capacity_reached else 'block' }};">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span id="remaining-count">{{ bill.parent_bag_count - linked_bags|length }}</span> more needed
                                </small>
                            </div>
                            
                            <a href="{{ url_for('bill_management') }}" class="btn btn-outline-secondary btn-sm py-2">
                                <i class="fas fa-arrow-left me-1"></i>Back to Bills
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for CSRF -->
<form id="csrf-form" style="display: none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>

<!-- Toast notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="scan-toast" class="toast align-items-center text-white border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toast-message">
                <i class="fas fa-check-circle me-2"></i>Message
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Helper function to get CSRF token
function getCSRFToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta) return meta.content;
    const input = document.querySelector('input[name="csrf_token"]');
    if (input) return input.value;
    return '';
}

// Helper function for fetch with CSRF
function fetchWithCSRF(url, options = {}) {
    const token = getCSRFToken();
    options.headers = options.headers || {};
    options.headers['X-CSRFToken'] = token;
    options.credentials = 'same-origin';
    return fetch(url, options);
}

// GLOBAL VARIABLES - accessible from onclick handlers
let scannerInput, statusText, bagsList, bagCount, progressBar, progressText;
let isProcessing = false;
let billId, targetCount, currentWeight, currentWeightEl;
let scannerTimeout = null;
let lastInputTime = 0;
const SCANNER_TIMEOUT_MS = 100; // Scanners type very fast, submit if no input for 100ms

document.addEventListener('DOMContentLoaded', function() {
    scannerInput = document.getElementById('scanner-input');
    statusText = document.getElementById('status-text');
    bagsList = document.getElementById('bags-list');
    bagCount = document.getElementById('bag-count');
    progressBar = document.getElementById('progress-bar');
    progressText = document.getElementById('progress-text');
    
    billId = {{ bill.id }};
    targetCount = {{ bill.parent_bag_count or 0 }};
    
    // Weight tracking variables
    currentWeight = {{ linked_bags|sum(attribute='child_count') if linked_bags else 0 }};
    currentWeightEl = document.getElementById('current-weight');
    
    // Update weight display
    function updateWeightDisplay(addedChildCount = 0) {
        // Update current weight (add child count if provided)
        currentWeight += addedChildCount;
        if (currentWeightEl) {
            currentWeightEl.textContent = `${currentWeight} kg`;
        }
    }
    
    function showToast(message, type = 'success') {
        const toast = document.getElementById('scan-toast');
        const toastMessage = document.getElementById('toast-message');
        
        toast.className = `toast align-items-center text-white border-0`;
        
        let bgClass = 'bg-success';
        let icon = 'check-circle';
        
        if (type === 'error' || type === 'danger') {
            bgClass = 'bg-danger';
            icon = 'exclamation-circle';
        } else if (type === 'warning') {
            bgClass = 'bg-warning';
            icon = 'exclamation-triangle';
        } else if (type === 'info') {
            bgClass = 'bg-info';
            icon = 'info-circle';
        }
        
        toast.classList.add(bgClass);
        toastMessage.innerHTML = `<i class="fas fa-${icon} me-2"></i>${message}`;
        
        const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
        bsToast.show();
    }
    
    function updateStatus(message, icon = 'check-circle', color = '') {
        statusText.innerHTML = `<i class="fas fa-${icon} me-2"></i>${message}`;
        if (color) {
            statusText.style.color = color;
        }
    }
    
    function updateProgress(currentCount) {
        bagCount.textContent = currentCount;
        
        if (targetCount > 0 && progressBar) {
            const percentage = Math.min((currentCount / targetCount) * 100, 100);
            progressBar.style.width = percentage + '%';
            if (progressText) {
                progressText.textContent = `${currentCount}/${targetCount}`;
            }
        }
        
        // Enable/disable scan children button based on bag count
        const scanChildrenBtn = document.getElementById('scan-children-btn');
        if (scanChildrenBtn) {
            scanChildrenBtn.disabled = currentCount === 0;
        }
        
        // Update button visibility based on capacity
        updateButtonVisibility(currentCount);
    }
    
    // Update buttons based on whether capacity is reached - simple show/hide
    function updateButtonVisibility(currentCount) {
        const completeBtn = document.getElementById('complete-bill-btn');
        const keepProgressBtn = document.getElementById('keep-progress-btn');
        const capacityInfo = document.getElementById('capacity-info');
        const remainingCount = document.getElementById('remaining-count');
        
        const isAtCapacity = targetCount > 0 && currentCount >= targetCount;
        const remaining = Math.max(0, targetCount - currentCount);
        
        // Simply show/hide - buttons are always in DOM from server render
        if (completeBtn) {
            completeBtn.style.display = isAtCapacity ? 'block' : 'none';
        }
        if (keepProgressBtn) {
            keepProgressBtn.style.display = isAtCapacity ? 'none' : 'block';
        }
        if (capacityInfo) {
            capacityInfo.style.display = isAtCapacity ? 'none' : 'block';
        }
        if (remainingCount) {
            remainingCount.textContent = remaining;
        }
    }
    
    function addBagToList(qrCode, childCount, bagId) {
        const newItem = document.createElement('div');
        newItem.className = 'list-group-item d-flex justify-content-between align-items-center bag-item py-1 px-2';
        newItem.innerHTML = `
            <small>
                <i class="fas fa-check text-success me-1"></i>
                <strong>${qrCode}</strong>
                <span class="text-muted">(${childCount || 0})</span>
            </small>
            <button class="btn btn-outline-danger py-0 px-1" style="font-size:10px;" onclick="removeBag('${qrCode}', ${bagId})">
                <i class="fas fa-times"></i>
            </button>
        `;
        bagsList.insertBefore(newItem, bagsList.firstChild);
    }
    
    function processBarcode(barcode) {
        if (isProcessing) {
            console.log('Already processing, ignoring:', barcode);
            return;
        }
        
        if (!barcode || barcode.trim().length === 0) {
            return;
        }
        
        barcode = barcode.trim().toUpperCase();
        console.log('Processing barcode:', barcode);
        
        isProcessing = true;
        updateStatus('Processing...', 'spinner fa-spin', '#ffc107');
        showToast(`Processing ${barcode}...`, 'info');
        
        // Call fast bill parent scan endpoint
        fetchWithCSRF('/fast/bill_parent_scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `bill_id=${billId}&qr_code=${encodeURIComponent(barcode)}`
        })
        .then(response => response.json())
        .then(data => {
            isProcessing = false;
            
            if (data.success) {
                showToast(data.message, 'success');
                
                // Add to list
                const childCount = data.child_count || 0;
                addBagToList(barcode, childCount, data.bag_id || 0);
                
                // Update progress
                const currentCount = parseInt(bagCount.textContent) + 1;
                updateProgress(currentCount);
                
                // Update weight tracking
                updateWeightDisplay(childCount);
                
                // Show success message and auto-focus for next scan
                const successMsg = document.getElementById('success-message');
                const successText = document.getElementById('success-text');
                if (successMsg && successText) {
                    successText.textContent = `✓ ${barcode} linked! Ready for next parent bag.`;
                    successMsg.style.display = 'block';
                    setTimeout(() => { successMsg.style.display = 'none'; }, 3000);
                }
                
                // Check if bill is at capacity
                if (targetCount > 0 && currentCount >= targetCount) {
                    showToast('✅ All parent bags linked! You can complete the bill now.', 'success');
                    updateStatus('At capacity! Ready to complete', 'check-circle', '#28a745');
                    scannerInput.focus();
                } else {
                    // Auto-continue: clear input and ready for next scan
                    scannerInput.value = '';
                    scannerInput.focus();
                    updateStatus('✓ Linked! Scan next parent bag', 'check-circle', '');
                }
            } else {
                showToast(data.message || 'Scan failed', 'error');
                updateStatus('Scan failed - try again', 'exclamation-circle', '#dc3545');
                
                // Re-enable after 1 second
                setTimeout(() => {
                    updateStatus('Ready for next scan', 'check-circle', '');
                    scannerInput.value = '';
                    scannerInput.focus();
                }, 1500);
            }
        })
        .catch(error => {
            isProcessing = false;
            console.error('Error:', error);
            showToast('Network error. Please try again.', 'error');
            updateStatus('Network error', 'exclamation-circle', '#dc3545');
            
            setTimeout(() => {
                updateStatus('Ready for next scan', 'check-circle', '');
            }, 1500);
            
            scannerInput.focus();
        });
    }
    
    // IMPROVED SCANNER DETECTION: Handle Enter, Tab, and timeout-based auto-submit
    // Barcode scanners typically send data very fast followed by Enter or Tab
    scannerInput.addEventListener('keydown', function(e) {
        // Handle Enter, Tab, or carriage return as submit triggers
        if (e.key === 'Enter' || e.key === 'Tab' || e.keyCode === 13 || e.keyCode === 9) {
            e.preventDefault();
            e.stopPropagation();
            
            // Clear any pending timeout
            if (scannerTimeout) {
                clearTimeout(scannerTimeout);
                scannerTimeout = null;
            }
            
            const barcode = scannerInput.value.trim();
            if (barcode && barcode.length >= 2) {
                console.log('Scanner submit via key:', e.key, 'barcode:', barcode);
                processBarcode(barcode);
                scannerInput.value = '';
            }
            return false;
        }
    });
    
    // TIMEOUT-BASED AUTO-SUBMIT: For scanners that don't send Enter/Tab
    // If input stops for 100ms after rapid typing, auto-submit
    scannerInput.addEventListener('input', function(e) {
        const now = Date.now();
        const timeSinceLastInput = now - lastInputTime;
        lastInputTime = now;
        
        // Clear any existing timeout
        if (scannerTimeout) {
            clearTimeout(scannerTimeout);
        }
        
        const currentValue = scannerInput.value.trim();
        
        // Only set auto-submit timeout if we have a valid-looking barcode
        if (currentValue.length >= 4) {
            scannerTimeout = setTimeout(function() {
                const barcode = scannerInput.value.trim();
                if (barcode && barcode.length >= 4 && !isProcessing) {
                    console.log('Scanner auto-submit via timeout, barcode:', barcode);
                    processBarcode(barcode);
                    scannerInput.value = '';
                }
            }, SCANNER_TIMEOUT_MS);
        }
    });
    
    // Auto-refocus input if it loses focus (critical for scanners)
    scannerInput.addEventListener('blur', function() {
        setTimeout(() => {
            if (!isProcessing && document.activeElement !== scannerInput) {
                scannerInput.focus();
            }
        }, 100);
    });
    
    // Prevent form submission on the scanner input
    scannerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault();
            return false;
        }
    });
    
    // Remove bag function
    window.removeBag = function(qrCode, bagId) {
        if (!confirm(`Remove ${qrCode} from this bill?`)) {
            return;
        }
        
        fetchWithCSRF('/remove_bag_from_bill', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `bill_id=${billId}&parent_qr=${encodeURIComponent(qrCode)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                
                // Remove from UI
                const items = document.querySelectorAll('.bag-item');
                items.forEach(item => {
                    if (item.textContent.includes(qrCode)) {
                        item.remove();
                    }
                });
                
                // Update count
                const currentCount = parseInt(bagCount.textContent) - 1;
                updateProgress(currentCount);
                
                // Update weight tracking using server-returned child count
                const removedChildCount = data.removed_child_count || 0;
                currentWeight -= removedChildCount;
                updateWeightDisplay(0);
            } else {
                showToast(data.message || 'Error removing bag', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Network error while removing bag', 'error');
        });
    };
    
    // Focus scanner function for next scan
    window.focusScanner = function() {
        scannerInput.value = '';
        scannerInput.focus();
        updateStatus('Ready - Scan next parent bag', 'check-circle', '');
        showToast('Scanner ready for next parent bag', 'info');
    };
    
    // Complete bill function - only allowed when capacity is reached
    window.completeBill = function() {
        const currentCount = parseInt(bagCount.textContent);
        
        if (currentCount === 0) {
            showToast('Please link at least one parent bag before completing the bill.', 'warning');
            return;
        }
        
        // Double-check capacity is met
        if (targetCount > 0 && currentCount < targetCount) {
            showToast(`Cannot complete: ${targetCount - currentCount} more bags needed to reach capacity.`, 'warning');
            return;
        }
        
        if (confirm(`Complete this bill with ${currentCount} linked parent bags?`)) {
            fetchWithCSRF('/complete_bill', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `bill_id=${billId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Bill completed successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/bills';
                    }, 1500);
                } else {
                    showToast(data.message || 'Error completing bill', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Network error while completing bill', 'error');
            });
        }
    };
    
    // Save & Continue Later - ACTUALLY saves bill status to server as 'processing'
    window.keepInProgress = function() {
        const currentCount = parseInt(bagCount.textContent);
        const remaining = Math.max(0, targetCount - currentCount);
        
        // Show saving indicator
        showToast('Saving progress...', 'info');
        updateStatus('Saving...', 'spinner fa-spin', '#ffc107');
        
        // Call server to update bill status to 'processing'
        fetchWithCSRF('/save_bill_progress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `bill_id=${billId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Progress saved! ${currentCount} bags linked, ${remaining} more needed.`, 'success');
                // Navigate back to bills after showing success
                setTimeout(() => {
                    window.location.href = '/bills';
                }, 1000);
            } else {
                showToast(data.message || 'Error saving progress', 'error');
                updateStatus('Save failed - try again', 'exclamation-circle', '#dc3545');
            }
        })
        .catch(error => {
            console.error('Error saving progress:', error);
            // Even on error, bags are already saved via individual scans
            showToast(`Progress saved locally. ${currentCount} bags linked.`, 'warning');
            setTimeout(() => {
                window.location.href = '/bills';
            }, 1500);
        });
    };
    
    // Ensure input is focused on page load
    scannerInput.focus();
    
    // Show ready message
    showToast('Scanner ready! Point and scan parent bags.', 'success');
});
</script>
{% endblock %}
