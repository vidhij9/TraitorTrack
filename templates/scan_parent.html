{% extends "scan_layout.html" %}
{% block title %}Scan Big Bag{% endblock %}
{% block header %}ðŸ“¦ Scan BIG Bag{% endblock %}

{% block styles %}
.scan-box {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    border-radius: 12px;
    padding: 14px 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    margin: 8px 0;
}

.big-icon {
    font-size: 100px;
    text-align: center;
    margin-bottom: 10px;
}

.scan-input {
    font-size: 32px;
    padding: 16px;
    text-align: center;
    border: 4px solid white;
    border-radius: 12px;
    font-weight: bold;
    text-transform: uppercase;
    background: white;
    color: #333;
    width: 100%;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    outline: none;
    min-height: 64px;
}

.scan-input:focus {
    border-color: #FFD700;
    box-shadow: 0 0 35px rgba(255, 215, 0, 0.7);
}

.status-text {
    color: white;
    font-size: 26px;
    text-align: center;
    margin-top: 10px;
    font-weight: 700;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
}

.instructions {
    background: white;
    border-radius: 10px;
    padding: 12px;
    margin: 10px 0;
}

.instructions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    padding: 5px 0;
}

.step {
    display: flex;
    align-items: center;
    margin: 12px 0;
    font-size: 20px;
    font-weight: 600;
}

.step-num {
    background: #4CAF50;
    color: white;
    width: 55px;
    height: 55px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    font-weight: bold;
    margin-right: 15px;
    flex-shrink: 0;
}

.step-icon {
    font-size: 32px;
    margin-left: 10px;
}

.success-box {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    border-radius: 16px;
    padding: 25px 15px;
    text-align: center;
    margin: 15px 0;
}

.qr-display {
    background: white;
    color: #333;
    font-size: 40px;
    padding: 20px;
    border-radius: 12px;
    font-weight: bold;
    margin: 20px 0;
    word-break: break-all;
}

@media (max-width: 768px) {
    .scan-box { padding: 12px 10px; margin: 6px 0; }
    .big-icon { font-size: 64px; margin-bottom: 6px; }
    .scan-input { font-size: 26px; padding: 14px; min-height: 60px; }
    .status-text { font-size: 20px; margin-top: 6px; }
    .instructions { padding: 10px; margin: 8px 0; }
    .step { font-size: 17px; margin: 8px 0; }
    .step-num { width: 48px; height: 48px; font-size: 22px; margin-right: 10px; }
    .step-icon { font-size: 26px; }
    .qr-display { font-size: 30px; padding: 14px; }
}

@media (max-width: 480px) {
    .scan-box { padding: 10px 8px; }
    .big-icon { font-size: 60px; }
    .scan-input { font-size: 24px; padding: 12px; min-height: 58px; }
    .status-text { font-size: 18px; }
    .step { font-size: 16px; }
    .step-num { width: 44px; height: 44px; font-size: 20px; }
    .step-icon { font-size: 24px; }
}
{% endblock %}

{% block content %}
<div class="container" style="max-width: 600px; padding: 6px;">
    <!-- Scan Input Box - Compact for above fold -->
    <div class="scan-box" style="margin: 6px 0;">
        <div class="big-icon" style="font-size: 70px; margin-bottom: 6px;">ðŸ“¦</div>
        
        <input 
            type="text" 
            id="input" 
            class="scan-input" 
            placeholder="READY" 
            autocomplete="off"
            autofocus
        >
        
        <div class="status-text" id="status" style="margin-top: 6px; font-size: 22px;">âœ… Ready to scan</div>
    </div>

    <!-- Collapsible Instructions - Collapsed by default -->
    <div class="instructions" style="margin: 10px 0;">
        <div class="instructions-header" onclick="toggleInstructions()">
            <h3 style="color: #4CAF50; margin: 0; font-size: 18px; font-weight: 700;">
                <i class="fas fa-info-circle"></i> How to Scan
            </h3>
            <i class="fas fa-chevron-down" id="instructions-icon" style="color: #4CAF50; font-size: 18px;"></i>
        </div>
        
        <div id="instructions-content" class="collapse" style="margin-top: 8px;">
            <div class="step">
                <div class="step-num">1</div>
                <div>Point scanner <span class="step-icon">ðŸ‘‰</span></div>
            </div>
            
            <div class="step">
                <div class="step-num">2</div>
                <div>Press button <span class="step-icon">ðŸ”˜</span></div>
            </div>
            
            <div class="step">
                <div class="step-num">3</div>
                <div>Listen for BEEP <span class="step-icon">ðŸ”Š</span></div>
            </div>
            
            <div class="step">
                <div class="step-num">4</div>
                <div>Next: Small bags <span class="step-icon">ðŸ“¦</span></div>
            </div>
        </div>
    </div>

    <!-- Success Box -->
    <div id="success" class="success-box" style="display: none;">
        <div style="font-size: 60px; margin-bottom: 10px;">âœ…</div>
        <h2 style="font-size: 32px; margin-bottom: 10px; font-weight: 800;">DONE!</h2>
        <p style="font-size: 18px; margin-bottom: 8px;">Big Bag:</p>
        <div class="qr-display" id="qr"></div>
        <button onclick="next()" class="btn btn-success" style="width: 100%; max-width: 400px; min-height: 70px; font-size: 22px; font-weight: 700; margin-top: 10px;">
            <i class="fas fa-arrow-right me-2" style="font-size: 24px;"></i>Scan Small Bags
        </button>
    </div>

    <!-- Back Button - Compact -->
    <div style="text-align: center; margin-top: 10px;">
        <a href="/" class="btn btn-secondary" style="min-height: 50px; padding: 10px 24px; font-size: 17px;">
            <i class="fas fa-home me-2"></i>Home
        </a>
    </div>
</div>

<script>
function toggleInstructions() {
    const content = document.getElementById('instructions-content');
    const icon = document.getElementById('instructions-icon');
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    } else {
        content.classList.add('show');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    }
}
</script>

<audio id="beep" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGS57OihUxILTKXo86xbGAg+ltrzxnUsCSB0xPDekT4JEU+m4fCrWBUIQ5zm8r5sIQQrhM/y2Yo3CRdnvOznpE8SC0ml5PKsWhgHPJXZ88p4LAceb8Tv3JA+CQ9Op+HwqVkUCEGa5fK/ayEEKYPP8tuJNwgUY7vt56NRFA1Jpejxq1oYBjuV2fPKeCwGHm7E79yQPgkPTqfh8KpZFAhBmuXyv2wgBSiDz/LbiTcIE2K57OajUxQOSaXo8atbGAc7lNjzyngsBS1txa/ckT4KD06o4fCqWhUIQZvm8sBsIQQogdDy24k3CBNiuezno1MUDkml6PGsWxcHO5TX88p3LAUtbcOu3JE+ChBOp+Lwq1sXCECa5fLAbCEEJoLQ8dqKOAgTYrrs6KNSFQ9Ip+fxrVsZCDuU2PPKeCwGLW3DrtySPwoQTajh8qtbGAg/mubywGwiBSaB0PHaijkIE2K67OejUxQPSKfn8KxcGQc7ldfzyHUsBy1txK/djD8JD0+n4fGsWxkIP5rm8r9sIwUlgNDy24o6CBRisuzoo1MVDUZL4fGsXRoIN5PY88l2LAgtbMSu3Y0/Cw9PqODyq1saCj2a5vK/bSQFJIDQ8duKOwkUYrLs56NUFg5FSeDxrV4aBzqT2PPJWK2EQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"></source>
</audio>
{% endblock %}

{% block scripts %}
<script>
const input = document.getElementById('input');
const status = document.getElementById('status');
const success = document.getElementById('success');
const qrEl = document.getElementById('qr');
const beep = document.getElementById('beep');

let processing = false;
let lastScanned = '';
let lastScanTime = 0;

function playBeep() {
    if (beep) {
        beep.currentTime = 0;
        beep.play().catch(e => console.log('Audio failed:', e));
    }
}

function updateStatus(msg, color) {
    status.innerHTML = msg;
    if (color) status.style.color = color;
}

function process(qr) {
    if (processing || !qr) return;
    
    // Prevent duplicate scans within 2 seconds
    const now = Date.now();
    if (qr === lastScanned && now - lastScanTime < 2000) {
        showToast('âš ï¸ Already scanning this code', 'warning');
        input.value = '';
        return;
    }
    
    lastScanned = qr;
    lastScanTime = now;
    processing = true;
    input.disabled = true;
    updateStatus('â³ Processing...', '#FFD700');
    
    // Set timeout to prevent hanging
    const timeout = setTimeout(() => {
        processing = false;
        input.disabled = false;
        input.value = '';
        input.focus();
        showToast('â±ï¸ Timeout. Try again.', 'warning');
        updateStatus('âœ… Ready to scan', 'white');
    }, 10000);
    
    fetch('/api/fast_parent_scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'qr_code=' + encodeURIComponent(qr)
    })
    .then(r => {
        clearTimeout(timeout);
        // Always try to parse JSON response (works for both success and error)
        return r.json().then(data => ({
            ok: r.ok,
            status: r.status,
            data: data
        })).catch(() => ({
            ok: r.ok,
            status: r.status,
            data: { success: false, message: 'Invalid server response' }
        }));
    })
    .then(response => {
        const d = response.data;
        if (d.success) {
            playBeep();
            showToast('âœ… Success!', 'success');
            qrEl.textContent = qr;
            success.style.display = 'block';
            success.scrollIntoView({ behavior: 'smooth' });
            updateStatus('âœ… Done!', '#4CAF50');
        } else {
            processing = false;
            input.disabled = false;
            input.value = '';
            input.focus();
            // Show clear error message
            const errorMsg = d.message || 'Invalid QR code';
            showToast('âŒ ' + errorMsg, 'error');
            updateStatus('âš ï¸ Try Again', '#FFA500');
            vibrate([200, 100, 200]);
        }
    })
    .catch(err => {
        clearTimeout(timeout);
        console.error('Scan error:', err);
        processing = false;
        input.disabled = false;
        input.value = '';
        input.focus();
        showToast('ðŸ“¡ Network error. Try again.', 'warning');
        updateStatus('âš ï¸ Try Again', '#FFA500');
    });
}

function next() {
    window.location.href = '/scan/child';
}

input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const qr = input.value.trim().toUpperCase();
        if (qr) {
            process(qr);
            input.value = '';
        } else {
            // Show error when trying to scan empty code
            showToast('âŒ Please scan a QR code', 'error');
            updateStatus('âš ï¸ Try Again', '#FFA500');
            vibrate([200, 100, 200]);
            input.value = '';
        }
    }
});

keepFocus(input);

setTimeout(() => {
    showToast('ðŸ“± Ready to scan!', 'info');
}, 500);
</script>
{% endblock %}
