{% extends "layout.html" %}

{% block title %}Scan Parent Bag{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark text-light border-success mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-barcode me-2"></i>Scan Parent Bag</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> Please scan a parent bag QR code (format: P123-10)
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8 mx-auto">
                            <div class="qr-scanner-container">
                                <video id="qr-video" class="w-100 rounded"></video>
                                <div class="qr-scanner-overlay">
                                    <div class="qr-scanner-target">
                                        <div class="qr-scanner-line"></div>
                                    </div>
                                </div>
                                <canvas id="qr-canvas" style="display: none;"></canvas>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-3">
                                <button id="switch-camera-btn" class="btn btn-outline-light">
                                    <i class="fas fa-sync-alt me-2"></i>Switch Camera
                                </button>
                                <button id="pause-scan-btn" class="btn btn-outline-success">
                                    <i class="fas fa-pause me-2"></i>Pause
                                </button>
                            </div>
                            
                            <div class="mt-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-keyboard"></i></span>
                                    <input type="text" id="manual-input" class="form-control" placeholder="Manually enter QR code (e.g. P123-10)">
                                    <button id="manual-submit-btn" class="btn btn-success">Submit</button>
                                </div>
                                <div class="form-text text-muted">If scanning doesn't work, you can manually enter the QR code here.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="result-container" class="mt-4 d-none">
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i>Parent Bag Scanned Successfully</h5>
                            <p id="result-message" class="mb-0"></p>
                        </div>
                        
                        <div class="d-grid gap-2 col-md-6 mx-auto mt-3">
                            <a id="scan-child-btn" href="{{ url_for('scan_child') }}" class="btn btn-lg btn-success">
                                <i class="fas fa-qrcode me-2"></i>Scan Child Bags
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <a href="{{ url_for('index') }}" class="text-success"><i class="fas fa-home me-2"></i>Back to Dashboard</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const video = document.getElementById('qr-video');
        const canvas = document.getElementById('qr-canvas');
        const ctx = canvas.getContext('2d');
        const switchCameraBtn = document.getElementById('switch-camera-btn');
        const pauseScanBtn = document.getElementById('pause-scan-btn');
        const manualInput = document.getElementById('manual-input');
        const manualSubmitBtn = document.getElementById('manual-submit-btn');
        const resultContainer = document.getElementById('result-container');
        const resultMessage = document.getElementById('result-message');
        
        let currentStream;
        let scanning = true;
        let canvasWidth = 0;
        let canvasHeight = 0;
        let usingFrontCamera = false;
        
        // Initialize camera
        function initCamera(useBackCamera = true) {
            if (currentStream) {
                stopCamera();
            }
            
            usingFrontCamera = !useBackCamera;
            
            // Set constraints based on camera choice
            const constraints = {
                video: {
                    facingMode: useBackCamera ? 'environment' : 'user',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            // Start video stream
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    currentStream = stream;
                    video.srcObject = stream;
                    video.setAttribute('playsinline', true);
                    video.play();
                    requestAnimationFrame(scanQRCode);
                    
                    // Update canvas size after video loads
                    video.onloadedmetadata = function() {
                        canvasWidth = video.videoWidth;
                        canvasHeight = video.videoHeight;
                        canvas.width = canvasWidth;
                        canvas.height = canvasHeight;
                    };
                })
                .catch(function(err) {
                    console.error('Camera error:', err);
                    alert('Could not access the camera. Please ensure you have granted camera permissions or try entering the QR code manually.');
                });
        }
        
        // Stop camera
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }
        
        // Toggle scanning pause
        function togglePause() {
            scanning = !scanning;
            pauseScanBtn.innerHTML = scanning ? 
                '<i class="fas fa-pause me-2"></i>Pause' : 
                '<i class="fas fa-play me-2"></i>Resume';
        }
        
        // Process scanned QR code
        function processQRCode(qrCode) {
            // Stop scanning once we find a valid code
            scanning = false;
            pauseScanBtn.innerHTML = '<i class="fas fa-play me-2"></i>Resume';
            
            // Process through API
            const formData = new FormData();
            formData.append('qr_code', qrCode);
            
            fetch("{{ url_for('process_parent_scan') }}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultMessage.textContent = data.message;
                    resultContainer.classList.remove('d-none');
                    window.scrollTo(0, document.body.scrollHeight);
                } else {
                    alert('Error: ' + data.message);
                    scanning = true;
                }
            })
            .catch(error => {
                console.error('Error processing QR code:', error);
                alert('Error processing QR code. Please try again.');
                scanning = true;
            });
        }
        
        // Scan for QR code in video
        function scanQRCode() {
            if (scanning && currentStream) {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    // Draw video frame to canvas
                    ctx.drawImage(video, 0, 0, canvasWidth, canvasHeight);
                    
                    // Get image data for processing
                    const imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
                    
                    // Process with jsQR
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code && code.data) {
                        console.log("QR Code detected:", code.data);
                        
                        // Check if it's a valid parent bag QR code
                        const parentBagRegex = /^P\d+-\d+$/;
                        if (parentBagRegex.test(code.data)) {
                            processQRCode(code.data);
                        }
                    }
                }
                
                // Continue scanning
                requestAnimationFrame(scanQRCode);
            }
        }
        
        // Manual QR code input
        manualSubmitBtn.addEventListener('click', function() {
            const manualCode = manualInput.value.trim();
            if (manualCode) {
                processQRCode(manualCode);
            } else {
                alert('Please enter a valid QR code.');
            }
        });
        
        // Also allow pressing Enter on input
        manualInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const manualCode = manualInput.value.trim();
                if (manualCode) {
                    processQRCode(manualCode);
                }
            }
        });
        
        // Switch camera button
        switchCameraBtn.addEventListener('click', function() {
            initCamera(!usingFrontCamera);
        });
        
        // Pause/resume button
        pauseScanBtn.addEventListener('click', togglePause);
        
        // Initialize with back camera by default
        initCamera(true);
        
        // Cleanup on page leave
        window.addEventListener('beforeunload', stopCamera);
    });
</script>
{% endblock %}