{% extends "scan_layout.html" %}
{% block title %}Scan Big Bag{% endblock %}
{% block header %}üì¶ Scan BIG Bag{% endblock %}

{% block styles %}
.scan-box {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    border-radius: 20px;
    padding: 30px 20px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    margin: 15px 0;
}

.big-icon {
    font-size: 80px;
    text-align: center;
    margin-bottom: 15px;
}

.scan-input {
    font-size: 32px;
    padding: 20px;
    text-align: center;
    border: 5px solid white;
    border-radius: 15px;
    font-weight: bold;
    text-transform: uppercase;
    background: white;
    color: #333;
    width: 100%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    outline: none;
}

.scan-input:focus {
    border-color: #FFD700;
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
}

.status-text {
    color: white;
    font-size: 24px;
    text-align: center;
    margin-top: 15px;
    font-weight: 600;
}

.instructions {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
}

.step {
    display: flex;
    align-items: center;
    margin: 15px 0;
    font-size: 18px;
}

.step-num {
    background: #4CAF50;
    color: white;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    margin-right: 15px;
    flex-shrink: 0;
}

.success-box {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    margin: 20px 0;
}

.qr-display {
    background: white;
    color: #333;
    font-size: 36px;
    padding: 15px;
    border-radius: 10px;
    font-weight: bold;
    margin: 20px 0;
}

@media (max-width: 480px) {
    .scan-input { font-size: 28px; padding: 18px; }
    .big-icon { font-size: 60px; }
    .status-text { font-size: 20px; }
}
{% endblock %}

{% block content %}
<div class="container">
    <div class="scan-box">
        <div class="big-icon">üì¶</div>
        
        <input 
            type="text" 
            id="input" 
            class="scan-input" 
            placeholder="READY" 
            autocomplete="off"
            autofocus
        >
        
        <div class="status-text" id="status">‚úÖ Ready to scan</div>
    </div>

    <div class="instructions">
        <h3 style="text-align: center; color: #4CAF50; margin-bottom: 20px;">
            ‚ÑπÔ∏è How to Scan
        </h3>
        
        <div class="step">
            <div class="step-num">1</div>
            <div>Point scanner at BIG bag</div>
        </div>
        
        <div class="step">
            <div class="step-num">2</div>
            <div>Press scan button</div>
        </div>
        
        <div class="step">
            <div class="step-num">3</div>
            <div>Listen for BEEP</div>
        </div>
        
        <div class="step">
            <div class="step-num">4</div>
            <div>Scan small bags next</div>
        </div>
    </div>

    <div id="success" class="success-box" style="display: none;">
        <h2 style="font-size: 32px; margin-bottom: 15px;">‚úÖ Done!</h2>
        <p style="font-size: 20px;">Big Bag Scanned:</p>
        <div class="qr-display" id="qr"></div>
        <button onclick="next()" class="btn btn-success" style="width: 100%; max-width: 400px; min-height: 60px;">
            ‚ñ∂ Scan Small Bags Now
        </button>
    </div>

    <div style="text-align: center; margin-top: 20px;">
        <a href="/" class="btn btn-secondary" style="padding: 12px 30px;">
            üè† Back to Home
        </a>
    </div>
</div>

<audio id="beep" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGS57OihUxILTKXo86xbGAg+ltrzxnUsCSB0xPDekT4JEU+m4fCrWBUIQ5zm8r5sIQQrhM/y2Yo3CRdnvOznpE8SC0ml5PKsWhgHPJXZ88p4LAceb8Tv3JA+CQ9Op+HwqVkUCEGa5fK/ayEEKYPP8tuJNwgUY7vt56NRFA1Jpejxq1oYBjuV2fPKeCwGHm7E79yQPgkPTqfh8KpZFAhBmuXyv2wgBSiDz/LbiTcIE2K57OajUxQOSaXo8atbGAc7lNjzyngsBS1txa/ckT4KD06o4fCqWhUIQZvm8sBsIQQogdDy24k3CBNiuezno1MUDkml6PGsWxcHO5TX88p3LAUtbcOu3JE+ChBOp+Lwq1sXCECa5fLAbCEEJoLQ8dqKOAgTYrrs6KNSFQ9Ip+fxrVsZCDuU2PPKeCwGLW3DrtySPwoQTajh8qtbGAg/mubywGwiBSaB0PHaijkIE2K67OejUxQPSKfn8KxcGQc7ldfzyHUsBy1txK/djD8JD0+n4fGsWxkIP5rm8r9sIwUlgNDy24o6CBRisuzoo1MVDUZL4fGsXRoIN5PY88l2LAgtbMSu3Y0/Cw9PqODyq1saCj2a5vK/bSQFJIDQ8duKOwkUYrLs56NUFg5FSeDxrV4aBzqT2PPJWK2EQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"></source>
</audio>
{% endblock %}

{% block scripts %}
<script>
const input = document.getElementById('input');
const status = document.getElementById('status');
const success = document.getElementById('success');
const qrEl = document.getElementById('qr');
const beep = document.getElementById('beep');

let processing = false;
let lastScanned = '';
let lastScanTime = 0;

function playBeep() {
    if (beep) {
        beep.currentTime = 0;
        beep.play().catch(e => console.log('Audio failed:', e));
    }
}

function updateStatus(msg, color) {
    status.innerHTML = msg;
    if (color) status.style.color = color;
}

function process(qr) {
    if (processing || !qr) return;
    
    // Prevent duplicate scans within 2 seconds
    const now = Date.now();
    if (qr === lastScanned && now - lastScanTime < 2000) {
        showToast('‚ö†Ô∏è Already scanning this code', 'warning');
        input.value = '';
        return;
    }
    
    lastScanned = qr;
    lastScanTime = now;
    processing = true;
    input.disabled = true;
    updateStatus('‚è≥ Processing...', '#FFD700');
    
    // Set timeout to prevent hanging
    const timeout = setTimeout(() => {
        processing = false;
        input.disabled = false;
        input.value = '';
        input.focus();
        showToast('‚è±Ô∏è Timeout. Try again.', 'warning');
        updateStatus('‚úÖ Ready to scan', 'white');
    }, 10000);
    
    fetch('/api/fast_parent_scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'qr_code=' + encodeURIComponent(qr)
    })
    .then(r => {
        clearTimeout(timeout);
        return r.json();
    })
    .then(d => {
        if (d.success) {
            playBeep();
            showToast('‚úÖ Success!', 'success');
            qrEl.textContent = qr;
            success.style.display = 'block';
            success.scrollIntoView({ behavior: 'smooth' });
            updateStatus('‚úÖ Done!', '#4CAF50');
        } else {
            processing = false;
            input.disabled = false;
            input.value = '';
            input.focus();
            showToast('‚ùå ' + (d.message || 'Error'), 'error');
            updateStatus('‚ö†Ô∏è Try Again', '#FFA500');
            vibrate([200, 100, 200]);
        }
    })
    .catch(err => {
        clearTimeout(timeout);
        console.error(err);
        processing = false;
        input.disabled = false;
        input.value = '';
        input.focus();
        showToast('üì° Network error. Try again.', 'warning');
        updateStatus('‚úÖ Ready to scan', 'white');
    });
}

function next() {
    window.location.href = '/scan/child';
}

input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const qr = input.value.trim().toUpperCase();
        if (qr) {
            process(qr);
            input.value = '';
        }
    }
});

keepFocus(input);

setTimeout(() => {
    showToast('üì± Ready to scan!', 'info');
}, 500);
</script>
{% endblock %}
