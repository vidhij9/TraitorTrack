{% extends "layout.html" %}

{% block title %}Scan Parent Bag{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark text-light border-primary mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-barcode me-2"></i>Scan Parent Bag</h5>
                </div>
                <div class="card-body">
                    <!-- Location Info -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1"><i class="fas fa-map-marker-alt me-2"></i>Location: {{ location.name }}</h5>
                                <p class="mb-0 text-muted">{{ location.description }}</p>
                            </div>
                            <div>
                                <a href="{{ url_for('select_location') }}" class="btn btn-sm btn-outline-light">
                                    <i class="fas fa-exchange-alt me-1"></i>Change
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- QR Scanner -->
                    <div class="row">
                        <div class="col-md-8 mx-auto">
                            <div class="qr-scanner-container">
                                <video id="qr-video" class="w-100 rounded"></video>
                                <div class="qr-scanner-overlay">
                                    <div class="qr-scanner-target">
                                        <div class="qr-scanner-line"></div>
                                    </div>
                                </div>
                                <canvas id="qr-canvas" style="display: none;"></canvas>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-3">
                                <button id="switch-camera-btn" class="btn btn-outline-light">
                                    <i class="fas fa-sync-alt me-2"></i>Switch Camera
                                </button>
                                <button id="pause-scan-btn" class="btn btn-outline-primary">
                                    <i class="fas fa-pause me-2"></i>Pause
                                </button>
                            </div>
                            
                            <div class="mt-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-keyboard"></i></span>
                                    <input type="text" id="manual-input" class="form-control" placeholder="Manually enter parent bag QR code (e.g. P123-5)">
                                    <button id="manual-submit-btn" class="btn btn-primary">Submit</button>
                                </div>
                                <div class="form-text text-muted">If scanning doesn't work, you can manually enter the QR code here.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Child Count Input (optional) -->
                    <div class="row mt-4">
                        <div class="col-md-8 mx-auto">
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-info-circle me-2"></i>Child Bag Count</h6>
                                <p class="mb-2">Enter the number of child bags for this parent bag:</p>
                                <div class="input-group">
                                    <input type="number" id="child-count-input" class="form-control" min="1" max="10" value="5">
                                    <span class="input-group-text">bags</span>
                                </div>
                                <div class="form-text text-muted">Parent bags format: P123-5 where 5 is the number of child bags</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Scans -->
                    <div class="mt-4">
                        <h5><i class="fas fa-history me-2"></i>Recent Scans</h5>
                        <div class="table-responsive">
                            <table class="table table-dark table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>QR Code</th>
                                        <th>Time</th>
                                        <th>Child Bags</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if recent_scans %}
                                        {% for scan in recent_scans %}
                                        <tr>
                                            <td>{{ scan.parent_bag.qr_id }}</td>
                                            <td>{{ scan.timestamp.strftime('%H:%M:%S') }}</td>
                                            <td>{{ scan.child_count }}/{{ scan.expected_child_count }}</td>
                                            <td>
                                                {% if scan.child_count >= scan.expected_child_count %}
                                                <span class="badge bg-success">Complete</span>
                                                {% else %}
                                                <span class="badge bg-warning">Pending</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if scan.child_count < scan.expected_child_count %}
                                                <a href="{{ url_for('scan_child', parent_id=scan.parent_bag.id) }}" class="btn btn-sm btn-success">
                                                    <i class="fas fa-link me-1"></i>Link Child Bags
                                                </a>
                                                {% else %}
                                                <button class="btn btn-sm btn-secondary" disabled>
                                                    <i class="fas fa-check me-1"></i>Completed
                                                </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center py-3">No recent scans</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <a href="{{ url_for('index') }}" class="text-primary">
                        <i class="fas fa-home me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const video = document.getElementById('qr-video');
        const canvas = document.getElementById('qr-canvas');
        const ctx = canvas.getContext('2d');
        const switchCameraBtn = document.getElementById('switch-camera-btn');
        const pauseScanBtn = document.getElementById('pause-scan-btn');
        const manualInput = document.getElementById('manual-input');
        const manualSubmitBtn = document.getElementById('manual-submit-btn');
        const childCountInput = document.getElementById('child-count-input');
        
        let currentStream;
        let scanning = true;
        let canvasWidth = 0;
        let canvasHeight = 0;
        let usingFrontCamera = false;
        
        // Initialize camera
        function initCamera(useBackCamera = true) {
            if (currentStream) {
                stopCamera();
            }
            
            usingFrontCamera = !useBackCamera;
            
            // Set constraints based on camera choice
            const constraints = {
                video: {
                    facingMode: useBackCamera ? 'environment' : 'user',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            // Start video stream
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    currentStream = stream;
                    video.srcObject = stream;
                    video.setAttribute('playsinline', true);
                    video.play();
                    requestAnimationFrame(scanQRCode);
                    
                    // Update canvas size after video loads
                    video.onloadedmetadata = function() {
                        canvasWidth = video.videoWidth;
                        canvasHeight = video.videoHeight;
                        canvas.width = canvasWidth;
                        canvas.height = canvasHeight;
                    };
                })
                .catch(function(err) {
                    console.error('Camera error:', err);
                    alert('Could not access the camera. Please ensure you have granted camera permissions or try entering the QR code manually.');
                });
        }
        
        // Stop camera
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }
        
        // Toggle scanning pause
        function togglePause() {
            scanning = !scanning;
            pauseScanBtn.innerHTML = scanning ? 
                '<i class="fas fa-pause me-2"></i>Pause' : 
                '<i class="fas fa-play me-2"></i>Resume';
                
            if (scanning) {
                requestAnimationFrame(scanQRCode);
            }
        }
        
        // Process scanned QR code
        function processQRCode(qrCode) {
            // Stop scanning temporarily
            scanning = false;
            pauseScanBtn.innerHTML = '<i class="fas fa-play me-2"></i>Resume';
            
            // Get child count
            const childCount = parseInt(childCountInput.value) || 5;
            
            // Process through API
            const formData = new FormData();
            formData.append('qr_code', qrCode);
            formData.append('child_count', childCount);
            
            fetch("{{ url_for('process_parent_scan') }}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show toast notification
                    if (window.showToast) {
                        window.showToast(data.message, 'success');
                    } else {
                        alert(data.message);
                    }
                    
                    // Redirect to child scanning if needed
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        // Refresh page to update recent scans list
                        window.location.reload();
                    }
                } else {
                    // Show error
                    if (window.showToast) {
                        window.showToast('Error: ' + data.message, 'danger');
                    } else {
                        alert('Error: ' + data.message);
                    }
                    
                    // Resume scanning
                    scanning = true;
                    pauseScanBtn.innerHTML = '<i class="fas fa-pause me-2"></i>Pause';
                    requestAnimationFrame(scanQRCode);
                }
            })
            .catch(error => {
                console.error('Error processing QR code:', error);
                alert('Error processing QR code. Please try again.');
                scanning = true;
                pauseScanBtn.innerHTML = '<i class="fas fa-pause me-2"></i>Pause';
                requestAnimationFrame(scanQRCode);
            });
        }
        
        // Extract child count from QR code
        function extractChildCountFromQR(qrCode) {
            // Example format: P123-5 where 5 is the child count
            const match = qrCode.match(/^P\d+-(\d+)$/);
            if (match && match[1]) {
                const count = parseInt(match[1]);
                if (count > 0 && count <= 10) {
                    childCountInput.value = count;
                }
            }
        }
        
        // Scan for QR code in video
        function scanQRCode() {
            if (scanning && currentStream) {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    // Draw video frame to canvas
                    ctx.drawImage(video, 0, 0, canvasWidth, canvasHeight);
                    
                    // Get image data for processing
                    const imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
                    
                    // Process with jsQR
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code && code.data) {
                        console.log("QR Code detected:", code.data);
                        
                        // Check if it's a valid parent bag QR code
                        const parentBagRegex = /^P\d+-\d+$/;
                        if (parentBagRegex.test(code.data)) {
                            // Extract child count from QR code
                            extractChildCountFromQR(code.data);
                            
                            // Process the scan
                            processQRCode(code.data);
                        }
                    }
                }
                
                // Continue scanning
                requestAnimationFrame(scanQRCode);
            }
        }
        
        // Manual QR code input
        manualSubmitBtn.addEventListener('click', function() {
            const manualCode = manualInput.value.trim();
            if (manualCode) {
                // Try to extract child count if it's in the correct format
                extractChildCountFromQR(manualCode);
                
                // Process the scan
                processQRCode(manualCode);
            } else {
                alert('Please enter a valid QR code.');
            }
        });
        
        // Also allow pressing Enter on input
        manualInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const manualCode = manualInput.value.trim();
                if (manualCode) {
                    // Try to extract child count if it's in the correct format
                    extractChildCountFromQR(manualCode);
                    
                    // Process the scan
                    processQRCode(manualCode);
                }
            }
        });
        
        // Switch camera button
        switchCameraBtn.addEventListener('click', function() {
            initCamera(!usingFrontCamera);
        });
        
        // Pause/resume button
        pauseScanBtn.addEventListener('click', togglePause);
        
        // Initialize with back camera by default
        initCamera(true);
        
        // Cleanup on page leave
        window.addEventListener('beforeunload', stopCamera);
    });
</script>
{% endblock %}