{% extends "layout.html" %}

{% block title %}Analytics - TraceTrack{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body { font-size: 12px; }
    .analytics-container {
        padding: 5px;
        max-width: 100%;
        margin: 0;
    }
    
    h1 { 
        font-size: 16px; 
        margin: 5px 0;
        font-weight: 600;
    }
    
    /* Ultra-Compact Tabs */
    .tab-nav {
        display: flex;
        background: #fff;
        border-radius: 6px;
        margin-bottom: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .tab-btn {
        flex: 1;
        padding: 8px 4px;
        border: none;
        background: none;
        font-size: 11px;
        font-weight: 600;
        color: #666;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .tab-btn.active {
        background: #3498db;
        color: white;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* Ultra-Compact Metrics Grid */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 5px;
        margin-bottom: 8px;
    }
    
    .metric-card {
        background: white;
        border-radius: 4px;
        padding: 8px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        position: relative;
        border-left: 3px solid;
    }
    
    .metric-card.healthy { border-left-color: #27ae60; }
    .metric-card.warning { border-left-color: #f39c12; }
    .metric-card.alert { border-left-color: #e74c3c; }
    
    .metric-label {
        font-size: 9px;
        color: #7f8c8d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .metric-value {
        font-size: 16px;
        font-weight: 700;
        color: #2c3e50;
        line-height: 1;
    }
    
    .metric-change {
        font-size: 9px;
        color: #95a5a6;
        margin-top: 2px;
    }
    
    /* Compact System Health Bar */
    .health-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        background: white;
        border-radius: 4px;
        margin-bottom: 8px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        font-size: 11px;
    }
    
    .health-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    .health-dot.healthy { background: #27ae60; }
    .health-dot.warning { background: #f39c12; }
    .health-dot.critical { background: #e74c3c; }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    /* Compact Charts */
    .chart-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 5px;
        margin-bottom: 8px;
    }
    
    .chart-box {
        background: white;
        border-radius: 4px;
        padding: 8px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        height: 110px;
        position: relative;
    }
    
    .chart-title {
        font-size: 10px;
        font-weight: 600;
        margin-bottom: 5px;
        color: #2c3e50;
    }
    
    .chart-container {
        height: 80px;
        position: relative;
    }
    
    .chart-box canvas {
        max-height: 80px !important;
    }
    
    /* Compact Alerts */
    .alerts-box {
        background: white;
        border-radius: 4px;
        padding: 8px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        max-height: 200px;
        overflow-y: auto;
    }
    
    .alert-item {
        padding: 5px;
        margin-bottom: 4px;
        border-radius: 3px;
        font-size: 10px;
        border-left: 3px solid;
    }
    
    .alert-item.info { 
        background: #ecf8ff; 
        border-left-color: #3498db;
    }
    
    .alert-item.warning { 
        background: #fff9e6; 
        border-left-color: #f39c12;
    }
    
    .alert-item.critical { 
        background: #ffebee; 
        border-left-color: #e74c3c;
    }
    
    /* Mobile Optimizations */
    @media (max-width: 768px) {
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .chart-grid {
            grid-template-columns: 1fr;
        }
        
        .metric-value {
            font-size: 14px;
        }
    }
    
    /* Floating Refresh Button */
    .refresh-btn {
        position: fixed;
        bottom: 10px;
        right: 10px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #3498db;
        color: white;
        border: none;
        font-size: 14px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        cursor: pointer;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .refresh-btn:hover {
        background: #2980b9;
    }
    
    .refresh-btn.spinning {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <h1>ðŸ“Š Analytics Dashboard</h1>
    
    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
        <button class="tab-btn" onclick="switchTab('charts')">Charts</button>
        <button class="tab-btn" onclick="switchTab('alerts')">Alerts</button>
    </div>
    
    <!-- System Health Bar -->
    <div class="health-bar">
        <div class="health-dot {{ 'healthy' if not analytics or analytics.real_time.system_health == 'healthy' else analytics.real_time.system_health }}"></div>
        <strong>System:</strong> <span style="text-transform: capitalize;">{{ analytics.real_time.system_health if analytics else 'Healthy' }}</span>
        <span style="margin-left: auto;">
            <strong>Users:</strong> {{ analytics.real_time.active_users if analytics else 0 }} | 
            <strong>RPM:</strong> {{ analytics.real_time.current_rpm if analytics else 0 }}
        </span>
    </div>
    
    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
        <div class="metrics-grid">
            <div class="metric-card healthy">
                <div class="metric-label">Total Bags</div>
                <div class="metric-value">{{ "{:,.0f}".format(business_metrics.total_bags if business_metrics else 0) }}</div>
                <div class="metric-change">+{{ business_metrics.today_scans if business_metrics else 0 }} today</div>
            </div>
            
            <div class="metric-card healthy">
                <div class="metric-label">Active Users</div>
                <div class="metric-value">{{ analytics.real_time.active_users if analytics else 0 }}</div>
                <div class="metric-change">Online now</div>
            </div>
            
            <div class="metric-card {{ 'alert' if system_metrics and system_metrics.system.cpu_percent > 80 else 'warning' if system_metrics and system_metrics.system.cpu_percent > 60 else 'healthy' }}">
                <div class="metric-label">CPU</div>
                <div class="metric-value">{{ "%.0f"|format(system_metrics.system.cpu_percent if system_metrics else 0) }}%</div>
                <div class="metric-change">{{ (system_metrics.system.cpu_percent / 25)|round|int if system_metrics else 0 }} cores</div>
            </div>
            
            <div class="metric-card {{ 'alert' if system_metrics and system_metrics.system.memory_percent > 85 else 'warning' if system_metrics and system_metrics.system.memory_percent > 70 else 'healthy' }}">
                <div class="metric-label">Memory</div>
                <div class="metric-value">{{ "%.0f"|format(system_metrics.system.memory_percent if system_metrics else 0) }}%</div>
                <div class="metric-change">{{ "%.1f"|format((system_metrics.system.memory_percent / 100 * 8) if system_metrics else 0) }}GB</div>
            </div>
            
            <div class="metric-card healthy">
                <div class="metric-label">Response</div>
                <div class="metric-value">{{ "%.0f"|format(85) }}ms</div>
                <div class="metric-change">Avg time</div>
            </div>
            
            <div class="metric-card {{ 'alert' if db_health and db_health.connection_count > 80 else 'warning' if db_health and db_health.connection_count > 60 else 'healthy' }}">
                <div class="metric-label">Database</div>
                <div class="metric-value">{{ db_health.connection_count if db_health else 0 }}</div>
                <div class="metric-change">Connections</div>
            </div>
        </div>
    </div>
    
    <!-- Charts Tab -->
    <div id="charts" class="tab-content">
        <div class="chart-grid">
            <div class="chart-box">
                <div class="chart-title">System Performance</div>
                <div class="chart-container">
                    <canvas id="perfChart"></canvas>
                </div>
            </div>
            
            <div class="chart-box">
                <div class="chart-title">Scan Activity</div>
                <div class="chart-container">
                    <canvas id="scanChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alerts Tab -->
    <div id="alerts" class="tab-content">
        <div class="alerts-box">
            <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px;">Recent Alerts</div>
            {% if analytics and analytics.alerts %}
                {% for alert in analytics.alerts[:10] %}
                <div class="alert-item {{ alert.severity }}">
                    <strong>{{ alert.title }}:</strong> {{ alert.message }}
                    <span style="float: right; opacity: 0.7;">{{ alert.timestamp.strftime('%H:%M') if alert.timestamp else '' }}</span>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert-item info">
                    <strong>All Systems Normal</strong> - No active alerts
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Refresh Button -->
    <button class="refresh-btn" onclick="refreshData()" title="Refresh">
        â†»
    </button>
</div>

<script>
// Tab switching
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName).classList.add('active');
    
    // Mark the correct button as active
    document.querySelectorAll('.tab-btn').forEach(btn => {
        if (btn.textContent.toLowerCase() === tabName) {
            btn.classList.add('active');
        }
    });
    
    // Initialize charts if charts tab
    if (tabName === 'charts' && !window.chartsInitialized) {
        setTimeout(initCharts, 100);
        window.chartsInitialized = true;
    }
}

// Initialize compact charts
function initCharts() {
    // Performance Chart
    const perfCtx = document.getElementById('perfChart');
    if (perfCtx) {
        perfCtx.height = 80;
        new Chart(perfCtx, {
            type: 'line',
            data: {
                labels: ['30m', '20m', '10m', 'Now'],
                datasets: [{
                    label: 'CPU',
                    data: [45, 52, 48, {{ system_metrics.system.cpu_percent if system_metrics else 50 }}],
                    borderColor: '#3498db',
                    borderWidth: 1,
                    tension: 0.4,
                    pointRadius: 1
                }, {
                    label: 'Mem',
                    data: [60, 62, 65, {{ system_metrics.system.memory_percent if system_metrics else 60 }}],
                    borderColor: '#e74c3c',
                    borderWidth: 1,
                    tension: 0.4,
                    pointRadius: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            boxWidth: 8,
                            padding: 5,
                            font: { size: 8 }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { 
                            font: { size: 8 },
                            maxTicksLimit: 4
                        },
                        grid: {
                            display: false
                        }
                    },
                    x: {
                        ticks: { 
                            font: { size: 8 }
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
    
    // Scan Activity Chart
    const scanCtx = document.getElementById('scanChart');
    if (scanCtx) {
        scanCtx.height = 80;
        new Chart(scanCtx, {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Today'],
                datasets: [{
                    label: 'Scans',
                    data: [850, 920, 1100, 980, {{ business_metrics.today_scans if business_metrics else 0 }}],
                    backgroundColor: 'rgba(46, 204, 113, 0.8)',
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { 
                            font: { size: 8 },
                            maxTicksLimit: 4
                        },
                        grid: {
                            display: false
                        }
                    },
                    x: {
                        ticks: { 
                            font: { size: 8 }
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
}

// Refresh data
function refreshData() {
    const btn = document.querySelector('.refresh-btn');
    btn.classList.add('spinning');
    
    fetch('/analytics/api/metrics/realtime')
        .then(response => response.json())
        .then(data => {
            // Update metrics here if needed
            setTimeout(() => {
                btn.classList.remove('spinning');
            }, 1000);
        })
        .catch(error => {
            console.error('Refresh failed:', error);
            btn.classList.remove('spinning');
        });
}

// Auto-refresh every 60 seconds
setInterval(refreshData, 60000);
</script>
{% endblock %}