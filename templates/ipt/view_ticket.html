{% extends "layout.html" %}
{% block title %}Return Ticket - {{ ticket.ticket_code }}{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('ipt.ipt_dashboard') }}">IPT</a></li>
            <li class="breadcrumb-item active">{{ ticket.ticket_code }}</li>
        </ol>
    </nav>
    
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Ticket Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Ticket Code</dt>
                        <dd class="col-sm-7"><strong>{{ ticket.ticket_code }}</strong></dd>
                        
                        <dt class="col-sm-5">Status</dt>
                        <dd class="col-sm-7">
                            {% if ticket.status == 'open' %}
                            <span class="badge bg-primary">Open</span>
                            {% elif ticket.status == 'committed' %}
                            <span class="badge bg-success">Committed</span>
                            {% else %}
                            <span class="badge bg-secondary">Cancelled</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-5">C&F Location</dt>
                        <dd class="col-sm-7">{{ ticket.cf_location | replace('_', ' ') | title }}</dd>
                        
                        <dt class="col-sm-5">Bags Returned</dt>
                        <dd class="col-sm-7">{{ ticket.bags_scanned_count or 0 }}</dd>
                        
                        <dt class="col-sm-5">Total Weight</dt>
                        <dd class="col-sm-7">{{ '%.1f' | format(ticket.total_weight_returned_kg or 0) }} kg</dd>
                        
                        <dt class="col-sm-5">Created</dt>
                        <dd class="col-sm-7">{{ ticket.created_at.strftime('%Y-%m-%d %H:%M') if ticket.created_at else '-' }}</dd>
                        
                        <dt class="col-sm-5">Created By</dt>
                        <dd class="col-sm-7">{{ ticket.created_by.username if ticket.created_by else '-' }}</dd>
                        
                        {% if ticket.finalized_at %}
                        <dt class="col-sm-5">Finalized</dt>
                        <dd class="col-sm-7">{{ ticket.finalized_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                        {% endif %}
                        
                        {% if ticket.notes %}
                        <dt class="col-sm-5">Notes</dt>
                        <dd class="col-sm-7">{{ ticket.notes }}</dd>
                        {% endif %}
                    </dl>
                </div>
                {% if ticket.status == 'open' %}
                <div class="card-footer">
                    <a href="{{ url_for('ipt.scan_returns', ticket_id=ticket.id) }}" class="btn btn-primary w-100 mb-2">
                        <i class="fas fa-barcode me-2"></i>Continue Scanning
                    </a>
                    <div class="d-flex gap-2">
                        <form method="POST" action="{{ url_for('ipt.finalize_ticket', ticket_id=ticket.id) }}" class="flex-fill">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-success w-100" onclick="return confirm('Finalize this return ticket?')">
                                <i class="fas fa-check"></i> Finalize
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('ipt.cancel_ticket', ticket_id=ticket.id) }}" class="flex-fill">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-outline-danger w-100" onclick="return confirm('Cancel this ticket?')">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Returned Bags ({{ returned_bags | length }})</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Bag QR</th>
                                    <th>Original Bill</th>
                                    <th>Child Count</th>
                                    <th>Weight (kg)</th>
                                    <th>Scanned At</th>
                                    <th>Scanned By</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rtb in returned_bags %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('bag_details', qr_id=rtb.bag.qr_id|urlencode) if rtb.bag else '#' }}" class="fw-bold text-decoration-none">
                                            {{ rtb.bag.qr_id if rtb.bag else 'Unknown' }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if rtb.original_bill %}
                                        <a href="{{ url_for('view_bill', bill_id=rtb.original_bill.id) }}" class="text-decoration-none">
                                            {{ rtb.original_bill.bill_id }}
                                        </a>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ rtb.child_count_at_return }}</td>
                                    <td>{{ '%.1f' | format(rtb.weight_at_return_kg or 0) }}</td>
                                    <td>{{ rtb.scanned_at.strftime('%H:%M:%S') if rtb.scanned_at else '-' }}</td>
                                    <td>{{ rtb.scanned_by.username if rtb.scanned_by else '-' }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-muted">
                                        No bags have been returned in this ticket
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
