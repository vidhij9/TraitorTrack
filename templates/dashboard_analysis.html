{% extends "layout.html" %}

{% block title %}Analysis Dashboard - TraceTrack{% endblock %}

{% block head %}
<style>
    /* Tiny Box Grid System */
    .metric-box {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        transition: all 0.3s ease;
        height: 100%;
        min-height: 80px;
    }
    
    .metric-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .metric-value {
        font-size: 24px;
        font-weight: bold;
        margin: 0;
        line-height: 1.2;
    }
    
    .metric-label {
        font-size: 11px;
        color: #6c757d;
        margin-top: 2px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .metric-trend {
        font-size: 10px;
        margin-top: 4px;
    }
    
    .trend-up {
        color: #28a745;
    }
    
    .trend-down {
        color: #dc3545;
    }
    
    /* Color coding for different metrics */
    .box-primary { border-left: 4px solid #007bff; }
    .box-success { border-left: 4px solid #28a745; }
    .box-warning { border-left: 4px solid #ffc107; }
    .box-danger { border-left: 4px solid #dc3545; }
    .box-info { border-left: 4px solid #17a2b8; }
    .box-purple { border-left: 4px solid #6f42c1; }
    
    /* Responsive grid */
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }
    
    @media (max-width: 768px) {
        .metric-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    /* Section headers */
    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        margin-bottom: 10px;
        font-size: 14px;
        font-weight: 600;
    }
    
    /* Chart containers */
    .chart-box {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .quick-action-btn {
        padding: 8px 12px;
        font-size: 12px;
        margin: 2px;
    }
    
    /* Live indicator */
    .live-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #28a745;
        border-radius: 50%;
        animation: pulse 2s infinite;
        margin-right: 5px;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with Live Indicator -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">
            <span class="live-indicator"></span>
            <i class="fas fa-chart-line me-2"></i>Analysis Dashboard
        </h4>
        <div>
            <span class="badge bg-secondary me-2">{{ current_user.role|title }}</span>
            <span class="text-muted small" id="last-update">Loading...</span>
            <button class="btn btn-sm btn-outline-primary ms-2" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Admin Metrics Section -->
    {% if current_user.role == 'admin' %}
    <div class="section-header">
        <i class="fas fa-crown me-2"></i>System Overview
    </div>
    <div class="metric-grid mb-3">
        <div class="metric-box box-primary">
            <p class="metric-value" id="total-users">0</p>
            <p class="metric-label">Total Users</p>
            <p class="metric-trend trend-up" id="users-trend"></p>
        </div>
        <div class="metric-box box-success">
            <p class="metric-value" id="active-users">0</p>
            <p class="metric-label">Active Today</p>
        </div>
        <div class="metric-box box-warning">
            <p class="metric-value" id="pending-bills">0</p>
            <p class="metric-label">Pending Bills</p>
        </div>
        <div class="metric-box box-danger">
            <p class="metric-value" id="system-alerts">0</p>
            <p class="metric-label">Alerts</p>
        </div>
        <div class="metric-box box-info">
            <p class="metric-value" id="db-size">0MB</p>
            <p class="metric-label">Database Size</p>
        </div>
        <div class="metric-box box-purple">
            <p class="metric-value" id="uptime">0h</p>
            <p class="metric-label">Uptime</p>
        </div>
    </div>
    {% endif %}

    <!-- Operations Metrics (All Roles) -->
    <div class="section-header">
        <i class="fas fa-box me-2"></i>Operations Analytics
    </div>
    <div class="metric-grid mb-3">
        <div class="metric-box box-primary">
            <p class="metric-value" id="total-bags">0</p>
            <p class="metric-label">Total Bags</p>
            <p class="metric-trend" id="bags-trend"></p>
        </div>
        <div class="metric-box box-success">
            <p class="metric-value" id="parent-bags">0</p>
            <p class="metric-label">Parent Bags</p>
        </div>
        <div class="metric-box box-info">
            <p class="metric-value" id="child-bags">0</p>
            <p class="metric-label">Child Bags</p>
        </div>
        <div class="metric-box box-warning">
            <p class="metric-value" id="unlinked-children">0</p>
            <p class="metric-label">Unlinked</p>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="section-header">
        <i class="fas fa-tachometer-alt me-2"></i>Performance Metrics
    </div>
    <div class="metric-grid mb-3">
        <div class="metric-box box-success">
            <p class="metric-value" id="scans-today">0</p>
            <p class="metric-label">Scans Today</p>
        </div>
        <div class="metric-box box-primary">
            <p class="metric-value" id="avg-scan-time">0ms</p>
            <p class="metric-label">Avg Scan Time</p>
        </div>
        <div class="metric-box box-info">
            <p class="metric-value" id="hourly-rate">0/h</p>
            <p class="metric-label">Hourly Rate</p>
        </div>
        <div class="metric-box box-warning">
            <p class="metric-value" id="peak-hour">--</p>
            <p class="metric-label">Peak Hour</p>
        </div>
    </div>

    <!-- Biller Specific Metrics -->
    {% if current_user.role in ['admin', 'biller'] %}
    <div class="section-header">
        <i class="fas fa-file-invoice me-2"></i>Billing Analytics
    </div>
    <div class="metric-grid mb-3">
        <div class="metric-box box-primary">
            <p class="metric-value" id="total-bills">0</p>
            <p class="metric-label">Total Bills</p>
        </div>
        <div class="metric-box box-success">
            <p class="metric-value" id="completed-bills">0</p>
            <p class="metric-label">Completed</p>
        </div>
        <div class="metric-box box-warning">
            <p class="metric-value" id="in-progress-bills">0</p>
            <p class="metric-label">In Progress</p>
        </div>
        <div class="metric-box box-info">
            <p class="metric-value" id="avg-bags-per-bill">0</p>
            <p class="metric-label">Avg Bags/Bill</p>
        </div>
        <div class="metric-box box-purple">
            <p class="metric-value" id="monthly-bills">0</p>
            <p class="metric-label">This Month</p>
        </div>
        <div class="metric-box box-danger">
            <p class="metric-value" id="overdue-bills">0</p>
            <p class="metric-label">Overdue</p>
        </div>
    </div>
    {% endif %}

    <!-- Dispatcher Specific Metrics -->
    {% if current_user.role in ['admin', 'dispatcher'] %}
    <div class="section-header">
        <i class="fas fa-truck me-2"></i>Dispatch Analytics
    </div>
    <div class="metric-grid mb-3">
        <div class="metric-box box-primary">
            <p class="metric-value" id="dispatch-areas">0</p>
            <p class="metric-label">Active Areas</p>
        </div>
        <div class="metric-box box-success">
            <p class="metric-value" id="dispatched-today">0</p>
            <p class="metric-label">Dispatched Today</p>
        </div>
        <div class="metric-box box-warning">
            <p class="metric-value" id="pending-dispatch">0</p>
            <p class="metric-label">Pending</p>
        </div>
        <div class="metric-box box-info">
            <p class="metric-value" id="avg-dispatch-time">0h</p>
            <p class="metric-label">Avg Time</p>
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions Row -->
    <div class="section-header">
        <i class="fas fa-bolt me-2"></i>Quick Actions
    </div>
    <div class="d-flex flex-wrap mb-3">
        <a href="{{ url_for('scan_parent') }}" class="btn btn-primary quick-action-btn">
            <i class="fas fa-qrcode me-1"></i>Scan Parent
        </a>
        <a href="{{ url_for('scan_child') }}" class="btn btn-success quick-action-btn">
            <i class="fas fa-qrcode me-1"></i>Scan Child
        </a>
        <a href="{{ url_for('bill_management') }}" class="btn btn-warning quick-action-btn">
            <i class="fas fa-file-invoice me-1"></i>Bills
        </a>
        <a href="{{ url_for('bag_management') }}" class="btn btn-info quick-action-btn">
            <i class="fas fa-box me-1"></i>Bags
        </a>
        {% if current_user.role == 'admin' %}
        <a href="{{ url_for('user_management') }}" class="btn btn-secondary quick-action-btn">
            <i class="fas fa-users me-1"></i>Users
        </a>
        <button onclick="refreshDashboard()" class="btn btn-purple quick-action-btn">
            <i class="fas fa-chart-bar me-1"></i>Refresh
        </button>
        {% endif %}
    </div>

    <!-- Activity Charts Row -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-box">
                <h6 class="mb-3">
                    <i class="fas fa-chart-area me-2"></i>Hourly Activity
                </h6>
                <canvas id="hourly-chart" height="100"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-box">
                <h6 class="mb-3">
                    <i class="fas fa-chart-pie me-2"></i>Bag Distribution
                </h6>
                <canvas id="distribution-chart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Activity Table -->
    <div class="chart-box">
        <h6 class="mb-3">
            <i class="fas fa-history me-2"></i>Recent Activity
        </h6>
        <div class="table-responsive">
            <table class="table table-sm table-hover" style="font-size: 12px;">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Action</th>
                        <th>User</th>
                        <th>Details</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="activity-table">
                    <tr>
                        <td colspan="5" class="text-center">Loading activity...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables for charts
let hourlyChart = null;
let distributionChart = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    refreshDashboard();
    
    // Auto-refresh every 30 seconds
    setInterval(refreshDashboard, 30000);
});

// Initialize charts
function initCharts() {
    // Hourly Activity Chart
    const hourlyCtx = document.getElementById('hourly-chart').getContext('2d');
    hourlyChart = new Chart(hourlyCtx, {
        type: 'line',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
                label: 'Scans',
                data: new Array(24).fill(0),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
    
    // Distribution Chart
    const distCtx = document.getElementById('distribution-chart').getContext('2d');
    distributionChart = new Chart(distCtx, {
        type: 'doughnut',
        data: {
            labels: ['Parent Bags', 'Linked Children', 'Unlinked Children'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 206, 86, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { font: { size: 10 } }
                }
            }
        }
    });
}

// Refresh dashboard data
async function refreshDashboard() {
    try {
        // Fetch analytics data
        const response = await fetch('/api/dashboard/analytics');
        const data = await response.json();
        
        if (data.success) {
            updateMetrics(data);
            updateCharts(data);
            updateActivityTable(data.recent_activity || []);
            
            // Update last refresh time
            document.getElementById('last-update').textContent = 
                'Updated: ' + new Date().toLocaleTimeString();
        }
    } catch (error) {
        console.error('Error refreshing dashboard:', error);
    }
}

// Update metric boxes
function updateMetrics(data) {
    // Update each metric with animation
    const metrics = {
        // System metrics
        'total-users': data.total_users,
        'active-users': data.active_users_today,
        'pending-bills': data.pending_bills,
        'system-alerts': data.system_alerts || 0,
        'db-size': (data.database_size_mb || 0) + 'MB',
        'uptime': formatUptime(data.uptime_hours || 0),
        
        // Operations metrics
        'total-bags': data.total_bags,
        'parent-bags': data.parent_bags,
        'child-bags': data.child_bags,
        'unlinked-children': data.unlinked_children,
        
        // Performance metrics
        'scans-today': data.scans_today,
        'avg-scan-time': (data.avg_scan_time_ms || 0) + 'ms',
        'hourly-rate': data.hourly_rate + '/h',
        'peak-hour': data.peak_hour || '--',
        
        // Billing metrics
        'total-bills': data.total_bills,
        'completed-bills': data.completed_bills,
        'in-progress-bills': data.in_progress_bills,
        'avg-bags-per-bill': data.avg_bags_per_bill || 0,
        'monthly-bills': data.monthly_bills,
        'overdue-bills': data.overdue_bills || 0,
        
        // Dispatch metrics
        'dispatch-areas': data.dispatch_areas || 0,
        'dispatched-today': data.dispatched_today || 0,
        'pending-dispatch': data.pending_dispatch || 0,
        'avg-dispatch-time': formatTime(data.avg_dispatch_time_hours || 0)
    };
    
    // Update each metric with animation
    for (const [id, value] of Object.entries(metrics)) {
        const element = document.getElementById(id);
        if (element) {
            animateValue(element, element.textContent, value);
        }
    }
    
    // Update trends
    updateTrends(data);
}

// Animate metric value changes
function animateValue(element, start, end) {
    // For non-numeric values, just update
    if (typeof end === 'string' && isNaN(parseFloat(end))) {
        element.textContent = end;
        return;
    }
    
    // Animate numeric values
    const startNum = parseFloat(start) || 0;
    const endNum = parseFloat(end) || 0;
    const duration = 500;
    const startTime = performance.now();
    
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const current = startNum + (endNum - startNum) * progress;
        
        element.textContent = Math.round(current);
        
        if (progress < 1) {
            requestAnimationFrame(update);
        } else {
            element.textContent = end;
        }
    }
    
    requestAnimationFrame(update);
}

// Update trend indicators
function updateTrends(data) {
    // Bags trend
    const bagsTrend = document.getElementById('bags-trend');
    if (bagsTrend && data.bags_growth_percentage !== undefined) {
        const growth = data.bags_growth_percentage;
        bagsTrend.innerHTML = growth > 0 
            ? `<i class="fas fa-arrow-up"></i> ${growth}%`
            : growth < 0 
            ? `<i class="fas fa-arrow-down"></i> ${Math.abs(growth)}%`
            : `<i class="fas fa-minus"></i> 0%`;
        bagsTrend.className = growth > 0 ? 'metric-trend trend-up' : 
                             growth < 0 ? 'metric-trend trend-down' : 'metric-trend';
    }
    
    // Users trend
    const usersTrend = document.getElementById('users-trend');
    if (usersTrend && data.users_growth !== undefined) {
        usersTrend.innerHTML = data.users_growth > 0 
            ? `+${data.users_growth} this week`
            : 'No change';
        usersTrend.className = data.users_growth > 0 ? 'metric-trend trend-up' : 'metric-trend';
    }
}

// Update charts
function updateCharts(data) {
    // Update hourly chart
    if (hourlyChart && data.hourly_scans) {
        hourlyChart.data.datasets[0].data = data.hourly_scans;
        hourlyChart.update();
    }
    
    // Update distribution chart
    if (distributionChart && data.bag_distribution) {
        distributionChart.data.datasets[0].data = [
            data.bag_distribution.parent || 0,
            data.bag_distribution.linked_children || 0,
            data.bag_distribution.unlinked_children || 0
        ];
        distributionChart.update();
    }
}

// Update activity table
function updateActivityTable(activities) {
    const tbody = document.getElementById('activity-table');
    
    if (!activities || activities.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No recent activity</td></tr>';
        return;
    }
    
    tbody.innerHTML = activities.slice(0, 10).map(activity => `
        <tr>
            <td>${formatTimeAgo(activity.timestamp)}</td>
            <td>${activity.action}</td>
            <td>${activity.user}</td>
            <td>${activity.details}</td>
            <td>
                <span class="badge bg-${getStatusColor(activity.status)}">
                    ${activity.status}
                </span>
            </td>
        </tr>
    `).join('');
}

// Utility functions
function formatUptime(hours) {
    if (hours < 24) return hours + 'h';
    const days = Math.floor(hours / 24);
    return days + 'd ' + (hours % 24) + 'h';
}

function formatTime(hours) {
    if (hours < 1) return Math.round(hours * 60) + 'm';
    return hours.toFixed(1) + 'h';
}

function formatTimeAgo(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    
    const minutes = Math.floor(diff / 60000);
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return minutes + 'm ago';
    
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + 'h ago';
    
    return date.toLocaleDateString();
}

function getStatusColor(status) {
    const colors = {
        'success': 'success',
        'completed': 'success',
        'pending': 'warning',
        'failed': 'danger',
        'in_progress': 'info'
    };
    return colors[status.toLowerCase()] || 'secondary';
}
</script>
{% endblock %}