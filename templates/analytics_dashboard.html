{% extends "layout.html" %}

{% block title %}Analytics Dashboard - TraceTrack{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .analytics-container {
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: relative;
    }
    
    .metric-card.alert {
        border-left: 4px solid #dc3545;
    }
    
    .metric-card.warning {
        border-left: 4px solid #ffc107;
    }
    
    .metric-card.healthy {
        border-left: 4px solid #28a745;
    }
    
    .metric-value {
        font-size: 2em;
        font-weight: bold;
        color: #333;
        margin: 10px 0;
    }
    
    .metric-label {
        color: #666;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .metric-change {
        font-size: 0.85em;
        margin-top: 5px;
    }
    
    .metric-change.positive {
        color: #28a745;
    }
    
    .metric-change.negative {
        color: #dc3545;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-title {
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
    }
    
    .alerts-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        max-height: 400px;
        overflow-y: auto;
    }
    
    .alert-item {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .alert-critical {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
    }
    
    .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffeeba;
    }
    
    .alert-info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
    }
    
    .system-health {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .health-indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    .health-indicator.healthy {
        background: #28a745;
    }
    
    .health-indicator.degraded {
        background: #ffc107;
    }
    
    .health-indicator.critical {
        background: #dc3545;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .table-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow-x: auto;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    
    .data-table td {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .refresh-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        z-index: 1000;
    }
    
    .refresh-btn:hover {
        background: #0056b3;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <h1>Enterprise Analytics Dashboard</h1>
    
    <!-- System Health Indicator -->
    <div class="system-health">
        <div class="health-indicator {{ analytics.real_time.system_health }}"></div>
        <div>
            <strong>System Health: </strong>
            <span style="text-transform: uppercase;">{{ analytics.real_time.system_health }}</span>
        </div>
        <div style="margin-left: auto;">
            <strong>Active Users:</strong> {{ analytics.real_time.active_users }} |
            <strong>Requests/min:</strong> {{ analytics.real_time.current_rpm }}
        </div>
    </div>
    
    <!-- Key Metrics Grid -->
    <div class="metrics-grid">
        <div class="metric-card healthy">
            <div class="metric-label">Total Bags</div>
            <div class="metric-value">{{ "{:,.0f}".format(business_metrics.total_bags) }}</div>
            <div class="metric-change positive">↑ 5.2% from yesterday</div>
        </div>
        
        <div class="metric-card healthy">
            <div class="metric-label">Active Users</div>
            <div class="metric-value">{{ analytics.real_time.active_users }}</div>
            <div class="metric-change">Online now</div>
        </div>
        
        <div class="metric-card {% if system_metrics.system.cpu_percent > 80 %}alert{% else %}healthy{% endif %}">
            <div class="metric-label">CPU Usage</div>
            <div class="metric-value">{{ "%.1f"|format(system_metrics.system.cpu_percent) }}%</div>
            <div class="metric-change">{{ system_metrics.system.cpu_percent|round|int }} cores active</div>
        </div>
        
        <div class="metric-card {% if system_metrics.system.memory_percent > 85 %}alert{% else %}healthy{% endif %}">
            <div class="metric-label">Memory Usage</div>
            <div class="metric-value">{{ "%.1f"|format(system_metrics.system.memory_percent) }}%</div>
            <div class="metric-change">{{ "%.1f"|format(system_metrics.system.memory_used_gb) }}GB / {{ "%.1f"|format(system_metrics.system.memory_total_gb) }}GB</div>
        </div>
        
        <div class="metric-card healthy">
            <div class="metric-label">Database Connections</div>
            <div class="metric-value">{{ db_health.active_connections|default(0) }}</div>
            <div class="metric-change">Pool: 250 max</div>
        </div>
        
        <div class="metric-card healthy">
            <div class="metric-label">Cache Hit Rate</div>
            <div class="metric-value">{{ "%.1f"|format(cache_stats.hit_rate) }}%</div>
            <div class="metric-change positive">{{ cache_stats.hits }} hits</div>
        </div>
        
        <div class="metric-card healthy">
            <div class="metric-label">Today's Scans</div>
            <div class="metric-value">{{ "{:,.0f}".format(business_metrics.today_scans) }}</div>
            <div class="metric-change">{{ analytics.today.avg_response_time|default(0)|round(2) }}s avg</div>
        </div>
        
        <div class="metric-card {% if system_metrics.application.error_rate > 5 %}alert{% elif system_metrics.application.error_rate > 2 %}warning{% else %}healthy{% endif %}">
            <div class="metric-label">Error Rate</div>
            <div class="metric-value">{{ "%.2f"|format(system_metrics.application.error_rate|default(0)) }}%</div>
            <div class="metric-change {% if system_metrics.application.error_rate > 5 %}negative{% else %}positive{% endif %}">
                Last 100 requests
            </div>
        </div>
    </div>
    
    <!-- Performance Charts -->
    <div class="charts-grid">
        <div class="chart-container">
            <div class="chart-title">Response Time Trend (Last Hour)</div>
            <canvas id="responseTimeChart"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Requests Per Minute</div>
            <canvas id="rpmChart"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Database Query Performance</div>
            <canvas id="dbChart"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Error Rate Trend</div>
            <canvas id="errorChart"></canvas>
        </div>
    </div>
    
    <!-- Detailed Metrics Tables -->
    <div class="table-container" style="margin-bottom: 20px;">
        <h3>Top Users by Activity</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Scans</th>
                    <th>Avg Time</th>
                </tr>
            </thead>
            <tbody id="userActivityTable">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>
    </div>
    
    <!-- Recent Alerts -->
    <div class="alerts-container">
        <h3>Recent Alerts</h3>
        <div id="alertsList">
            {% for alert in analytics.alerts[-10:] %}
            <div class="alert-item alert-{{ alert.severity }}">
                <div>
                    <strong>{{ alert.type|replace('_', ' ')|title }}:</strong>
                    {{ alert.details }}
                </div>
                <small>{{ alert.timestamp }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Refresh Button -->
    <button class="refresh-btn" onclick="refreshDashboard()">↻</button>
</div>

<script>
// Initialize charts
let responseTimeChart, rpmChart, dbChart, errorChart;

function initCharts() {
    // Response Time Chart
    const rtCtx = document.getElementById('responseTimeChart').getContext('2d');
    responseTimeChart = new Chart(rtCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Response Time (s)',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // RPM Chart
    const rpmCtx = document.getElementById('rpmChart').getContext('2d');
    rpmChart = new Chart(rpmCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Requests/min',
                data: [],
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Database Chart
    const dbCtx = document.getElementById('dbChart').getContext('2d');
    dbChart = new Chart(dbCtx, {
        type: 'bar',
        data: {
            labels: ['Active Queries', 'Waiting', 'Idle', 'Total Connections'],
            datasets: [{
                label: 'Count',
                data: [
                    {{ db_health.active_queries|default(0) }},
                    {{ db_health.waiting_queries|default(0) }},
                    {{ (db_health.active_connections|default(0) - db_health.active_queries|default(0)) }},
                    {{ db_health.active_connections|default(0) }}
                ],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(54, 162, 235, 0.5)'
                ]
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Error Rate Chart
    const errorCtx = document.getElementById('errorChart').getContext('2d');
    errorChart = new Chart(errorCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Error Rate (%)',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 10
                }
            }
        }
    });
}

// Update charts with real-time data
function updateCharts(data) {
    if (data.performance_trends) {
        // Update response time chart
        if (data.performance_trends.response_times) {
            responseTimeChart.data.labels = data.performance_trends.response_times.map(d => 
                new Date(d.time).toLocaleTimeString()
            );
            responseTimeChart.data.datasets[0].data = data.performance_trends.response_times.map(d => d.value);
            responseTimeChart.update();
        }
        
        // Update RPM chart
        if (data.performance_trends.rpm) {
            rpmChart.data.labels = data.performance_trends.rpm.map(d => 
                new Date(d.time).toLocaleTimeString()
            );
            rpmChart.data.datasets[0].data = data.performance_trends.rpm.map(d => d.value);
            rpmChart.update();
        }
        
        // Update error rate chart
        if (data.performance_trends.error_rates) {
            errorChart.data.labels = data.performance_trends.error_rates.map(d => 
                new Date(d.time).toLocaleTimeString()
            );
            errorChart.data.datasets[0].data = data.performance_trends.error_rates.map(d => d.value);
            errorChart.update();
        }
    }
}

// Refresh dashboard data
async function refreshDashboard() {
    try {
        const response = await fetch('/analytics/api/metrics/realtime');
        const data = await response.json();
        
        // Update metrics
        updateMetrics(data);
        
        // Update charts
        updateCharts(data);
        
        // Update alerts
        updateAlerts(data.alerts);
        
    } catch (error) {
        console.error('Failed to refresh dashboard:', error);
    }
}

function updateMetrics(data) {
    // Update metric cards with new data
    // This would update the DOM elements with new values
}

function updateAlerts(alerts) {
    const alertsList = document.getElementById('alertsList');
    alertsList.innerHTML = '';
    
    alerts.forEach(alert => {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert-item alert-${alert.severity}`;
        alertDiv.innerHTML = `
            <div>
                <strong>${alert.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong>
                ${JSON.stringify(alert.details)}
            </div>
            <small>${new Date(alert.timestamp).toLocaleString()}</small>
        `;
        alertsList.appendChild(alertDiv);
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    
    // Auto-refresh every 30 seconds
    setInterval(refreshDashboard, 30000);
    
    // Initial data load
    refreshDashboard();
});
</script>
{% endblock %}