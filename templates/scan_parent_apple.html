{% extends "layout.html" %}

{% block title %}Scan Parent Bag - TraceTrack{% endblock %}

{% block head %}
<!-- Load QR Scanner Library -->
<script src="{{ url_for('static', filename='js/jsQR.js') }}"></script>

<style>
/* Reset and base styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: #000;
    overflow: hidden;
    position: relative;
}

/* Full screen scanner container */
.scanner-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100vh;
    background: #000;
    display: flex;
    flex-direction: column;
}

/* Header */
.scanner-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10;
    padding: 20px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
}

.scanner-title {
    color: white;
    text-align: center;
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
}

/* Video container */
.video-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
}

#video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

#canvas {
    display: none;
}

/* Scanner overlay */
.scanner-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
}

/* Viewfinder frame */
.viewfinder {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 250px;
    height: 250px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
}

/* Corner brackets */
.corner {
    position: absolute;
    width: 40px;
    height: 40px;
    border: 3px solid #FFD60A;
}

.corner.tl {
    top: -2px;
    left: -2px;
    border-right: none;
    border-bottom: none;
    border-top-left-radius: 10px;
}

.corner.tr {
    top: -2px;
    right: -2px;
    border-left: none;
    border-bottom: none;
    border-top-right-radius: 10px;
}

.corner.bl {
    bottom: -2px;
    left: -2px;
    border-right: none;
    border-top: none;
    border-bottom-left-radius: 10px;
}

.corner.br {
    bottom: -2px;
    right: -2px;
    border-left: none;
    border-top: none;
    border-bottom-right-radius: 10px;
}

/* Scanning animation */
.scan-line {
    position: absolute;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #FFD60A, transparent);
    animation: scan 2s linear infinite;
}

@keyframes scan {
    0% { top: 0; }
    100% { top: 100%; }
}

/* Status message */
.status-message {
    position: absolute;
    top: 100px;
    left: 50%;
    transform: translateX(-50%);
    padding: 10px 20px;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    color: white;
    font-size: 14px;
    z-index: 15;
}

.status-message.success {
    background: rgba(40, 167, 69, 0.9);
}

.status-message.error {
    background: rgba(220, 53, 69, 0.9);
}

/* Control buttons */
.controls {
    position: absolute;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 30px;
    z-index: 20;
}

.control-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(20px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 24px;
}

.control-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.control-btn.active {
    background: #FFD60A;
    color: #000;
    border-color: #FFD60A;
}

/* Back button */
.back-btn {
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 20;
    color: white;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 10px 20px;
    border-radius: 20px;
    text-decoration: none;
    transition: all 0.3s;
}

.back-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

/* Hide default container */
.container {
    display: none;
}
</style>
{% endblock %}

{% block content %}
<div class="scanner-container">
    <!-- Back button -->
    <a href="{{ url_for('dashboard') }}" class="back-btn">
        <i class="fas fa-arrow-left"></i> Back
    </a>
    
    <!-- Header -->
    <div class="scanner-header">
        <div class="scanner-title">Scan Parent Bag</div>
        <div class="status-message" id="status">Initializing camera...</div>
    </div>
    
    <!-- Video container -->
    <div class="video-container">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
        
        <!-- Scanner overlay -->
        <div class="scanner-overlay">
            <div class="viewfinder">
                <div class="corner tl"></div>
                <div class="corner tr"></div>
                <div class="corner bl"></div>
                <div class="corner br"></div>
                <div class="scan-line"></div>
            </div>
        </div>
    </div>
    
    <!-- Controls -->
    <div class="controls">
        <button class="control-btn" id="torch-btn" title="Toggle Flashlight">
            <i class="fas fa-bolt"></i>
        </button>
        <button class="control-btn" id="manual-btn" title="Enter Manually">
            <i class="fas fa-keyboard"></i>
        </button>
    </div>
</div>

<!-- Hidden form for submission -->
<form method="POST" action="{{ url_for('process_parent_scan') }}" id="scan-form" style="display: none;">
    <input type="hidden" name="qr_code" id="qr-input">
</form>
{% endblock %}

{% block scripts %}
<script>
// Apple-style QR Scanner
class AppleQRScanner {
    constructor() {
        this.video = document.getElementById('video');
        this.canvas = document.getElementById('canvas');
        this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });
        this.status = document.getElementById('status');
        this.torchBtn = document.getElementById('torch-btn');
        this.manualBtn = document.getElementById('manual-btn');
        
        this.scanning = false;
        this.stream = null;
        this.videoTrack = null;
        this.torchEnabled = false;
        this.lastScan = '';
        this.lastScanTime = 0;
        
        this.init();
    }
    
    async init() {
        console.log('Initializing Apple QR Scanner...');
        await this.startCamera();
        this.setupEventListeners();
    }
    
    async startCamera() {
        try {
            this.setStatus('Requesting camera access...', 'info');
            
            // Check for camera API support
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('Camera API not supported on this device');
            }
            
            // Try to get rear camera first, then any camera
            const constraints = [
                { video: { facingMode: 'environment' } },
                { video: { facingMode: { exact: 'environment' } } },
                { video: true }
            ];
            
            let stream = null;
            for (const constraint of constraints) {
                try {
                    console.log('Trying constraint:', constraint);
                    stream = await navigator.mediaDevices.getUserMedia(constraint);
                    console.log('Got stream with constraint:', constraint);
                    break;
                } catch (err) {
                    console.warn('Constraint failed:', err.message);
                }
            }
            
            if (!stream) {
                throw new Error('Could not access any camera');
            }
            
            this.stream = stream;
            this.video.srcObject = stream;
            this.videoTrack = stream.getVideoTracks()[0];
            
            // Check for torch support
            if (this.videoTrack && this.videoTrack.getCapabilities) {
                const capabilities = this.videoTrack.getCapabilities();
                if (capabilities.torch) {
                    this.torchBtn.style.display = 'flex';
                    console.log('Torch is available');
                } else {
                    this.torchBtn.style.display = 'none';
                }
            }
            
            // Wait for video to be ready
            this.video.onloadedmetadata = () => {
                console.log(`Video ready: ${this.video.videoWidth}x${this.video.videoHeight}`);
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                this.video.play();
                this.scanning = true;
                this.setStatus('Point at QR code', 'success');
                this.startScanning();
            };
            
        } catch (err) {
            console.error('Camera error:', err);
            this.handleCameraError(err);
        }
    }
    
    handleCameraError(err) {
        if (err.name === 'NotAllowedError') {
            this.setStatus('Camera permission denied. Please allow and refresh.', 'error');
        } else if (err.name === 'NotFoundError') {
            this.setStatus('No camera found on this device.', 'error');
        } else if (err.name === 'NotReadableError') {
            this.setStatus('Camera is in use by another app.', 'error');
        } else {
            this.setStatus(`Camera error: ${err.message}`, 'error');
        }
    }
    
    startScanning() {
        const scan = () => {
            if (!this.scanning) return;
            
            if (this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
                // Draw video frame to canvas
                this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                
                // Get image data
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                
                // Try to detect QR code
                if (typeof jsQR !== 'undefined') {
                    // Try multiple detection methods
                    let code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: 'attemptBoth'
                    });
                    
                    if (!code) {
                        code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: 'dontInvert'
                        });
                    }
                    
                    if (code && code.data) {
                        this.handleQRCode(code.data);
                    }
                }
            }
            
            // Continue scanning
            requestAnimationFrame(scan);
        };
        
        scan();
    }
    
    handleQRCode(data) {
        const now = Date.now();
        
        // Prevent duplicate scans
        if (data === this.lastScan && (now - this.lastScanTime) < 2000) {
            return;
        }
        
        console.log('QR Code detected:', data);
        
        this.lastScan = data;
        this.lastScanTime = now;
        
        // Stop scanning
        this.scanning = false;
        
        // Feedback
        this.playBeep();
        if (navigator.vibrate) {
            navigator.vibrate(100);
        }
        
        // Update status
        this.setStatus('QR Code detected! Processing...', 'success');
        
        // Submit form
        document.getElementById('qr-input').value = data;
        setTimeout(() => {
            document.getElementById('scan-form').submit();
        }, 500);
    }
    
    playBeep() {
        try {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(context.destination);
            
            oscillator.frequency.value = 1000;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, context.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.1);
            
            oscillator.start(context.currentTime);
            oscillator.stop(context.currentTime + 0.1);
        } catch (err) {
            console.log('Audio feedback not available');
        }
    }
    
    async toggleTorch() {
        if (!this.videoTrack) return;
        
        try {
            this.torchEnabled = !this.torchEnabled;
            await this.videoTrack.applyConstraints({
                advanced: [{ torch: this.torchEnabled }]
            });
            
            if (this.torchEnabled) {
                this.torchBtn.classList.add('active');
            } else {
                this.torchBtn.classList.remove('active');
            }
            
            console.log('Torch toggled:', this.torchEnabled);
        } catch (err) {
            console.error('Torch error:', err);
        }
    }
    
    setupEventListeners() {
        // Torch button
        this.torchBtn.addEventListener('click', () => {
            this.toggleTorch();
        });
        
        // Manual entry button
        this.manualBtn.addEventListener('click', () => {
            const code = prompt('Enter QR code manually:');
            if (code && code.trim()) {
                this.handleQRCode(code.trim());
            }
        });
    }
    
    setStatus(message, type = 'info') {
        this.status.textContent = message;
        this.status.className = 'status-message';
        if (type === 'success') {
            this.status.classList.add('success');
        } else if (type === 'error') {
            this.status.classList.add('error');
        }
    }
}

// Initialize scanner when page loads
document.addEventListener('DOMContentLoaded', () => {
    if (typeof jsQR === 'undefined') {
        console.error('jsQR library not loaded!');
        document.getElementById('status').textContent = 'Scanner library not loaded';
        document.getElementById('status').classList.add('error');
        return;
    }
    
    // Start the Apple-style scanner
    new AppleQRScanner();
});
</script>
{% endblock %}